# Salesforce数据集成模块需求文档

## 1. 模块概述
本模块旨在构建一个企业级Salesforce数据集成解决方案，实现从Salesforce平台高效拉取数据并安全存储到本地数据库的完整流程，支持Salesforce数据的本地化管理、定时同步与实时监控，确保数据一致性与可用性。

## 2. 核心功能需求

### 2.1 元数据拉取与表结构创建

#### 2.1.1 元数据获取
- **功能描述**：通过Salesforce API获取标准对象与自定义对象的完整元数据信息
- **详细要求**：
  - 获取对象的基本信息（名称、标签、描述、是否自定义等）
  - 获取字段的详细信息（名称、标签、数据类型、长度、精度、小数位数等）
  - 获取字段约束条件（是否必填、是否唯一、默认值等）
  - 获取关系信息（主外键关系、查找关系等）
  - 获取选择列表值信息
  - 支持增量获取元数据变更
- **验收标准**：
  - 能够成功获取所有Salesforce对象的元数据
  - 元数据信息完整，包含所有必要字段
  - 支持元数据变更检测

#### 2.1.2 表结构自动创建
- **功能描述**：根据获取的元数据自动在本地数据库生成对应的数据表结构
- **详细要求**：
  - 支持标准对象与自定义对象的表结构创建
  - 字段类型、长度、精度、约束与Salesforce保持一致
  - 支持普通表与分区表的自动创建
  - 支持表结构的自动更新
- **验收标准**：
  - 表结构与Salesforce元数据保持一致
  - 支持大数据量对象的分区表创建
  - 表结构更新不影响现有数据

#### 2.1.3 元数据存储
- **功能描述**：将对象元数据信息规范化后写入本地数据库的元数据表
- **详细要求**：
  - 将对象信息写入object表
  - 将字段信息写入field表
  - 将选择列表值写入picklist表
  - 支持元数据的版本管理
- **验收标准**：
  - 元数据完整存储到对应表中
  - 支持元数据的查询与检索
  - 支持元数据版本管理

### 2.2 数据拉取批次管理

#### 2.2.1 批次管理机制
- **功能描述**：设计并实现按批次拉取Salesforce对象数据的高效机制
- **详细要求**：
  - 支持自定义批次大小配置
  - 支持批次的创建、查询、更新、删除操作
  - 支持批次状态的管理（待执行、执行中、已完成、失败等）
- **验收标准**：
  - 能够创建和管理拉取批次
  - 支持自定义批次大小
  - 批次状态准确反映实际执行情况

#### 2.2.2 批次信息存储
- **功能描述**：在本地数据库创建专用批次管理表，记录批次信息
- **详细要求**：
  - 记录批次ID、拉取时间、数据量、状态等信息
  - 支持批次历史记录查询
  - 支持批次统计分析
- **验收标准**：
  - 批次信息完整存储到数据库
  - 支持批次历史记录查询
  - 支持批次统计分析

#### 2.2.3 智能拉取策略
- **功能描述**：根据对象是否包含时间字段采用不同拉取策略
- **详细要求**：
  - 包含时间字段的对象：基于指定时间字段实现增量拉取
  - 不包含时间字段的对象：执行全量拉取
  - 支持自定义时间字段配置
  - 支持拉取策略的动态调整
- **验收标准**：
  - 正确识别对象是否包含时间字段
  - 增量拉取仅获取变更数据
  - 全量拉取覆盖所有数据

### 2.3 数据拉取策略

#### 2.3.1 差异化拉取机制
- **功能描述**：实现存量数据初始化与增量数据同步的差异化拉取
- **详细要求**：
  - 首次同步执行全量初始化
  - 后续同步执行增量更新
  - 支持初始化与增量同步的无缝衔接
  - 支持手动触发全量同步
- **验收标准**：
  - 首次同步完整拉取所有数据
  - 后续同步仅拉取变更数据
  - 支持手动触发全量同步

#### 2.3.2 完整数据拉取
- **功能描述**：确保完整拉取Salesforce对象的所有记录
- **详细要求**：
  - 支持分页拉取，处理大数据量场景
  - 支持主对象与关联对象数据的拉取
  - 支持跨对象数据关联
  - 支持数据的完整性校验
- **验收标准**：
  - 能够拉取所有Salesforce对象记录
  - 支持大数据量对象的拉取
  - 数据完整性校验通过

#### 2.3.3 断点续传与失败重试
- **功能描述**：设计并实现断点续传机制与失败重试策略
- **详细要求**：
  - 支持从上次失败位置继续拉取
  - 实现失败重试策略，包含指数退避机制
  - 支持重试次数与重试间隔配置
  - 支持失败告警
- **验收标准**：
  - 中断后能够从上次位置继续拉取
  - 失败后自动重试
  - 支持失败告警

#### 2.3.4 数据冲突与重复处理
- **功能描述**：实现数据冲突解决策略与重复数据检测机制
- **详细要求**：
  - 实现数据冲突解决策略（如：Salesforce数据优先、本地数据优先、手动处理等）
  - 建立重复数据检测与去重机制
  - 支持数据唯一性校验
  - 支持冲突数据的记录与查询
- **验收标准**：
  - 能够正确处理数据冲突
  - 重复数据能够被检测和去重
  - 支持冲突数据查询

### 2.4 定时任务管理

#### 2.4.1 定时任务创建
- **功能描述**：基于datai-quartz组件创建定时任务，实现Salesforce数据的定期自动拉取
- **详细要求**：
  - 支持按对象配置定时任务
  - 支持自定义 cron 表达式
  - 支持任务的优先级配置
  - 支持任务的依赖配置
- **验收标准**：
  - 能够成功创建定时任务
  - 任务按配置的时间自动执行
  - 支持任务优先级与依赖配置

#### 2.4.2 定时任务管理
- **功能描述**：支持定时任务的配置、启动、暂停和删除操作
- **详细要求**：
  - 支持任务的启动、暂停、删除操作
  - 支持任务配置的修改
  - 支持任务执行日志的查询
  - 支持任务执行状态的监控
- **验收标准**：
  - 能够成功管理定时任务
  - 任务状态准确反映实际执行情况
  - 支持任务执行日志查询

### 2.5 数据拉取监控

#### 2.5.1 监控仪表盘
- **功能描述**：开发数据同步监控仪表盘，实时展示各对象同步状态
- **详细要求**：
  - 展示各对象的同步状态（待执行、执行中、已完成、失败等）
  - 展示同步进度、成功率与失败率
  - 支持按对象、时间范围筛选
  - 支持图表展示
- **验收标准**：
  - 监控仪表盘能够实时展示同步状态
  - 支持多种筛选条件
  - 支持图表可视化展示

#### 2.5.2 异常告警机制
- **功能描述**：实现同步异常告警机制
- **详细要求**：
  - 支持邮件告警
  - 支持短信告警
  - 支持系统内通知
  - 支持告警规则配置
- **验收标准**：
  - 同步异常时能够触发告警
  - 支持多种告警方式
  - 支持告警规则配置

#### 2.5.3 同步日志记录
- **功能描述**：记录详细的同步日志
- **详细要求**：
  - 记录成功记录数、失败记录数、错误原因等
  - 支持日志的查询与导出
  - 支持日志的归档与清理
  - 支持日志级别配置
- **验收标准**：
  - 同步日志记录完整
  - 支持日志查询与导出
  - 支持日志归档与清理

#### 2.5.4 统计分析功能
- **功能描述**：提供数据同步统计分析功能
- **详细要求**：
  - 统计同步频率
  - 分析数据增量趋势
  - 生成同步报告
  - 支持图表展示
- **验收标准**：
  - 能够生成同步统计分析报告
  - 支持多种统计维度
  - 支持图表可视化展示

## 3. 非功能需求

### 3.1 性能要求
- **响应时间**：元数据拉取响应时间 < 10秒
- **数据拉取速度**：支持每秒拉取至少1000条记录
- **并发处理**：支持至少10个对象的并发同步
- **批次处理**：支持批量处理，批次大小可配置

### 3.2 可靠性要求
- **数据完整性**：数据拉取成功率 > 99.9%
- **系统可用性**：系统可用性 > 99.5%
- **故障恢复**：支持断点续传，故障恢复时间 < 5分钟
- **数据一致性**：本地数据与Salesforce数据一致性 > 99.9%

### 3.3 安全性要求
- **数据传输安全**：采用HTTPS协议传输数据
- **数据存储安全**：敏感数据加密存储
- **访问控制**：实现基于角色的访问控制
- **日志安全**：日志中不包含敏感信息

### 3.4 可扩展性要求
- **模块化设计**：采用模块化设计，支持功能扩展
- **API设计**：提供标准化API，支持第三方系统集成
- **插件机制**：支持插件扩展，支持自定义数据拉取策略
- **配置驱动**：支持配置驱动，减少代码修改

### 3.5 可维护性要求
- **代码规范**：遵循Java编码规范
- **文档完整**：提供完整的设计文档、API文档、部署文档
- **日志完整**：提供详细的日志记录
- **监控完善**：提供完善的监控机制

## 4. 技术架构

### 4.1 技术栈
- **开发语言**：Java 21
- **框架**：Spring Boot 3.5.7
- **ORM框架**：MyBatis + MyBatis Plus
- **数据库**：MySQL
- **Salesforce API**：SOAP API、Bulk V1 API、Bulk V2 API
- **任务调度**：datai-quartz

### 4.2 架构设计
- **分层架构**：采用分层架构设计，包括API层、服务层、数据访问层
- **模块化设计**：按功能模块划分，包括元数据管理、数据拉取、批次管理、定时任务、监控等模块
- **异步处理**：采用异步处理机制，提高系统吞吐量
- **分布式设计**：支持分布式部署，提高系统可用性

## 5. 数据流程

### 5.1 元数据拉取流程
1. 建立Salesforce连接
2. 调用Salesforce API获取元数据
3. 解析元数据信息
4. 生成表结构SQL
5. 执行SQL创建或更新表结构
6. 将元数据存储到本地数据库

### 5.2 数据拉取流程
1. 创建拉取批次
2. 建立Salesforce连接
3. 生成查询条件
4. 调用Salesforce API执行查询
5. 处理查询结果
6. 数据转换与映射
7. 数据存储到本地数据库
8. 更新批次状态
9. 生成同步日志

### 5.3 定时任务流程
1. 定时任务触发
2. 获取待同步对象列表
3. 为每个对象创建拉取批次
4. 执行数据拉取
5. 更新同步状态
6. 生成同步报告

## 6. 数据库设计

### 6.1 核心表结构

#### 6.1.1 数据批次表（datai_batch）
- **功能**：存储数据拉取批次信息
- **主要字段**：
  - id：批次ID
  - api：对象API名称
  - label：对象名称
  - sf_num：Salesforce数据量
  - db_num：本地数据库数据量
  - sync_type：同步类型
  - batch_field：批次字段
  - sync_status：同步状态
  - sync_start_date：开始同步时间
  - sync_end_date：结束同步时间
  - first_sync_time：首次同步时间
  - last_sync_time：最后同步时间

#### 6.1.2 数据批次历史表（datai_batch_history）
- **功能**：存储批次历史记录
- **主要字段**：
  - id：记录ID
  - api：对象API名称
  - label：对象名称
  - batch_id：批次ID
  - batch_field：批次字段
  - sync_num：同步数据量
  - sync_type：同步类型
  - sync_status：同步状态
  - start_time：开始时间
  - end_time：结束时间
  - cost：耗费时间
  - sync_start_time：开始同步时间
  - sync_end_time：结束同步时间

#### 6.1.3 对象信息表（datai_object）
- **功能**：存储对象元数据信息
- **主要字段**：
  - id：主键ID
  - api：对象API名称
  - label：对象名称
  - key_prefix：对象ID前缀
  - namespace：域名空间
  - is_work：是否启用
  - is_update：是否增量更新
  - is_custom：是否自定义对象
  - blob_field：二进制字段
  - batch_field：批次字段
  - total_rows：总数据量
  - last_sync_date：最后同步时间

#### 6.1.4 对象字段信息表（datai_field）
- **功能**：存储字段元数据信息
- **主要字段**：
  - id：主键ID
  - api：所属对象API
  - field：字段API
  - label：字段标签
  - is_createable：是否可创建
  - is_nillable：是否为空
  - is_updateable：是否可更新
  - field_data_type：字段数据类型
  - field_length：字段长度
  - field_precision：数字字段的精度
  - field_scale：数字字段的小数位数

#### 6.1.5 字段选项列表信息表（datai_picklist）
- **功能**：存储选择列表值信息
- **主要字段**：
  - id：主键ID
  - api：对象API
  - field：字段API
  - value：值
  - label：标签
  - active：是否激活
  - default_value：是否默认值

#### 6.1.6 字段过滤查找信息表（datai_filter_lookup）
- **功能**：存储字段过滤查找信息
- **主要字段**：
  - id：主键ID
  - api：对象API
  - field：字段API
  - controlling_field：控制字段API
  - dependent：是否依赖字段
  - lookup_filter：过滤条件

## 7. 部署与运行

### 7.1 部署环境
- **操作系统**：Linux/Unix/Windows
- **JDK版本**：JDK 21
- **数据库版本**：MySQL 8.0+
- **内存要求**：至少4GB
- **磁盘要求**：至少50GB

### 7.2 部署步骤
1. 安装JDK 21
2. 安装MySQL 8.0+
3. 创建数据库并执行SQL脚本
4. 配置application.yml
5. 启动应用

### 7.3 运行管理
- **日志管理**：通过日志文件监控系统运行状态
- **监控管理**：通过监控仪表盘监控同步状态
- **任务管理**：通过定时任务管理界面管理定时任务

## 8. 验收标准

### 8.1 功能验收
- 所有功能需求均已实现
- 功能符合需求文档要求
- 功能之间无冲突
- 支持正常的业务流程

### 8.2 性能验收
- 元数据拉取响应时间 < 10秒
- 数据拉取速度 > 1000条/秒
- 支持至少10个对象的并发同步
- 系统可用性 > 99.5%

### 8.3 可靠性验收
- 数据拉取成功率 > 99.9%
- 数据一致性 > 99.9%
- 故障恢复时间 < 5分钟
- 支持断点续传

### 8.4 安全性验收
- 数据传输采用HTTPS协议
- 敏感数据加密存储
- 实现基于角色的访问控制
- 日志中不包含敏感信息

### 8.5 文档验收
- 提供完整的设计文档
- 提供完整的API文档
- 提供完整的部署文档
- 提供完整的用户手册

## 9. 风险评估

### 9.1 技术风险
- **Salesforce API限制**：Salesforce API有调用频率限制，可能影响数据拉取速度
- **大数据量处理**：大数据量对象的拉取可能导致系统性能问题
- **元数据变更**：Salesforce元数据变更可能导致表结构不一致

### 9.2 业务风险
- **数据一致性**：本地数据与Salesforce数据可能存在不一致
- **数据安全**：敏感数据可能泄露
- **系统可用性**：系统故障可能影响业务运行

### 9.3 应对措施
- **API限流**：实现API调用频率控制，避免触发Salesforce API限制
- **分批处理**：采用分批处理机制，提高大数据量处理能力
- **元数据版本管理**：实现元数据版本管理，支持元数据变更检测与表结构自动更新
- **数据校验**：实现数据一致性校验，确保本地数据与Salesforce数据一致
- **加密存储**：敏感数据加密存储，提高数据安全性
- **高可用设计**：采用高可用设计，提高系统可用性

## 10. 维护与支持

### 10.1 维护计划
- **日常维护**：定期检查系统运行状态，清理日志文件
- **定期备份**：定期备份数据库，确保数据安全
- **版本更新**：定期更新系统版本，修复漏洞，添加新功能

### 10.2 支持方式
- **技术支持**：提供24/7技术支持
- **问题反馈**：提供问题反馈渠道
- **培训服务**：提供系统使用培训

## 11. 附录

### 11.1 术语定义
- **Salesforce**：一种客户关系管理（CRM）平台
- **元数据**：描述数据的数据，包括对象信息、字段信息等
- **SOAP API**：Salesforce提供的基于SOAP协议的API
- **Bulk API**：Salesforce提供的用于批量数据操作的API
- **datai-quartz**：datai平台提供的定时任务组件

### 11.2 参考文档
- **Salesforce API文档**：https://developer.salesforce.com/docs
- **Spring Boot文档**：https://spring.io/projects/spring-boot
- **MyBatis文档**：https://mybatis.org/mybatis-3/
- **datai-quartz文档**：d:\idea_demo\datai\项目整体文档\datai-models\datai-quartz\模块说明文档.md