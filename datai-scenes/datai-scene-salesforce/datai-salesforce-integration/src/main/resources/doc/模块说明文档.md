# Salesforce数据集成模块说明文档

## 1. 模块概述
本模块旨在构建一个企业级Salesforce数据集成解决方案，实现从Salesforce平台高效拉取数据并安全存储到本地数据库的完整流程，支持Salesforce数据的本地化管理、定时同步与实时监控，确保数据一致性与可用性。

## 2. 核心功能

### 2.1 元数据拉取与表结构创建
- 通过Salesforce API获取标准对象与自定义对象的完整元数据信息
- 自动在本地数据库生成对应的数据表结构
- 将对象元数据信息规范化后写入本地数据库的元数据表
- 支持元数据变更检测与表结构自动更新

### 2.2 数据拉取批次管理
- 按批次拉取Salesforce对象数据，支持自定义批次大小
- 本地数据库创建专用批次管理表记录批次信息
- 智能拉取策略：
  - 包含时间字段的对象：基于指定时间字段实现增量拉取
  - 不包含时间字段的对象：执行全量拉取

### 2.3 数据拉取策略
- 存量数据初始化与增量数据同步的差异化拉取
- 完整拉取Salesforce对象的所有记录
- 断点续传机制与失败重试策略
- 数据冲突解决与重复数据检测

### 2.4 定时任务管理
- 基于datai-quartz组件创建定时任务
- 实现Salesforce数据的定期自动拉取

### 2.5 数据拉取监控
- 数据同步监控仪表盘
- 同步异常告警机制
- 详细的同步日志记录
- 数据同步统计分析

## 3. 技术架构

### 3.1 技术栈
- **开发语言**：Java 21
- **框架**：Spring Boot 3.5.7
- **ORM框架**：MyBatis + MyBatis Plus
- **数据库**：MySQL
- **Salesforce API**：SOAP API、Bulk V1 API、Bulk V2 API
- **任务调度**：datai-quartz
- **多线程框架**：Java并发包（ExecutorService、Future等）
- **配置管理**：基于数据库的配置中心

### 3.2 多线程同步架构设计

#### 3.2.1 架构概述
本模块采用基于任务调度的数据拉取架构，结合多线程技术实现高效的Salesforce数据同步。整个系统由以下核心组件构成：

1. **任务调度层**：基于datai-quartz实现定时任务触发
2. **多线程执行层**：SalesforceExecutor管理线程池，处理并行数据拉取任务
3. **API调用层**：封装不同Salesforce API（SOAP、Bulk V1、Bulk V2）的调用逻辑
4. **数据处理层**：负责数据转换、映射和存储
5. **配置管理层**：基于数据库的动态配置中心

#### 3.2.2 线程池设计
- **核心线程数**：通过配置`datai_configuration`表中的`salesforce.concurrent.requests.max`参数控制
- **最大线程数**：根据系统资源和Salesforce API限制动态调整
- **任务队列**：采用有界队列，防止系统资源耗尽
- **线程池策略**：拒绝策略采用CallerRunsPolicy，确保任务不丢失

#### 3.2.3 线程数配置管理
线程数通过`d:\idea_demo\datai\datai-scenes\datai-scene-salesforce\datai-salesforce-setting\src\main\resources\sql\salesforce_configuration.sql`中的以下配置项进行管理：

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| salesforce.concurrent.requests.max | 最大并发请求数（核心线程数） | 10 |
| salesforce.batch.size | 每批处理记录数 | 200 |
| salesforce.rate.limit.threshold | API限流阈值（请求/分钟） | 100 |
| salesforce.retry.count | 失败重试次数 | 3 |
| salesforce.retry.interval | 重试间隔（毫秒） | 5000 |
| salesforce.retry.exponential.backoff | 是否启用指数退避 | true |

#### 3.2.4 多种数据拉取策略应用场景

| API类型 | 应用场景 | 实现方式 |
|---------|----------|----------|
| **SOAP API** | - 小批量数据拉取<br>- 实时性要求高的数据<br>- 需要复杂查询条件的数据 | 基于PartnerConnection的queryAll方法，支持多线程并行查询 |
| **Bulk API V1** | - 中批量数据拉取（10,000-100,000条）<br>- 需要分批处理的数据<br>- 支持CSV和XML格式 | 基于异步作业模式，创建批处理作业后轮询结果 |
| **Bulk API V2** | - 大批量数据拉取（>100,000条）<br>- 简单查询条件的数据<br>- 只支持CSV格式 | 简化的异步批处理模式，支持更大数据量 |

#### 3.2.5 线程安全保障措施

1. **连接池隔离**：每个线程独立使用连接池中的连接，避免线程间连接共享
2. **资源同步**：使用ConcurrentHashMap等线程安全集合存储共享数据
3. **锁机制**：关键资源访问采用ReentrantLock进行保护
4. **事务管理**：使用Spring声明式事务确保数据一致性
5. **请求限流**：实现API调用频率控制，避免触发Salesforce API限制

#### 3.2.6 策略协调机制

系统根据以下规则自动选择合适的数据拉取策略：

1. **数据量阈值**：通过`salesforce.bulk.threshold`配置项（默认2000条）判断
2. **查询复杂度**：复杂查询自动使用SOAP API
3. **实时性要求**：实时同步请求优先使用SOAP API
4. **资源可用性**：根据当前系统资源和API配额动态调整

#### 3.2.7 数据一致性保障方案

1. **批次管理**：每个拉取任务分配唯一批次ID，确保数据完整性
2. **幂等性设计**：所有数据操作均实现幂等，支持重复执行
3. **事务控制**：单批次数据操作在同一事务中完成
4. **冲突解决策略**：通过`salesforce.conflict.resolution`配置项控制（默认salesforce_wins）
5. **数据校验**：实现数据完整性校验，确保字段类型和长度匹配

#### 3.2.8 故障恢复机制

1. **断点续传**：记录每个批次的处理进度，支持从失败点继续
2. **失败重试**：基于指数退避算法的自动重试机制
3. **异常隔离**：单个任务失败不影响其他任务执行
4. **告警通知**：同步失败时通过多种方式通知管理员

### 3.4 模块结构
```
datai-salesforce-integration/
├── src/main/
│   ├── resources/
│   │   ├── datam-salesforce/      # Salesforce集成核心代码
│   │   ├── sql/                   # SQL脚本
│   │   └── doc/                   # 文档目录
└── pom.xml
```

## 4. 数据流程
├── src/main/
│   ├── resources/
│   │   ├── datam-salesforce/      # Salesforce集成核心代码
│   │   ├── sql/                   # SQL脚本
│   │   └── doc/                   # 文档目录
└── pom.xml
```

### 3.3 核心组件

| 组件 | 主要职责 | 文件位置 |
|------|----------|----------|
| SobjectSyncServiceImpl | 元数据拉取与表结构创建 | datam-salesforce/src/main/java/org/dromara/salesforce/service/Impl/SobjectSyncServiceImpl.java |
| SalesforceDataSoapServiceImpl | SOAP API数据拉取 | datam-salesforce/src/main/java/org/dromara/salesforce/service/Impl/SalesforceDataSoapServiceImpl.java |
| SalesforceBulkV1DataServiceImpl | Bulk V1 API数据拉取 | datam-salesforce/src/main/java/org/dromara/salesforce/service/Impl/SalesforceBulkV1DataServiceImpl.java |
| SalesforceBulkV2DataServiceImpl | Bulk V2 API数据拉取 | datam-salesforce/src/main/java/org/dromara/salesforce/service/Impl/SalesforceBulkV2DataServiceImpl.java |
| SalesforceBatchDataServiceImpl | 批次管理 | datam-salesforce/src/main/java/org/dromara/salesforce/service/Impl/SalesforceBatchDataServiceImpl.java |
| SalesforceExecutor | 多线程执行器 | datam-salesforce/src/main/java/org/dromara/salesforce/config/SalesforceExecutor.java |
| SalesforceSingletonConfig | 配置管理 | datam-salesforce/src/main/java/org/dromara/salesforce/config/SalesforceSingletonConfig.java |

### 3.4 数据库表结构

| 表名 | 主要职责 |
|------|----------|
| datai_object | 存储Salesforce对象元数据 |
| datai_field | 存储Salesforce字段元数据 |
| datai_picklist | 存储Salesforce选择列表值 |
| datai_filter_lookup | 存储字段过滤查找信息 |
| datai_batch | 存储数据拉取批次信息 |
| datai_batch_history | 存储批次历史记录 |

## 4. 数据流程

1. **元数据拉取流程**：
   - 建立Salesforce连接
   - 拉取对象元数据
   - 生成表结构
   - 保存元数据到本地数据库

2. **数据拉取流程**：
   - 创建拉取批次
   - 根据拉取策略生成查询
   - 执行数据拉取
   - 数据转换与存储
   - 更新批次状态

3. **定时任务流程**：
   - 定时触发同步任务
   - 获取待同步对象
   - 执行元数据拉取
   - 执行数据拉取
   - 生成同步报告

## 5. 配置说明

### 5.1 主要配置项

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| batch.size.threshold | 批次数据量阈值 | 500000 |
| default.partition.years | 默认分区年数 | 5 |
| source.org.start.date | 源组织开始日期 | 2020-01-01 |
| batch.type | 批次类型 | MONTH |

### 5.2 配置文件
- **application.yml**：系统基础配置
- **SalesforceSingletonConfig**：Salesforce集成配置

## 6. 部署与运行

### 6.1 依赖安装
```bash
mvn clean install
```

### 6.2 启动方式
```bash
java -jar datai-salesforce-integration.jar
```

### 6.3 定时任务管理
- 通过datai-quartz管理界面配置定时任务
- 支持任务的启动、暂停、删除操作

## 7. 监控与维护

### 7.1 日志管理
- 日志文件：logs/salesforce-integration.log
- 日志级别：INFO、WARN、ERROR
- 支持日志归档与清理

### 7.2 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 连接超时 | 网络问题或Salesforce API限制 | 检查网络连接，调整API调用频率 |
| 拉取失败 | 权限不足或字段映射错误 | 检查Salesforce权限，验证字段映射 |
| 数据不一致 | 冲突解决策略配置不当 | 调整冲突解决策略，检查唯一性约束 |

## 8. 扩展与二次开发

### 8.1 新增数据拉取策略
- 实现SalesforceIncrementDataService接口
- 注册为Spring Bean

### 8.2 支持新的Salesforce API
- 实现对应的连接工厂类
- 扩展数据拉取服务

### 8.3 自定义告警方式
- 实现AlertService接口
- 配置告警策略

## 9. 版本历史

| 版本 | 发布日期 | 主要变更 |
|------|----------|----------|
| 1.0.0 | 2025-08-26 | 初始版本 |
| 1.1.0 | 2025-10-15 | 增加Bulk V2 API支持 |
| 1.2.0 | 2025-12-21 | 优化批次管理机制 |

## 10. 联系方式

- **技术支持**：datai-support@example.com
- **文档地址**：https://datai.example.com/docs/salesforce-integration
- **Git仓库**：https://git.example.com/datai/datai-salesforce-integration