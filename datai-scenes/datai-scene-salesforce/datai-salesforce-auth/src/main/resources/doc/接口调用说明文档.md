# Salesforce登录认证接口调用说明文档

## 1. 概述

本文档详细描述了Salesforce登录认证模块提供的RESTful API接口，包括各接口的功能、请求方式、参数说明、返回结果以及调用示例。

### 1.1 基础信息

- 基础路径：`/salesforce/login`
- 控制器类：`DataISfLoginController`
- 跨域支持：是

## 2. 接口详情

### 2.1 执行登录

#### 接口描述
根据不同登录类型执行Salesforce登录操作。

#### 请求URL
```
POST /salesforce/login/execute
```

#### 请求头
```
Content-Type: application/json
```

#### 请求体参数 (SalesforceLoginRequest)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| loginType | String | 是 | 登录类型，支持的类型有：oauth2、salesforce_cli、legacy_credential、session_id |
| username | String | 否 | 用户名 |
| password | String | 否 | 密码 |
| securityToken | String | 否 | 安全令牌 |
| clientId | String | 否 | OAuth客户端ID |
| clientSecret | String | 否 | OAuth客户端密钥 |
| grantType | String | 否 | OAuth授权类型 |
| orgAlias | String | 否 | Salesforce CLI组织别名 |
| privateKeyPath | String | 否 | 私有密钥路径 |
| privateKeyPassword | String | 否 | 私有密钥密码 |
| code | String | 否 | OAuth授权码 |
| sessionId | String | 否 | Salesforce Session ID |

#### 不同登录类型所需参数说明

##### 1. oauth2 登录类型
使用OAuth 2.0标准方式进行登录，适用于大多数现代应用集成场景。

必需参数：
- loginType: "oauth2"
- username: 用户名
- password: 密码
- clientId: OAuth客户端ID
- clientSecret: OAuth客户端密钥
- grantType: 授权类型，支持 "password"、"authorization_code" 或 "client_credentials"

示例请求：
```json
{
  "loginType": "oauth2",
  "username": "user@example.com",
  "password": "password123",
  "clientId": "your_client_id",
  "clientSecret": "your_client_secret",
  "grantType": "password"
}
```

##### 2. salesforce_cli 登录类型
使用Salesforce CLI已经登录的会话进行身份验证，适用于开发和测试环境。

必需参数：
- loginType: "salesforce_cli"
- username: 用户名
- orgAlias: (可选) 已登录的CLI组织别名

示例请求：
```json
{
  "loginType": "salesforce_cli",
  "username": "user@example.com",
  "orgAlias": "my-sandbox"
}
```

##### 3. legacy_credential 登录类型
使用传统的用户名、密码和安全令牌组合进行登录，适用于较老的系统集成。

必需参数：
- loginType: "legacy_credential"
- username: 用户名
- password: 密码
- securityToken: 安全令牌

示例请求：
```json
{
  "loginType": "legacy_credential",
  "username": "user@example.com",
  "password": "password123",
  "securityToken": "securityToken123"
}
```

##### 4. session_id 登录类型
使用已有的Salesforce Session ID进行登录，适用于已有有效会话的场景。

必需参数：
- loginType: "session_id"
- sessionId: Salesforce Session ID

示例请求：
```json
{
  "loginType": "session_id",
  "sessionId": "00Dxx0000001gEWEAY!ARwAQ.KBMrn123XYZ"
}
```

#### 请求示例
```
{
  "loginType": "oauth2",
  "username": "user@example.com",
  "password": "password123",
  "clientId": "your_client_id",
  "clientSecret": "your_client_secret",
  "grantType": "password"
}
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "登录成功",
  "data": {
    "success": true,
    "accessToken": "00Dxx0000001gEWEAY!ARwAQ...",
    "refreshToken": "5Aep861z1k8KCNBg3KmH1...",
    "instanceUrl": "https://your-instance.salesforce.com",
    "organizationId": "00Dxx0000001gEWEAY",
    "userId": "005xx000001SwiQAAS",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "登录失败: Invalid username, password, security token; or user locked out."
}
```

---

### 2.2 刷新令牌

#### 接口描述
使用刷新令牌获取新的访问令牌。

#### 请求URL
```
POST /salesforce/login/refresh-token
```

#### 请求参数 (@RequestParam)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| refreshToken | String | 是 | 刷新令牌 |
| loginType | String | 是 | 登录类型，支持的类型有：oauth2、salesforce_cli、legacy_credential、session_id |

#### 请求示例
```
POST /salesforce/login/refresh-token?refreshToken=5Aep861z1k8KCNBg3KmH1...&loginType=oauth2
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "令牌刷新成功",
  "data": {
    "success": true,
    "accessToken": "00Dxx0000001gEWEAY!ARwAQ...",
    "refreshToken": "5Aep861z1k8KCNBg3KmH1...",
    "instanceUrl": "https://your-instance.salesforce.com",
    "organizationId": "00Dxx0000001gEWEAY",
    "userId": "005xx000001SwiQAAS",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "刷新令牌失败: expired authorization code"
}
```

---

### 2.3 执行登出

#### 接口描述
退出登录，清理登录状态。

#### 请求URL
```
POST /salesforce/login/logout
```

#### 请求参数 (@RequestParam)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| accessToken | String | 是 | 访问令牌 |
| loginType | String | 是 | 登录类型，支持的类型有：oauth2、salesforce_cli、legacy_credential、session_id |

#### 请求示例
```
POST /salesforce/login/logout?accessToken=00Dxx0000001gEWEAY!ARwAQ...&loginType=oauth2
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "登出成功"
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "登出失败"
}
```

---

### 2.4 获取当前登录状态

#### 接口描述
获取当前系统的登录状态。

#### 请求URL
```
GET /salesforce/login/status
```

#### 请求示例
```
GET /salesforce/login/status
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "success": true,
    "accessToken": "00Dxx0000001gEWEAY!ARwAQ...",
    "refreshToken": "5Aep861z1k8KCNBg3KmH1...",
    "instanceUrl": "https://your-instance.salesforce.com",
    "organizationId": "00Dxx0000001gEWEAY",
    "userId": "005xx000001SwiQAAS",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "获取登录状态失败: 未找到有效的登录状态"
}
```

---

### 2.5 验证令牌

#### 接口描述
验证访问令牌的有效性。

#### 请求URL
```
GET /salesforce/login/validate-token
```

#### 请求参数 (@RequestParam)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| accessToken | String | 是 | 访问令牌 |

#### 请求示例
```
GET /salesforce/login/validate-token?accessToken=00Dxx0000001gEWEAY!ARwAQ...
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "令牌有效"
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "令牌无效"
}
```

---

### 2.6 绑定令牌

#### 接口描述
将令牌绑定到指定设备和IP。

#### 请求URL
```
POST /salesforce/login/bind-token
```

#### 请求参数 (@RequestParam)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| accessToken | String | 是 | 访问令牌 |
| deviceId | String | 否 | 设备ID |
| ip | String | 否 | IP地址 |

#### 请求示例
```
POST /salesforce/login/bind-token?accessToken=00Dxx0000001gEWEAY!ARwAQ...&deviceId=device123&ip=192.168.1.100
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "令牌绑定成功"
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "绑定令牌失败: 令牌不存在"
}
```

---

### 2.7 检查令牌绑定

#### 接口描述
检查令牌是否与指定设备和IP匹配。

#### 请求URL
```
GET /salesforce/login/check-binding
```

#### 请求参数 (@RequestParam)
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| accessToken | String | 是 | 访问令牌 |
| deviceId | String | 否 | 设备ID |
| ip | String | 否 | IP地址 |

#### 请求示例
```
GET /salesforce/login/check-binding?accessToken=00Dxx0000001gEWEAY!ARwAQ...&deviceId=device123&ip=192.168.1.100
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "令牌绑定匹配"
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "令牌绑定不匹配"
}
```

---

### 2.8 获取当前会话信息

#### 接口描述
获取当前登录成功的会话详细信息。

#### 请求URL
```
GET /salesforce/login/session
```

#### 请求示例
```
GET /salesforce/login/session
```

#### 成功响应示例
```
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "sessionId": 1,
    "tenantId": "default",
    "username": "user@example.com",
    "loginType": "oauth2",
    "status": "active",
    "loginTime": "2025-12-14T10:30:00",
    "expireTime": "2025-12-14T12:30:00",
    "lastActivityTime": "2025-12-14T10:35:00",
    "loginIp": "192.168.1.100",
    "deviceInfo": "Windows PC",
    "browserInfo": "Chrome 98.0.4758.102",
    "sessionId": "sess_abc123xyz",
    "tokenId": 1001
  }
}
```

#### 失败响应示例
```
{
  "code": 500,
  "msg": "当前没有活跃的登录会话"
}
```

## 3. 返回码说明

| 返回码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 500 | 系统内部错误 |

## 4. 注意事项

1. 所有接口均支持跨域调用
2. 登录成功后，系统会自动将登录结果缓存到Redis中
3. 令牌刷新成功后，系统会自动更新缓存中的登录状态
4. 登出操作会清理相关的登录状态缓存
5. 令牌绑定功能可以增强系统安全性，防止令牌被盗用
6. 所有敏感操作都会记录日志，便于审计追踪

## 5. 错误处理

当发生错误时，系统会返回统一的错误格式：
```
{
  "code": 错误码,
  "msg": "错误描述信息"
}
```

常见错误情况包括但不限于：
- 参数校验失败
- 网络连接异常
- Salesforce API调用失败
- 缓存服务不可用
- 数据库操作异常