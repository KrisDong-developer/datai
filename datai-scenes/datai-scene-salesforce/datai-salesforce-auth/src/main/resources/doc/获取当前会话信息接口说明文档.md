# 获取当前会话信息接口说明文档

## 1. 接口概述

### 1.1 接口名称
获取当前会话信息

### 1.2 接口描述
该接口用于获取当前用户登录成功的会话详细信息，包括用户基本信息、登录时间、会话状态等。通过此接口可以验证用户是否已登录以及获取当前登录会话的详细数据。

### 1.3 请求URL
```
GET /salesforce/login/session
```

### 1.4 请求方法
GET

### 1.5 是否需要认证
否（但需确保用户已登录）

## 2. 请求参数

该接口无需传递任何请求参数。

## 3. 响应格式

### 3.1 响应结构
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    // 会话详细信息对象
  }
}
```

### 3.2 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| code | Integer | 响应状态码，200表示成功 |
| msg | String | 响应消息 |
| data | Object | 响应数据，包含会话详细信息 |

### 3.3 会话信息对象字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| sessionId | Long | 会话ID |
| tenantId | String | 租户编号 |
| username | String | 用户名 |
| loginType | String | 登录类型（oauth2、salesforce_cli、legacy_credential、session_id） |
| status | String | 会话状态（ACTIVE、EXPIRED等） |
| loginTime | String | 登录时间（ISO 8601格式） |
| expireTime | String | 过期时间（ISO 8601格式） |
| lastActivityTime | String | 最后活动时间（ISO 8601格式） |
| loginIp | String | 登录IP地址 |
| deviceInfo | String | 设备信息 |
| browserInfo | String | 浏览器信息 |
| sessionToken | String | 会话标识 |
| tokenId | Long | 令牌ID |

## 4. 使用示例

### 4.1 请求示例
```bash
curl -X GET "http://localhost:8080/salesforce/login/session" \
-H "Content-Type: application/json"
```

### 4.2 成功响应示例
```json
{
  "code": 200,
  "msg": "获取成功",
  "data": {
    "sessionId": 10001,
    "tenantId": "default",
    "username": "user@example.com",
    "loginType": "oauth2",
    "status": "ACTIVE",
    "loginTime": "2025-12-14T10:30:00",
    "expireTime": "2025-12-14T12:30:00",
    "lastActivityTime": "2025-12-14T10:35:00",
    "loginIp": "192.168.1.100",
    "deviceInfo": "Windows PC",
    "browserInfo": "Chrome 98.0.4758.102",
    "sessionToken": "sess_abc123xyz",
    "tokenId": 20001
  }
}
```

### 4.3 失败响应示例（无活跃会话）
```json
{
  "code": 500,
  "msg": "当前没有活跃的登录会话"
}
```

### 4.4 失败响应示例（系统异常）
```json
{
  "code": 500,
  "msg": "获取当前登录会话信息失败: 数据库连接异常"
}
```

## 5. 业务逻辑说明

### 5.1 接口工作原理
1. 接收到请求后，系统会查询数据库中所有状态为"ACTIVE"的登录会话记录
2. 按照登录时间倒序排列，获取最新的会话记录
3. 将会话信息缓存到Redis中以提高下次访问的性能
4. 返回会话详细信息给客户端

### 5.2 会话状态说明
- ACTIVE：活跃会话，用户当前已登录
- EXPIRED：已过期会话，用户需要重新登录
- REVOKED：已吊销会话，用户主动登出或被管理员强制登出

### 5.3 数据来源
会话信息存储在[datai_sf_login_session](file:///D:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-auth/src/main/java/com/datai/auth/mapper/DataiSfLoginSessionMapper.java#L17-L17)表中，与[datai_sf_token](file:///D:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-auth/src/main/java/com/datai/auth/mapper/DataiSfTokenMapper.java#L17-L17)表通过[tokenId](file:///D:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-auth/src/main/java/com/datai/auth/domain/DataiSfLoginSession.java#L101-L101)字段关联。

## 6. 异常处理

### 6.1 常见异常情况
| 异常情况 | 错误码 | 错误信息 | 处理建议 |
|---------|--------|---------|---------|
| 无活跃会话 | 500 | 当前没有活跃的登录会话 | 用户需要重新登录 |
| 数据库异常 | 500 | 获取当前登录会话信息失败: [具体错误信息] | 检查数据库连接和服务状态 |
| 系统内部错误 | 500 | 获取当前登录会话信息失败: [具体错误信息] | 查看系统日志，联系技术支持 |

### 6.2 日志记录
接口调用过程中会产生以下日志：
- INFO级别：记录接口调用开始和结束
- DEBUG级别：记录详细的处理过程
- ERROR级别：记录异常信息

## 7. 性能与安全

### 7.1 性能优化
- 使用Redis缓存会话信息，减少数据库访问
- 对数据库查询结果进行排序优化
- 限制返回的会话记录数量（仅返回最新的活跃会话）

### 7.2 安全考虑
- 接口不暴露敏感信息如密码、访问令牌等
- 会话信息仅包含必要的元数据
- 所有操作都记录审计日志

## 8. 相关接口

### 8.1 前置接口
- [/salesforce/login/execute](file:///D:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-auth/src/main/java/com/datai/auth/controller/DataISfLoginController.java#L48-L74)：执行登录，创建会话信息


