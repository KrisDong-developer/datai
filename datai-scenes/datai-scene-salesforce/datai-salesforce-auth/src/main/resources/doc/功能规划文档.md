# datai-salesforce-auth 模块功能规划文档

## 1. 模块定位

### 1.1 模块概述
datai-salesforce-auth 是 Salesforce 认证中心模块，负责处理所有与 Salesforce 相关的身份认证、授权和会话管理功能。作为整个 Salesforce 集成体系的安全基石，为其他业务模块提供统一的认证服务。

### 1.2 设计理念
- **统一认证入口**：提供统一的认证接口，屏蔽底层认证细节
- **多策略支持**：采用策略模式，支持多种认证方式，易于扩展
- **安全第一**：多层次安全机制，保障系统安全
- **高性能**：利用 Redis 缓存，减少数据库访问
- **可观测性**：完善的日志和监控，便于问题排查

### 1.3 核心价值
- 降低其他模块的认证复杂度
- 提供统一的认证标准
- 保障系统安全性和可靠性
- 提升用户体验

---

## 2. 功能架构

### 2.1 功能分层架构

```
┌─────────────────────────────────────────────────────────┐
│                    接口层 (API Layer)                    │
│  RESTful API 接口、Controller 层                        │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Service Layer)             │
│  登录服务、令牌管理、会话管理、安全控制                   │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   策略层 (Strategy Layer)                │
│  OAuth2 策略、CLI 策略、传统凭证策略、Session ID 策略     │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   数据访问层 (Data Layer)                │
│  数据库访问、Redis 缓存、外部 API 调用                    │
└─────────────────────────────────────────────────────────┘
```

### 2.2 功能模块划分

```
datai-salesforce-auth
├── 核心认证模块
│   ├── 登录认证
│   ├── 令牌管理
│   └── 会话管理
├── 安全控制模块
│   ├── 访问控制
│   ├── 风险检测
│   └── 审计日志
├── 管理功能模块
│   ├── 配置管理
│   ├── 用户管理
│   └── 策略管理
└── 监控分析模块
    ├── 登录统计
    ├── 性能监控
    └── 健康检查
```

---

## 3. 核心功能模块

### 3.1 登录认证功能

#### 3.1.1 多种登录方式支持

| 登录方式 | 登录类型 | 适用场景 | 安全级别 |
|---------|---------|---------|---------|
| OAuth 2.0 | oauth2 | 现代应用集成、Web 应用 | 高 |
| Salesforce CLI | salesforce_cli | 开发环境、测试环境 | 中 |
| 传统凭证 | legacy_credential | 老系统集成、内部系统 | 中 |
| Session ID | session_id | 已有会话场景 | 中 |
| JWT Token | jwt_token | 微服务架构、分布式系统 | 高 |
| SAML SSO | saml_sso | 企业单点登录 | 高 |
| OAuth 2.0 JWT Bearer | oauth2_jwt_bearer | 服务间认证 | 高 |

#### 3.1.2 登录流程

```
客户端请求
    ↓
参数验证
    ↓
账号锁定检查
    ↓
获取登录策略
    ↓
执行登录认证
    ↓
创建会话和令牌
    ↓
缓存登录状态
    ↓
记录审计日志
    ↓
返回登录结果
```

#### 3.1.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 执行登录 | POST | /salesforce/login/execute | 执行登录操作 |
| 自动登录 | POST | /salesforce/login/auto | 使用上次登录参数自动登录 |
| 登出 | POST | /salesforce/login/logout | 退出登录 |

---

### 3.2 令牌管理功能

#### 3.2.1 令牌类型

| 令牌类型 | 用途 | 有效期 | 可刷新 |
|---------|------|--------|--------|
| 访问令牌 | 访问 Salesforce API | 短期（2小时） | 是 |
| 刷新令牌 | 获取新的访问令牌 | 长期（30天） | 否 |
| ID 令牌 | 获取用户信息 | 短期（2小时） | 否 |
| JWT 令牌 | 服务间认证 | 可配置 | 否 |

#### 3.2.2 令牌生命周期管理

```
生成令牌 → 验证令牌 → 刷新令牌 → 吊销令牌
    ↓          ↓          ↓          ↓
  存储       缓存       更新       清理
    ↓          ↓          ↓          ↓
  绑定       过期检查   同步       审计
```

#### 3.2.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 刷新令牌 | POST | /salesforce/login/refresh-token | 刷新访问令牌 |
| 验证令牌 | GET | /salesforce/login/validate-token | 验证令牌有效性 |
| 吊销令牌 | POST | /salesforce/login/revoke-token | 吊销令牌 |
| 绑定令牌 | POST | /salesforce/login/bind-token | 绑定令牌到设备/IP |
| 检查绑定 | GET | /salesforce/login/check-binding | 检查令牌绑定状态 |

---

### 3.3 会话管理功能

#### 3.3.1 会话状态

| 状态 | 描述 | 可转换 |
|------|------|--------|
| ACTIVE | 活跃会话 | EXPIRED、REVOKED |
| EXPIRED | 已过期 | ACTIVE（重新登录） |
| REVOKED | 已吊销 | ACTIVE（重新登录） |
| INVALID | 无效 | ACTIVE（重新登录） |

#### 3.3.2 会话管理功能

| 功能 | 描述 |
|------|------|
| 会话创建 | 登录成功后创建新会话 |
| 会话查询 | 查询当前活跃会话 |
| 会话更新 | 更新会话活动时间 |
| 会话过期 | 自动过期处理 |
| 会话清理 | 定期清理过期会话 |
| 多会话管理 | 支持用户多设备登录 |

#### 3.3.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取会话 | GET | /salesforce/login/session | 获取当前会话信息 |
| 获取登录状态 | GET | /salesforce/login/status | 获取当前登录状态 |
| 查询会话列表 | GET | /salesforce/login/sessions | 查询用户的所有会话 |
| 终止会话 | DELETE | /salesforce/login/session/{id} | 终止指定会话 |
| 终止所有会话 | DELETE | /salesforce/login/sessions | 终止用户的所有会话 |

---

## 4. 安全控制模块

### 4.1 访问控制功能

#### 4.1.1 账号锁定机制

| 锁定类型 | 触发条件 | 锁定时长 | 解锁方式 |
|---------|---------|---------|---------|
| 登录失败锁定 | 连续失败 N 次 | 可配置 | 等待过期/手动解锁 |
| 异常访问锁定 | 异常 IP/设备访问 | 可配置 | 管理员解锁 |
| 强制锁定 | 管理员操作 | 永久 | 管理员解锁 |

#### 4.1.2 访问限制

| 限制类型 | 描述 |
|---------|------|
| IP 白名单 | 仅允许特定 IP 访问 |
| IP 黑名单 | 拒绝特定 IP 访问 |
| 时间窗口限制 | 限制特定时间段访问 |
| 频率限制 | 限制单位时间内的请求次数 |

#### 4.1.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 检查账号锁定 | GET | /salesforce/login/check-lock | 检查账号是否被锁定 |
| 解锁账号 | POST | /salesforce/login/unlock | 解锁账号 |
| 获取失败记录 | GET | /salesforce/login/failed-logins | 获取登录失败记录 |

---

### 4.2 风险检测功能

#### 4.2.1 风险检测维度

| 检测维度 | 检测内容 | 风险等级 |
|---------|---------|---------|
| 异常登录 | 异常时间、异常地点、异常设备 | 高 |
| 暴力破解 | 短时间内多次失败尝试 | 高 |
| 令牌异常 | 令牌频繁刷新、异常使用 | 中 |
| 会话异常 | 多设备同时登录、异常活动 | 中 |

#### 4.2.2 风险处理策略

| 风险等级 | 处理策略 |
|---------|---------|
| 低 | 记录日志，告警 |
| 中 | 要求二次验证，限制操作 |
| 高 | 锁定账号，通知管理员 |

#### 4.2.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 风险评估 | POST | /salesforce/login/risk-assess | 评估登录风险 |
| 获取风险事件 | GET | /salesforce/login/risk-events | 获取风险事件列表 |

---

### 4.3 审计日志功能

#### 4.3.1 日志记录内容

| 日志类型 | 记录内容 |
|---------|---------|
| 登录日志 | 登录时间、IP、设备、结果 |
| 令牌日志 | 令牌创建、刷新、吊销 |
| 会话日志 | 会话创建、更新、终止 |
| 操作日志 | 关键操作记录 |
| 异常日志 | 异常事件记录 |

#### 4.3.2 日志查询功能

| 查询维度 | 支持条件 |
|---------|---------|
| 时间范围 | 起始时间、结束时间 |
| 用户 | 用户名、用户 ID |
| 操作类型 | 登录、登出、刷新等 |
| 操作结果 | 成功、失败 |
| IP 地址 | IP 地址段查询 |

#### 4.3.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取审计日志 | GET | /salesforce/login/audit-logs | 获取审计日志列表 |
| 导出审计日志 | GET | /salesforce/login/audit-logs/export | 导出审计日志 |

---

## 5. 管理功能模块

### 5.1 配置管理功能

#### 5.1.1 配置项

| 配置项 | 描述 | 默认值 |
|-------|------|--------|
| 登录超时时间 | 登录操作超时时间 | 30 秒 |
| 令牌过期时间 | 访问令牌过期时间 | 7200 秒 |
| 刷新令牌过期时间 | 刷新令牌过期时间 | 2592000 秒 |
| 会话过期时间 | 会话过期时间 | 86400 秒 |
| 失败锁定次数 | 连续失败锁定次数 | 5 次 |
| 锁定时长 | 账号锁定时长 | 1800 秒 |
| 缓存过期时间 | Redis 缓存过期时间 | 3600 秒 |

#### 5.1.2 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取配置 | GET | /salesforce/login/config | 获取登录配置 |
| 更新配置 | PUT | /salesforce/login/config | 更新登录配置 |
| 重置配置 | POST | /salesforce/login/config/reset | 重置为默认配置 |

---

### 5.2 用户管理功能

#### 5.2.1 用户信息管理

| 功能 | 描述 |
|------|------|
| 用户查询 | 查询 Salesforce 用户信息 |
| 用户同步 | 同步 Salesforce 用户信息 |
| 用户状态 | 管理用户登录状态 |

#### 5.2.2 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取用户信息 | GET | /salesforce/login/user-info | 获取当前用户信息 |
| 同步用户信息 | POST | /salesforce/login/sync-user | 同步 Salesforce 用户信息 |

---

### 5.3 策略管理功能

#### 5.3.1 策略管理

| 功能 | 描述 |
|------|------|
| 策略列表 | 获取支持的登录策略 |
| 策略启用/禁用 | 启用或禁用特定策略 |
| 策略配置 | 配置策略参数 |

#### 5.3.2 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取策略列表 | GET | /salesforce/login/strategies | 获取支持的登录策略 |
| 更新策略配置 | PUT | /salesforce/login/strategy/{type} | 更新策略配置 |

---

## 6. 监控分析模块

### 6.1 登录统计功能

#### 6.1.1 统计维度

| 统计维度 | 指标 |
|---------|------|
| 登录统计 | 登录次数、成功率、失败率 |
| 令牌统计 | 刷新次数、吊销次数 |
| 会话统计 | 活跃会话数、平均会话时长 |
| 用户统计 | 活跃用户数、新增用户数 |

#### 6.1.2 统计粒度

| 粒度 | 用途 |
|------|------|
| 实时统计 | 实时监控 |
| 小时统计 | 趋势分析 |
| 日统计 | 日报生成 |
| 月统计 | 月报生成 |

#### 6.1.3 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取登录统计 | GET | /salesforce/login/statistics | 获取登录统计数据 |
| 获取趋势数据 | GET | /salesforce/login/trends | 获取登录趋势数据 |
| 生成报表 | POST | /salesforce/login/report | 生成统计报表 |

---

### 6.2 性能监控功能

#### 6.2.1 监控指标

| 指标类型 | 监控项 |
|---------|--------|
| 性能指标 | 响应时间、吞吐量、错误率 |
| 资源指标 | CPU、内存、网络、磁盘 |
| 缓存指标 | 缓存命中率、缓存大小 |
| 数据库指标 | 连接数、查询时间、慢查询 |

#### 6.2.2 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 获取性能指标 | GET | /salesforce/login/metrics | 获取性能指标 |
| 获取健康状态 | GET | /salesforce/login/health | 获取模块健康状态 |

---

### 6.3 健康检查功能

#### 6.3.1 检查项

| 检查项 | 检查内容 |
|-------|---------|
| 数据库连接 | 数据库连接状态 |
| Redis 连接 | Redis 连接状态 |
| Salesforce API | Salesforce API 连接状态 |
| 外部依赖 | 外部服务依赖状态 |

#### 6.3.2 核心接口

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|---------|
| 健康检查 | GET | /salesforce/login/health | 执行健康检查 |
| 就绪检查 | GET | /salesforce/login/ready | 检查模块是否就绪 |

---

## 7. 数据模型

### 7.1 核心数据表

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| datai_sf_login_session | 登录会话 | session_id, username, status, login_time |
| datai_sf_token | 令牌信息 | token_id, access_token, refresh_token, status |
| datai_sf_login_audit | 审计日志 | audit_id, operation_type, result, operation_time |
| datai_sf_token_binding | 令牌绑定 | binding_id, token_id, device_id, binding_ip |
| datai_sf_failed_login | 失败记录 | failed_id, username, failed_time, lock_status |
| datai_sf_login_statistics | 统计数据 | stat_id, stat_date, login_type, success_count |

### 7.2 数据流转

```
登录请求 → 参数验证 → 策略执行 → 令牌生成 → 会话创建 → 缓存更新 → 审计记录 → 统计更新
```

---

## 8. 技术架构

### 8.1 技术栈

| 层级 | 技术 |
|------|------|
| 开发语言 | Java 22 |
| 框架 | Spring Boot |
| ORM | MyBatis |
| 缓存 | Redis |
| 数据库 | MySQL |
| 安全 | Spring Security |
| 日志 | SLF4J + Logback |

### 8.2 设计模式

| 模式 | 应用场景 |
|------|---------|
| 策略模式 | 多种登录方式 |
| 工厂模式 | 登录策略创建 |
| 单例模式 | 缓存管理器 |
| 观察者模式 | 事件通知 |
| 模板方法模式 | 登录流程 |

---

## 9. 扩展性设计

### 9.1 扩展点

| 扩展点 | 扩展方式 |
|-------|---------|
| 登录策略 | 实现 LoginStrategy 接口 |
| 令牌验证 | 实现 TokenValidator 接口 |
| 风险检测 | 实现 RiskDetector 接口 |
| 审计日志 | 实现 AuditLogger 接口 |
| 统计报表 | 实现 StatisticsCollector 接口 |

### 9.2 插件机制

系统支持通过插件方式扩展功能：
- 登录策略插件
- 令牌管理插件
- 安全控制插件
- 监控分析插件

---

## 10. 性能优化

### 10.1 缓存策略

| 缓存项 | 缓存方式 | 过期时间 |
|-------|---------|---------|
| 登录状态 | Redis | 令牌过期时间 |
| 用户信息 | Redis | 1 小时 |
| 配置信息 | Redis | 30 分钟 |
| 统计数据 | Redis | 5 分钟 |

### 10.2 数据库优化

| 优化项 | 优化方式 |
|-------|---------|
| 索引优化 | 合理创建索引 |
| 查询优化 | 避免 N+1 查询 |
| 分表分库 | 按租户/时间分表 |
| 读写分离 | 主从复制 |

---

## 11. 安全设计

### 11.1 安全机制

| 安全机制 | 实现方式 |
|---------|---------|
| 数据加密 | AES 加密敏感数据 |
| 令牌签名 | JWT 签名验证 |
| HTTPS | 全链路加密传输 |
| SQL 注入防护 | 参数化查询 |
| XSS 防护 | 输入输出过滤 |

### 11.2 合规性

| 合规项 | 实现方式 |
|-------|---------|
| 数据隐私 | 数据脱敏、访问控制 |
| 审计追踪 | 完整的审计日志 |
| 数据保留 | 可配置的数据保留策略 |

---

## 12. 运维支持

### 12.1 监控告警

| 监控项 | 告警阈值 |
|-------|---------|
| 登录失败率 | > 10% |
| 响应时间 | > 3 秒 |
| 错误率 | > 5% |
| 缓存命中率 | < 80% |

### 12.2 日志管理

| 日志级别 | 用途 |
|---------|------|
| ERROR | 错误日志 |
| WARN | 警告日志 |
| INFO | 关键操作日志 |
| DEBUG | 调试日志 |

---

## 13. 版本规划

### 13.1 当前版本 (v1.0.0)

- 基础登录功能
- 令牌管理
- 会话管理
- 基础安全控制
- 审计日志
- 登录统计

### 13.2 后续版本规划

| 版本 | 计划功能 |
|------|---------|
| v1.1.0 | JWT Token 支持、SAML SSO 支持 |
| v1.2.0 | 高级风险检测、智能告警 |
| v1.3.0 | 多租户增强、权限管理 |
| v2.0.0 | 分布式认证、联邦认证 |

---

## 14. 附录

### 14.1 术语表

| 术语 | 定义 |
|------|------|
| 访问令牌 | 用于访问 Salesforce API 的短期令牌 |
| 刷新令牌 | 用于获取新的访问令牌的长期令牌 |
| 会话 | 用户登录后的活动上下文 |
| 策略 | 特定的登录认证方式 |
| 租户 | 系统的多租户隔离单位 |

### 14.2 参考资料

- Salesforce OAuth 2.0 文档
- Salesforce SOAP API 文档
- Spring Security 文档
- Redis 文档

---

**文档版本**: v1.0.0  
**最后更新**: 2025-12-25  
**维护者**: datai 开发团队
