# datai-salesforce-auth - Salesforce登录认证模块

## 1. 模块概述

### 1.1 模块定位

负责Salesforce登录认证和令牌管理，是所有需要访问Salesforce API的模块的基础。

### 1.2 核心功能与职责

- 支持多种Salesforce登录方式
- 访问令牌和刷新令牌的管理
- 登录状态的保存和获取
- 登录审计日志记录
- 令牌自动刷新机制
- 登录失败锁定机制
- 增强型令牌管理
- 登录会话管理
- 登录统计与报表

### 1.3 设计思路

采用策略模式设计，支持多种登录方式的扩展。使用Redis缓存存储登录状态，提高访问性能。实现令牌自动刷新机制，确保系统持续可用。引入分层架构，将控制器、服务层、策略层和数据访问层分离，便于维护和扩展。支持事件驱动设计，用于处理登录事件。

## 2. 对外提供的接口/方法列表

### 2.1 登录相关接口

| 接口名称 | 方法签名 | 功能描述 | 参数说明 | 返回值 |
|---------|---------|---------|---------|-------|
| 登录接口 | `SalesforceLoginResult login(SalesforceLoginRequest request)` | 根据不同登录类型执行登录 | request：登录请求，包含登录类型、用户名、密码等信息 | 登录结果，包含访问令牌、实例URL等 |
| 刷新令牌接口 | `SalesforceLoginResult refreshToken(String refreshToken, String loginType)` | 刷新访问令牌 | refreshToken：刷新令牌<br>loginType：登录类型 | 新的登录结果 |
| 登出接口 | `boolean logout(String accessToken, String loginType)` | 执行登出操作 | accessToken：访问令牌<br>loginType：登录类型 | 登出是否成功 |
| 获取当前登录状态 | `SalesforceLoginResult getCurrentLoginStatus()` | 获取当前登录状态 | 无 | 当前登录状态 |
| 保存登录状态 | `void saveLoginStatus(SalesforceLoginResult result)` | 保存登录状态到缓存 | result：登录结果 | 无 |

### 2.2 登录策略相关接口

| 接口名称 | 方法签名 | 功能描述 | 参数说明 | 返回值 |
|---------|---------|---------|---------|-------|
| 获取登录策略 | `LoginStrategy getLoginStrategy(String loginType)` | 根据登录类型获取对应的登录策略 | loginType：登录类型 | 登录策略实现 |
| 获取支持的登录类型 | `List<String> getSupportedLoginTypes()` | 获取所有支持的登录类型 | 无 | 支持的登录类型列表 |



### 2.6 令牌管理相关接口

| 接口名称 | 方法签名 | 功能描述 | 参数说明 | 返回值 |
|---------|---------|---------|---------|-------|
| 验证令牌 | `boolean validateToken(String accessToken)` | 验证令牌有效性 | accessToken：访问令牌 | 是否有效 |
| 吊销令牌 | `boolean revokeToken(String accessToken)` | 吊销令牌 | accessToken：访问令牌 | 是否吊销成功 |
| 绑定令牌 | `void bindToken(String accessToken, String deviceId, String ip)` | 绑定令牌到设备/IP | accessToken：访问令牌<br>deviceId：设备ID<br>ip：IP地址 | 无 |
| 检查令牌绑定 | `boolean checkTokenBinding(String accessToken, String deviceId, String ip)` | 检查令牌绑定 | accessToken：访问令牌<br>deviceId：设备ID<br>ip：IP地址 | 是否绑定匹配 |

## 3. 内部实现的关键逻辑

### 3.1 登录认证流程

1. 客户端调用登录接口，传入登录请求
2. 登录服务进行请求参数验证
3. 登录服务根据登录类型获取对应的登录策略
4. 执行具体的登录策略，调用Salesforce API获取令牌
5. 保存登录会话到数据库和Redis缓存
6. 记录登录审计日志
7. 返回登录结果

### 3.2 令牌刷新流程

1. 系统定期检查登录会话的过期时间
2. 当令牌即将过期时，自动调用刷新令牌接口
3. 根据登录类型获取对应的登录策略
4. 执行令牌刷新操作，获取新的访问令牌
5. 更新登录会话的令牌信息
6. 更新Redis缓存中的登录状态
7. 记录令牌刷新日志

### 3.6 关键类说明

#### SalesforceLoginServiceImpl
- 实现登录认证的核心逻辑
- 管理登录策略的调用
- 处理登录状态的保存与获取
- 记录登录审计日志

#### LoginStrategyFactory
- 登录策略工厂，负责根据登录类型创建对应的登录策略
- 支持策略的动态扩展

#### OAuth2LoginStrategy
- 实现OAuth 2.0登录策略
- 支持OAuth 2.0授权码流程、密码流程和客户端凭证流程

#### SalesforceCliLoginStrategy
- 实现Salesforce CLI登录策略
- 支持通过Salesforce CLI获取和使用访问令牌

#### LegacyCredentialLoginStrategy
- 实现传统账密凭证登录策略
- 支持使用用户名、密码和安全令牌进行登录
- 支持SOAP登录方式

#### TokenManager
- 令牌管理器，负责令牌的验证、吊销、绑定等操作
- 支持令牌绑定设备/IP，提高安全性

#### SalesforceConfigCacheManager
- 配置缓存管理器，用于获取Salesforce API配置
- 支持配置的动态更新

## 4. 与其他模块的依赖关系

### 4.1 依赖其他模块

| 模块名称 | 依赖类型 | 用途 |
|---------|---------|------|
| datai-salesforce-common | 直接依赖 | 提供通用工具类和API客户端 |
| datai-salesforce-config | 直接依赖 | 获取系统配置 |
| datai-common | 直接依赖 | 提供基础框架支持和工具类 |
| Redis缓存服务 | 外部依赖 | 存储登录状态、会话信息和临时数据 |
| 数据库服务 | 外部依赖 | 存储登录审计日志、会话信息 |
| Nimbus JOSE + JWT | 外部依赖 | JWT处理和验证 |
| Spring Security OAuth2 | 外部依赖 | OAuth 2.0支持 |

### 4.2 被其他模块依赖

| 模块名称 | 依赖类型 | 用途 |
|---------|---------|------|
| datai-salesforce-meta | 直接依赖 | 获取Salesforce API访问权限 |
| datai-salesforce-integration | 直接依赖 | 获取Salesforce API访问权限 |
| datai-salesforce-dataloader | 直接依赖 | 获取Salesforce API访问权限 |
| datai-salesforce-apex-lwc | 直接依赖 | 获取Salesforce API访问权限 |
| datai-salesforce-report | 直接依赖 | 获取Salesforce API访问权限 |

## 5. 数据流转路径说明

### 5.1 登录认证数据流转

```
客户端 → 登录控制器 → 登录服务 → 登录策略 → Salesforce API → 登录结果 → 数据库存储 → Redis缓存 → 客户端
```

### 5.2 令牌刷新数据流转

```
系统定时检查 → 登录会话管理 → 刷新令牌服务 → 登录策略 → Salesforce API → 新令牌 → 数据库更新 → Redis缓存更新 → 登录状态更新
```

### 5.3 登出数据流转

```
客户端 → 登出控制器 → 登出服务 → 登录策略 → Salesforce API（可选） → Redis缓存清除 → 数据库更新 → 客户端
```

## 6. 性能与安全考量

### 6.1 性能考量

- 使用Redis缓存登录状态、会话信息和临时数据，减少数据库访问
- 登录状态缓存支持可配置的过期时间
- 令牌自动刷新机制，避免频繁手动刷新
- 登录策略的懒加载，提高系统启动速度
- 数据库查询优化，使用索引加速查询

### 6.2 安全考量

- 敏感信息在日志中掩码处理
- 登录审计日志记录所有登录操作
- 访问令牌定期刷新，支持令牌吊销
- Redis缓存中的敏感信息加密存储
- 支持多种认证方式，适应不同安全需求
- 令牌绑定设备/IP，提高安全性
- 安全的密码策略和密码存储
- 支持强制密码更改和密码过期
- 支持XSS和CSRF防护
- 支持安全的CORS配置

## 7. 典型使用场景

### 7.1 OAuth 2.0登录场景

```java
// 创建登录请求
SalesforceLoginRequest request = new SalesforceLoginRequest();
request.setLoginType("oauth2");
request.setUsername("user@example.com");
request.setPassword("password123");
request.setClientId("clientId");
request.setClientSecret("clientSecret");
request.setGrantType("password"); // 支持authorization_code, password, client_credentials

// 执行登录
SalesforceLoginResult result = salesforceLoginService.login(request);

// 处理登录结果
if (result.isSuccess()) {
    // 登录成功，获取访问令牌
    String accessToken = result.getAccessToken();
    String instanceUrl = result.getInstanceUrl();
    // 使用访问令牌调用Salesforce API
} else {
    // 登录失败，处理错误信息
    String errorMessage = result.getErrorMessage();
}
```

### 7.2 Salesforce CLI登录场景

```java
// 创建登录请求
SalesforceLoginRequest request = new SalesforceLoginRequest();
request.setLoginType("salesforce_cli");
request.setUsername("user@example.com");
request.setOrgAlias("my-sandbox"); // 可选，使用已登录的CLI组织别名

// 执行登录
SalesforceLoginResult result = salesforceLoginService.login(request);

// 处理登录结果
if (result.isSuccess()) {
    // 登录成功，获取访问令牌
    String accessToken = result.getAccessToken();
    String instanceUrl = result.getInstanceUrl();
    // 使用访问令牌调用Salesforce API
} else {
    // 登录失败，处理错误信息
    String errorMessage = result.getErrorMessage();
}
```

### 7.3 传统账密凭证登录场景

```java
// 创建登录请求
SalesforceLoginRequest request = new SalesforceLoginRequest();
request.setLoginType("legacy_credential");
request.setUsername("user@example.com");
request.setPassword("password123");
request.setSecurityToken("securityToken123");

// 执行登录
SalesforceLoginResult result = salesforceLoginService.login(request);

// 处理登录结果
if (result.isSuccess()) {
    // 登录成功，获取访问令牌
    String accessToken = result.getAccessToken();
    String instanceUrl = result.getInstanceUrl();
    // 使用访问令牌调用Salesforce API
} else {
    // 登录失败，处理错误信息
    String errorMessage = result.getErrorMessage();
}
```

### 7.4 令牌管理场景

```java
// 验证令牌
boolean isValid = tokenManager.validateToken(accessToken);
if (isValid) {
    // 令牌有效，继续处理
}

// 吊销令牌
boolean revoked = tokenManager.revokeToken(accessToken);
if (revoked) {
    // 令牌已吊销
}

// 绑定令牌
String deviceId = "device-123";
String ip = "192.168.1.1";
tokenManager.bindToken(accessToken, deviceId, ip);

// 检查令牌绑定
boolean bound = tokenManager.checkTokenBinding(accessToken, deviceId, ip);
if (bound) {
    // 令牌绑定匹配
}
```

## 8. 维护指南

### 8.1 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 登录失败 | 登录类型不正确 | 检查登录类型是否在支持列表中 |
| 登录失败 | 用户名密码错误 | 检查用户名密码和安全令牌是否正确 |
| 登录失败 | 客户端ID/Secret错误 | 检查OAuth应用配置是否正确 |
| 令牌刷新失败 | 刷新令牌无效 | 重新登录获取新的刷新令牌 |
| 令牌刷新失败 | Salesforce API连接异常 | 检查网络连接和API配置 |
| 登录状态获取失败 | Redis缓存异常 | 检查Redis服务是否正常运行 |
| 登录状态获取失败 | 登录会话已过期 | 重新登录获取新的会话 |
| 登录被锁定 | 登录失败次数过多 | 等待锁定时间过期或手动解锁 |

### 8.2 日志查看

- 登录相关日志：搜索"SalesforceLoginServiceImpl"关键字
- 登录策略相关日志：搜索"LoginStrategy"关键字
- 令牌管理相关日志：搜索"TokenManager"关键字
- 配置相关日志：搜索"SalesforceConfigCacheManager"关键字
- 登录审计日志：搜索"SalesforceLoginAudit"关键字

### 8.3 监控指标

- 登录成功率：监控登录成功与失败的比例
- 令牌刷新成功率：监控令牌刷新成功与失败的比例
- 登录请求频率：监控单位时间内的登录请求次数
- 缓存命中率：监控登录状态和会话缓存的命中率
- 会话平均时长：监控登录会话的平均持续时间
- 登录失败次数：监控登录失败的次数和趋势
- 令牌吊销数量：监控令牌吊销的数量
- API调用成功率：监控与Salesforce API的调用成功率

## 9. 扩展点与自定义

### 9.1 添加新的登录方式

1. 创建新的登录策略类，实现LoginStrategy接口
2. 在策略类上添加@Component注解
3. 实现login、refreshToken和logout方法
4. 系统自动识别并加载新的登录策略

### 9.5 自定义配置

可以通过配置文件或数据库配置以下参数：
- Salesforce API版本
- 登录超时时间
- 令牌过期时间
- Redis缓存过期时间
- 登录失败锁定配置（锁定时长、解锁方式等）
- 审计日志保留配置

## 10. 版本历史

| 版本 | 发布日期 | 主要变更 |
|------|---------|---------|
| 1.0.0 | 2025-12-11 | 初始版本，支持密码登录、JWT登录、客户端凭证登录 |
| 1.1.0 | 2025-12-11 | 增强版本，添加登录失败锁定、增强型令牌管理、登录会话管理、登录统计与报表功能 |

## 11. 联系方式

- 模块负责人：系统重构小组
- 联系邮箱：team@example.com
- 文档更新日期：2025-12-11