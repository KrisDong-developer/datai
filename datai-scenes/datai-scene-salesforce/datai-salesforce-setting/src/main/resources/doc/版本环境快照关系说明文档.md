# 版本、环境、快照关系说明文档

## 文档信息

| 项目名称 | Salesforce配置管理系统 |
|---------|---------------------|
| 文档版本 | 1.0 |
| 创建日期 | 2025-12-26 |
| 作者 | datai |
| 文档状态 | 正式发布 |

---

## 1. 核心概念

### 1.1 环境

**定义**：配置的隔离容器，支持多环境部署

**作用**：
- 提供配置隔离，确保不同环境的配置互不干扰
- 支持开发、测试、生产等多环境管理
- 便于配置在不同环境间的迁移和同步

**示例**：
- 开发环境
- 测试环境
- 生产环境

**实体类**：[DataiConfigEnvironment](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigEnvironment.java)

**关键字段**：
- `id`：环境ID（主键）
- `environmentName`：环境名称
- `environmentCode`：环境编码（唯一）
- `isActive`：是否激活

### 1.2 配置

**定义**：具体的配置项，存储键值对形式的配置信息

**作用**：
- 存储具体的配置数据
- 记录配置的当前状态
- 支持配置的动态更新

**示例**：
- 数据库连接配置
- API密钥配置
- 缓存配置

**实体类**：[DataiConfiguration](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfiguration.java)

**关键字段**：
- `id`：配置ID（主键）
- `configKey`：配置键
- `configValue`：配置值
- `environmentId`：所属环境ID（外键）
- `version`：配置版本号

### 1.3 快照

**定义**：某个时间点配置状态的完整备份

**作用**：
- 记录配置的历史状态
- 支持配置的快速恢复
- 提供配置变更的可追溯性

**特点**：
- 以JSON格式存储所有配置项
- 记录快照时间和配置数量
- 可独立创建和删除

**实体类**：[DataiConfigSnapshot](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigSnapshot.java)

**关键字段**：
- `id`：快照ID（主键）
- `environmentId`：所属环境ID（外键）
- `versionId`：关联版本ID（外键）
- `snapshotContent`：快照内容（JSON格式）
- `configCount`：配置数量
- `snapshotTime`：快照时间

### 1.4 版本

**定义**：可发布的配置单元，关联快照和元数据

**作用**：
- 管理配置的完整生命周期
- 支持版本发布和回滚
- 提供版本状态管理

**特点**：
- 有版本号标识
- 有版本状态流转
- 关联一个快照

**实体类**：[DataiConfigVersion](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigVersion.java)

**关键字段**：
- `id`：版本ID（主键）
- `environmentId`：所属环境ID（外键）
- `versionNumber`：版本号
- `versionDesc`：版本描述
- `snapshotId`：关联快照ID（外键）
- `status`：版本状态
- `publishStatus`：发布状态

---

## 2. 关系图解

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                     环境层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  开发环境   │  │  测试环境   │  │  生产环境   │    │
│  │  (env_id=1) │  │  (env_id=2) │  │  (env_id=3) │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
└─────────┼────────────────┼────────────────┼───────────┘
          │                │                │
          │ 配置项          │ 配置项          │ 配置项
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────┐
│                     配置层                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │ configKey: db.url  configValue: localhost:3306   │  │
│  │ configKey: api.key  configValue: test_key_123    │  │
│  │ configKey: cache.ttl  configValue: 3600          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ 创建快照
                          ▼
┌─────────────────────────────────────────────────────────┐
│                     快照层                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 快照ID: snapshot_001                            │  │
│  │ 快照时间: 2025-12-26 10:00:00                  │  │
│  │ 快照内容: [JSON格式的所有配置项]                 │  │
│  │ 配置数量: 50                                     │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          │ 关联版本
                          ▼
┌─────────────────────────────────────────────────────────┐
│                     版本层                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 版本ID: version_001                               │  │
│  │ 版本号: 1.0.0                                     │  │
│  │ 版本描述: 初始版本                                 │  │
│  │ 状态: 已发布                                      │  │
│  │ 发布时间: 2025-12-26 10:05:00                    │  │
│  │ 关联快照: snapshot_001                           │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 数据库关系图

```
┌─────────────────────────┐
│ datai_config_environment │
├─────────────────────────┤
│ id (PK)                 │
│ environmentName         │
│ environmentCode         │
│ isActive               │
└──────────┬──────────────┘
           │ 1
           │
           │ N
┌──────────▼──────────────┐       ┌─────────────────────────┐
│  datai_configuration    │       │  datai_config_version   │
├─────────────────────────┤       ├─────────────────────────┤
│ id (PK)                 │       │ id (PK)                 │
│ configKey               │       │ environmentId (FK)      │
│ configValue             │       │ versionNumber           │
│ environmentId (FK)      │◄──────│ versionDesc             │
│ version                 │       │ snapshotId (FK)        │
└─────────────────────────┘       │ status                  │
                                   │ publishStatus          │
                                   └──────────┬──────────────┘
                                              │ 1
                                              │
                                              │ 1
                                   ┌──────────▼──────────────┐
                                   │  datai_config_snapshot  │
                                   ├─────────────────────────┤
                                   │ id (PK)                 │
                                   │ environmentId (FK)      │
                                   │ versionId (FK)          │
                                   │ snapshotContent (JSON)  │
                                   │ configCount             │
                                   └─────────────────────────┘
```

---

## 3. 详细关系说明

### 3.1 环境与配置的关系

**关系类型**：一对多（1:N）

**关系描述**：
- 一个环境包含多个配置项
- 一个配置项只能属于一个环境

**实体关联**：
```
DataiConfiguration.environmentId → DataiConfigEnvironment.id
```

**示例**：
```
开发环境 (id=1)
  ├── configKey: db.url, configValue: localhost:3306
  ├── configKey: api.key, configValue: dev_key_123
  └── configKey: cache.ttl, configValue: 3600
```

**业务规则**：
1. 配置项必须属于某个环境
2. 同一环境下，配置键不能重复
3. 不同环境下，相同配置键可以有不同的配置值
4. 环境删除时，需要先删除或迁移该环境下的所有配置

### 3.2 环境与快照的关系

**关系类型**：一对多（1:N）

**关系描述**：
- 一个环境可以有多个快照
- 一个快照只能属于一个环境

**实体关联**：
```
DataiConfigSnapshot.environmentId → DataiConfigEnvironment.id
```

**示例**：
```
开发环境 (id=1)
  ├── 快照1 (2025-12-26 10:00:00) - 50个配置项
  ├── 快照2 (2025-12-26 14:00:00) - 52个配置项
  └── 快照3 (2025-12-26 18:00:00) - 48个配置项
```

**业务规则**：
1. 快照必须属于某个环境
2. 快照记录创建时该环境的所有配置项状态
3. 环境删除时，需要先删除该环境下的所有快照
4. 快照可以独立删除，不影响其他快照

### 3.3 环境与版本的关系

**关系类型**：一对多（1:N）

**关系描述**：
- 一个环境可以有多个版本
- 一个版本只能属于一个环境

**实体关联**：
```
DataiConfigVersion.environmentId → DataiConfigEnvironment.id
```

**示例**：
```
开发环境 (id=1)
  ├── 版本1.0.0 - 初始版本
  ├── 版本1.0.1 - 新增API配置
  └── 版本1.1.0 - 数据库配置优化
```

**业务规则**：
1. 版本必须属于某个环境
2. 同一环境下的版本号不能重复
3. 版本号遵循语义化版本规范（主版本.次版本.修订号）
4. 版本可以发布、废弃，但不能删除（保留历史）

### 3.4 版本与快照的关系

**关系类型**：一对一（1:1）

**关系描述**：
- 一个版本关联一个快照
- 一个快照可以被多个版本引用（但通常是一对一）

**实体关联**：
```
DataiConfigVersion.snapshotId → DataiConfigSnapshot.id
DataiConfigSnapshot.versionId → DataiConfigVersion.id
```

**示例**：
```
版本1.0.0 (version_id=1)
  └── 关联快照 snapshot_001

快照 snapshot_001
  └── 被版本1.0.0引用
```

**业务规则**：
1. 版本创建时自动生成快照
2. 版本和快照是一一对应的关系
3. 版本删除时，关联的快照可以选择保留或删除
4. 快照可以独立存在，不依赖版本

### 3.5 配置与快照的关系

**关系类型**：一对多（1:N）

**关系描述**：
- 一个快照包含多个配置项
- 一个配置项可以被多个快照包含

**数据存储**：
快照的 `snapshotContent` 字段以JSON格式存储所有配置项

**示例**：
```
快照 snapshot_001
  ├── configKey: db.url, configValue: localhost:3306
  ├── configKey: api.key, configValue: dev_key_123
  └── configKey: cache.ttl, configValue: 3600
```

**业务规则**：
1. 快照以JSON格式存储配置项的完整信息
2. 快照包含配置键、配置值、描述等所有字段
3. 快照是配置项的只读副本，不影响当前配置
4. 恢复快照时，会用快照中的配置项覆盖当前配置

### 3.6 配置与版本的关系

**关系类型**：间接关系

**关系描述**：
- 配置项本身有 `version` 字段，记录配置项的版本号
- 版本通过快照间接包含配置项

**示例**：
```
配置项 db.url
  ├── version: 1 (初始版本)
  ├── version: 2 (修改后)
  └── version: 3 (再次修改)
```

**业务规则**：
1. 配置项的 `version` 字段记录该配置项的修改次数
2. 版本通过快照包含配置项的某个时间点状态
3. 配置项的版本号与配置版本号是两个不同的概念
4. 配置项的版本号用于追踪单个配置项的变更历史

---

## 4. 实际业务场景

### 4.1 多环境配置管理

**场景描述**：在开发、测试、生产三个环境中管理不同的配置

**流程**：
```
开发环境 (env_id=1)
  ├── 配置：db.url = localhost:3306
  ├── 快照：snapshot_dev_001
  └── 版本：v1.0.0 (开发版)

测试环境 (env_id=2)
  ├── 配置：db.url = test-db.example.com:3306
  ├── 快照：snapshot_test_001
  └── 版本：v1.0.0 (测试版)

生产环境 (env_id=3)
  ├── 配置：db.url = prod-db.example.com:3306
  ├── 快照：snapshot_prod_001
  └── 版本：v1.0.0 (生产版)
```

**关键点**：
- 每个环境有独立的配置集
- 相同配置键在不同环境下有不同的配置值
- 版本号可以相同，但快照内容不同

### 4.2 版本发布流程

**场景描述**：将配置从开发环境发布到测试环境，再到生产环境

**流程**：
```
1. 在开发环境修改配置
   开发环境 → 配置更新 → 创建快照 snapshot_dev_002

2. 创建版本
   版本 v1.0.1 → 关联快照 snapshot_dev_002

3. 发布到测试环境
   版本 v1.0.1 → 应用到测试环境 → 创建快照 snapshot_test_002

4. 发布到生产环境
   版本 v1.0.1 → 应用到生产环境 → 创建快照 snapshot_prod_002
```

**关键点**：
- 版本在环境间迁移时，会创建新的快照
- 每个环境都有自己独立的快照记录
- 版本号保持一致，便于追踪

### 4.3 配置回滚

**场景描述**：新版本配置出现问题，需要回滚到上一个稳定版本

**流程**：
```
当前状态：
  生产环境 → 版本 v1.1.0 → 快照 snapshot_prod_003

发现问题后回滚：
  生产环境 → 版本 v1.0.0 → 快照 snapshot_prod_001

回滚操作：
  1. 查询历史版本列表
  2. 选择目标版本 v1.0.0
  3. 从快照 snapshot_prod_001 恢复配置
  4. 更新环境配置
  5. 记录回滚日志
```

**关键点**：
- 回滚操作基于历史版本
- 回滚会创建新的快照记录
- 回滚操作需要权限验证和审计日志

### 4.4 配置对比

**场景描述**：比较两个版本之间的配置差异

**流程**：
```
1. 选择两个版本
   版本 v1.0.0 → 快照 snapshot_001
   版本 v1.1.0 → 快照 snapshot_002

2. 解析快照内容
   快照 snapshot_001 → 配置列表1
   快照 snapshot_002 → 配置列表2

3. 比较配置差异
   ├── 新增配置项：在快照2中存在但在快照1中不存在
   ├── 删除配置项：在快照1中存在但在快照2中不存在
   ├── 修改配置项：在两个快照中都存在但值不同
   └── 未改变配置项：在两个快照中都存在且值相同

4. 生成差异报告
   返回详细的差异信息和统计摘要
```

**关键点**：
- 比较基于快照的配置内容
- 差异报告包含配置键、配置值、描述等信息
- 支持按配置键、操作类型等条件过滤

---

## 5. 数据模型总结

### 5.1 实体关系矩阵

| 实体A | 实体B | 关系类型 | 关系描述 |
|-------|-------|---------|---------|
| 环境 | 配置 | 1:N | 一个环境包含多个配置项 |
| 环境 | 快照 | 1:N | 一个环境可以有多个快照 |
| 环境 | 版本 | 1:N | 一个环境可以有多个版本 |
| 版本 | 快照 | 1:1 | 一个版本关联一个快照 |
| 配置 | 快照 | 1:N | 一个快照包含多个配置项 |
| 配置 | 版本 | 间接 | 配置通过快照与版本关联 |

### 5.2 核心字段映射

| 实体 | 关键字段 | 关联实体 | 关联字段 |
|------|---------|---------|---------|
| DataiConfiguration | environmentId | DataiConfigEnvironment | id |
| DataiConfigSnapshot | environmentId | DataiConfigEnvironment | id |
| DataiConfigSnapshot | versionId | DataiConfigVersion | id |
| DataiConfigVersion | environmentId | DataiConfigEnvironment | id |
| DataiConfigVersion | snapshotId | DataiConfigSnapshot | id |

### 5.3 状态流转

#### 版本状态流转
```
已创建 (CREATED) → 已发布 (PUBLISHED) → 已废弃 (DEPRECATED)
                ↓
            已回滚 (ROLLED_BACK)
```

#### 发布状态流转
```
未发布 (UNPUBLISHED) → 已发布 (PUBLISHED)
```

---

## 6. API接口说明

### 6.1 环境管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 查询环境列表 | GET | /setting/environment/list | 查询所有环境 |
| 获取环境详情 | GET | /setting/environment/{id} | 获取指定环境详情 |
| 新增环境 | POST | /setting/environment | 新增环境 |
| 修改环境 | PUT | /setting/environment | 修改环境信息 |
| 删除环境 | DELETE | /setting/environment/{ids} | 删除环境 |

### 6.2 配置管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 查询配置列表 | GET | /setting/config/list | 查询配置列表 |
| 获取配置详情 | GET | /setting/config/{id} | 获取指定配置详情 |
| 新增配置 | POST | /setting/config | 新增配置 |
| 修改配置 | PUT | /setting/config | 修改配置 |
| 删除配置 | DELETE | /setting/config/{ids} | 删除配置 |
| 刷新配置缓存 | POST | /setting/config/refresh | 刷新配置缓存 |

### 6.3 快照管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 查询快照列表 | GET | /setting/snapshot/list | 查询快照列表 |
| 获取快照详情 | GET | /setting/snapshot/{id} | 获取指定快照详情 |
| 创建快照 | POST | /setting/snapshot/create | 从当前配置生成快照 |
| 恢复快照 | POST | /setting/snapshot/{snapshotId}/restore | 恢复快照 |
| 获取快照详细信息 | GET | /setting/snapshot/{snapshotId}/detail | 获取快照详细信息（包含配置内容） |
| 比较快照差异 | GET | /setting/snapshot/{snapshotId1}/compare/{snapshotId2} | 比较两个快照的差异 |

### 6.4 版本管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 查询版本列表 | GET | /setting/version/list | 查询版本列表 |
| 获取版本详情 | GET | /setting/version/{id} | 获取指定版本详情 |
| 创建版本 | POST | /setting/version/create | 创建版本（自动生成快照） |
| 发布版本 | POST | /setting/version/{versionId}/publish | 发布版本 |
| 回滚版本 | POST | /setting/version/{versionId}/rollback | 回滚到指定版本 |
| 获取版本快照详情 | GET | /setting/version/{versionId}/snapshot | 获取版本关联的快照详情 |
| 比较版本差异 | GET | /setting/version/{versionId1}/compare/{versionId2} | 比较两个版本的配置差异 |

---

## 7. 总结

### 7.1 核心概念对比

| 概念 | 主要作用 | 关键特征 | 生命周期 |
|------|---------|---------|---------|
| **环境** | 配置隔离 | 多环境支持，配置独立 | 长期存在 |
| **配置** | 具体配置项 | 键值对存储，属于某个环境 | 动态更新 |
| **快照** | 配置备份 | JSON存储，时间点快照 | 可独立创建和删除 |
| **版本** | 可发布单元 | 版本号管理，状态流转 | 长期保留 |

### 7.2 核心关系总结

1. **环境是配置的容器**：每个环境有独立的配置集
2. **快照是配置的备份**：记录某个时间点的配置状态
3. **版本是快照的业务包装**：提供版本号、状态等业务属性
4. **通过版本管理实现配置的可追溯和可回滚**

### 7.3 设计优势

1. **多环境隔离**：支持开发、测试、生产等多环境配置管理
2. **版本控制**：提供完整的版本管理功能，支持版本发布和回滚
3. **快照备份**：提供配置快照功能，支持配置的快速恢复
4. **审计追踪**：记录所有配置变更操作，满足合规性要求
5. **灵活扩展**：支持新增配置项类型和验证规则

### 7.4 使用建议

1. **环境规划**：根据实际业务需求规划环境数量和类型
2. **版本管理**：遵循语义化版本规范，合理规划版本号
3. **快照策略**：在关键操作前创建快照，便于快速恢复
4. **权限控制**：严格控制版本发布和回滚权限
5. **审计日志**：定期审计配置变更记录，确保系统安全

---

## 附录

### A. 相关文档

- [业务需求规格说明书](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/resources/doc/业务需求规格说明书.md)
- [Domain实体类作用说明文档](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/resources/doc/Domain实体类作用说明文档.md)
- [类关系说明文档](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/resources/doc/类关系说明文档.md)

### B. 实体类文件

- [DataiConfigEnvironment](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigEnvironment.java)
- [DataiConfiguration](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfiguration.java)
- [DataiConfigSnapshot](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigSnapshot.java)
- [DataiConfigVersion](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/domain/DataiConfigVersion.java)

### C. 服务类文件

- [IDataiConfigEnvironmentService](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/service/IDataiConfigEnvironmentService.java)
- [IDataiConfigurationService](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/service/IDataiConfigurationService.java)
- [IDataiConfigSnapshotService](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/service/IDataiConfigSnapshotService.java)
- [IDataiConfigVersionService](file:///d:/idea_demo/datai/datai-scenes/datai-scene-salesforce/datai-salesforce-setting/src/main/java/com/datai/setting/service/IDataiConfigVersionService.java)

---

**文档结束**
