# Salesforce配置管理系统 - 需要增加的方法清单

## 文档信息

| 项目名称 | Salesforce配置管理系统 |
|---------|---------------------|
| 文档版本 | 1.0 |
| 创建日期 | 2025-12-26 |
| 作者 | datai |
| 文档状态 | 正式发布 |

---

## 1. 概述

本文档基于业务需求规格说明书和现有Controller代码分析，列出了Salesforce配置管理模块需要补充实现的方法清单。这些方法涵盖了配置管理、版本管理、快照管理、审计日志、环境管理和事件管理等核心功能。

---

## 2. DataiConfigurationController（配置管理）需要增加

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | validateConfig | POST | /setting/configuration/validate | 验证配置值合法性，包括格式验证、范围验证、业务规则验证 | 高 | 2.2 配置更新流程需求 |
| 2 | batchUpdate | POST | /setting/configuration/batch | 批量更新配置，支持事务处理 | 中 | 2.2 配置更新流程需求 |
| 3 | getConfigHistory | GET | /setting/configuration/{id}/history | 查询指定配置的变更历史记录 | 中 | 2.6 配置审计日志流程需求 |
| 4 | exportConfigs | POST | /setting/configuration/export | 导出配置文件（JSON/CSV格式） | 低 | 配置管理增强功能 |
| 5 | importConfigs | POST | /setting/configuration/import | 导入配置文件，支持覆盖和合并模式 | 低 | 配置管理增强功能 |

### 2.1 方法详细说明

#### 2.1.1 validateConfig - 配置验证

**功能描述**：验证配置值的合法性，确保配置符合预期格式和业务规则

**请求参数**：
```json
{
  "configKey": "salesforce.api.version",
  "configValue": "61.0",
  "environmentId": 1
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "验证通过",
  "data": {
    "valid": true,
    "errors": []
  }
}
```

**验证规则**：
- 数据类型验证（字符串、数字、布尔值等）
- 格式验证（URL格式、邮箱格式、端口号范围等）
- 业务规则验证（基于配置键的特定验证逻辑）
- 敏感配置加密验证

---

#### 2.1.2 batchUpdate - 批量更新配置

**功能描述**：批量更新多个配置项，支持事务处理，确保数据一致性

**请求参数**：
```json
{
  "configs": [
    {
      "id": 1,
      "configValue": "61.0"
    },
    {
      "id": 2,
      "configValue": "https://test.salesforce.com"
    }
  ],
  "updateReason": "API版本升级"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "批量更新成功",
  "data": {
    "successCount": 2,
    "failureCount": 0,
    "errors": []
  }
}
```

**业务规则**：
- 使用事务确保所有配置更新要么全部成功，要么全部回滚
- 更新时自动递增配置版本号
- 更新缓存和数据库，确保一致性
- 记录审计日志

---

#### 2.1.3 getConfigHistory - 查询配置变更历史

**功能描述**：查询指定配置项的变更历史记录，支持分页查询

**请求参数**：
- `id`: 配置ID
- `pageNum`: 页码
- `pageSize`: 每页数量

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "total": 10,
    "rows": [
      {
        "id": 1,
        "configKey": "salesforce.api.version",
        "oldValue": "60.0",
        "newValue": "61.0",
        "operator": "admin",
        "operationTime": "2025-12-26 10:00:00",
        "version": 2
      }
    ]
  }
}
```

---

## 3. DataiConfigVersionController（配置版本）需要增加

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | createVersion | POST | /setting/version/create | 创建版本，自动生成配置快照 | 高 | 2.4 配置版本管理流程需求 |
| 2 | publishVersion | POST | /setting/version/{versionId}/publish | 发布版本，将版本标记为当前生效版本 | 高 | 2.4 配置版本管理流程需求 |
| 3 | rollbackVersion | POST | /setting/version/{versionId}/rollback | 回滚到指定版本 | 高 | 2.5 配置回滚流程需求 |
| 4 | getVersionSnapshot | GET | /setting/version/{versionId}/snapshot | 获取版本关联的快照详情 | 中 | 版本管理增强功能 |
| 5 | compareVersions | GET | /setting/version/{versionId1}/compare/{versionId2} | 比较两个版本的配置差异 | 中 | 版本管理增强功能 |

### 3.1 方法详细说明

#### 3.1.1 createVersion - 创建版本

**功能描述**：创建配置版本，自动生成当前所有配置的快照

**请求参数**：
```json
{
  "versionDesc": "API版本升级到61.0",
  "environmentId": 1
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "版本创建成功",
  "data": {
    "id": 1,
    "versionNumber": "1.0.1",
    "versionDesc": "API版本升级到61.0",
    "status": "CREATED",
    "snapshotId": "uuid-xxx",
    "createTime": "2025-12-26 10:00:00",
    "createBy": "admin"
  }
}
```

**业务规则**：
- 自动生成版本号（主版本号.次版本号.修订号）
- 自动创建配置快照，记录当前所有配置项状态
- 版本初始状态为"已创建"（CREATED）
- 记录版本创建时间和创建人
- 记录审计日志

---

#### 3.1.2 publishVersion - 发布版本

**功能描述**：将指定版本标记为当前生效版本，应用配置快照

**请求参数**：
- `versionId`: 版本ID

**响应示例**：
```json
{
  "code": 200,
  "msg": "版本发布成功",
  "data": {
    "versionId": 1,
    "status": "PUBLISHED",
    "publishTime": "2025-12-26 10:00:00"
  }
}
```

**业务规则**：
- 验证版本是否存在且状态为"已创建"
- 更新版本状态为"已发布"（PUBLISHED）
- 记录发布时间
- 刷新配置缓存
- 记录审计日志

---

#### 3.1.3 rollbackVersion - 回滚版本

**功能描述**：将配置恢复到指定历史版本

**请求参数**：
```json
{
  "versionId": 1,
  "rollbackReason": "配置错误回滚"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "版本回滚成功",
  "data": {
    "versionId": 1,
    "rollbackTime": "2025-12-26 10:00:00",
    "configCount": 100
  }
}
```

**业务规则**：
- 验证回滚权限
- 验证目标版本是否存在且已发布
- 从快照中恢复配置数据
- 同时更新缓存和数据库
- 发布回滚事件
- 记录审计日志

---

#### 3.1.4 compareVersions - 比较版本差异

**功能描述**：比较两个版本之间的配置差异

**请求参数**：
- `versionId1`: 版本ID1
- `versionId2`: 版本ID2

**响应示例**：
```json
{
  "code": 200,
  "msg": "比较成功",
  "data": {
    "version1": {
      "versionNumber": "1.0.1",
      "snapshotId": "uuid-xxx"
    },
    "version2": {
      "versionNumber": "1.0.2",
      "snapshotId": "uuid-yyy"
    },
    "differences": [
      {
        "configKey": "salesforce.api.version",
        "value1": "60.0",
        "value2": "61.0",
        "changeType": "MODIFIED"
      }
    ]
  }
}
```

---

## 4. DataiConfigSnapshotController（配置快照）需要增加

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | createSnapshot | POST | /setting/snapshot/create | 从当前配置生成快照 | 高 | 2.4 配置版本管理流程需求 |
| 2 | restoreSnapshot | POST | /setting/snapshot/{snapshotId}/restore | 恢复快照 | 高 | 2.5 配置回滚流程需求 |
| 3 | getSnapshotDetail | GET | /setting/snapshot/{snapshotId}/detail | 获取快照详细信息（包含配置内容） | 中 | 快照管理增强功能 |
| 4 | compareSnapshots | GET | /setting/snapshot/{snapshotId1}/compare/{snapshotId2} | 比较两个快照的差异 | 中 | 快照管理增强功能 |

### 4.1 方法详细说明

#### 4.1.1 createSnapshot - 创建快照

**功能描述**：从当前所有配置生成快照

**请求参数**：
```json
{
  "snapshotName": "API升级前快照",
  "environmentId": 1,
  "description": "升级API版本前的配置备份"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "快照创建成功",
  "data": {
    "id": "uuid-xxx",
    "snapshotName": "API升级前快照",
    "snapshotTime": "2025-12-26 10:00:00",
    "configCount": 100,
    "snapshotSize": "10KB"
  }
}
```

**业务规则**：
- 完整记录当前所有配置项的状态
- 快照包含配置键、配置值、环境信息等
- 快照以JSON格式存储
- 支持快照的压缩存储
- 记录快照创建时间和创建人

---

#### 4.1.2 restoreSnapshot - 恢复快照

**功能描述**：将配置恢复到指定快照的状态

**请求参数**：
```json
{
  "snapshotId": "uuid-xxx",
  "restoreReason": "配置错误恢复"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "快照恢复成功",
  "data": {
    "snapshotId": "uuid-xxx",
    "restoreTime": "2025-12-26 10:00:00",
    "configCount": 100
  }
}
```

**业务规则**：
- 验证快照是否存在
- 解析配置快照
- 验证快照的完整性
- 恢复配置到快照状态
- 同时更新缓存和数据库
- 记录审计日志

---

#### 4.1.3 getSnapshotDetail - 获取快照详情

**功能描述**：获取快照的详细信息，包含完整的配置内容

**请求参数**：
- `snapshotId`: 快照ID

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "id": "uuid-xxx",
    "snapshotName": "API升级前快照",
    "snapshotTime": "2025-12-26 10:00:00",
    "environmentId": 1,
    "configCount": 100,
    "configs": [
      {
        "configKey": "salesforce.api.version",
        "configValue": "60.0",
        "description": "Salesforce API版本"
      }
    ]
  }
}
```

---

## 5. DataiConfigAuditLogController（审计日志）需要增加

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | getLogDetail | GET | /setting/log/{id}/detail | 获取审计日志详细信息 | 中 | 2.6 配置审计日志流程需求 |
| 2 | getLogStatistics | GET | /setting/log/statistics | 获取审计日志统计信息 | 低 | 审计日志增强功能 |
| 3 | exportLogsByCondition | POST | /setting/log/export/byCondition | 按条件导出审计日志 | 低 | 2.6 配置审计日志流程需求 |

### 5.1 方法详细说明

#### 5.1.1 getLogDetail - 获取审计日志详情

**功能描述**：获取审计日志的详细信息，包括变更内容的完整记录

**请求参数**：
- `id`: 审计日志ID

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "id": 1,
    "operationType": "UPDATE",
    "objectType": "CONFIG",
    "objectId": 1,
    "oldValue": "60.0",
    "newValue": "61.0",
    "operator": "admin",
    "operationTime": "2025-12-26 10:00:00",
    "ipAddress": "192.168.1.1",
    "userAgent": "Mozilla/5.0",
    "requestId": "req-xxx",
    "result": "SUCCESS",
    "errorMessage": null
  }
}
```

---

#### 5.1.2 getLogStatistics - 获取审计日志统计

**功能描述**：获取审计日志的统计信息，包括操作类型分布、操作人统计等

**请求参数**：
- `startTime`: 开始时间
- `endTime`: 结束时间

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "totalCount": 1000,
    "operationTypeStats": [
      {
        "operationType": "UPDATE",
        "count": 500
      },
      {
        "operationType": "CREATE",
        "count": 300
      }
    ],
    "operatorStats": [
      {
        "operator": "admin",
        "count": 800
      }
    ]
  }
}
```

---

## 6. DataiConfigEnvironmentController（配置环境）需要增加

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | getEnvironmentConfigs | GET | /setting/environment/{environmentId}/configs | 获取指定环境的所有配置 | 中 | 2.1 配置加载流程需求 |
| 2 | copyEnvironmentConfigs | POST | /setting/environment/{sourceId}/copy/{targetId} | 复制环境配置 | 中 | 环境管理增强功能 |

### 6.1 方法详细说明

#### 6.1.1 getEnvironmentConfigs - 获取环境配置

**功能描述**：获取指定环境的所有配置项

**请求参数**：
- `environmentId`: 环境ID
- `pageNum`: 页码
- `pageSize`: 每页数量

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "environment": {
      "id": 1,
      "environmentName": "开发环境",
      "environmentCode": "DEV"
    },
    "configs": [
      {
        "id": 1,
        "configKey": "salesforce.api.version",
        "configValue": "60.0",
        "description": "Salesforce API版本"
      }
    ]
  }
}
```

---

#### 6.1.2 copyEnvironmentConfigs - 复制环境配置

**功能描述**：将源环境的配置复制到目标环境

**请求参数**：
```json
{
  "sourceId": 1,
  "targetId": 2,
  "copyMode": "OVERWRITE"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置复制成功",
  "data": {
    "sourceEnvironment": "开发环境",
    "targetEnvironment": "测试环境",
    "copiedCount": 100
  }
}
```

**复制模式**：
- `OVERWRITE`: 覆盖目标环境已有配置
- `MERGE`: 合并配置，保留目标环境已有配置
- `NEW_ONLY`: 仅复制目标环境不存在的配置

---

## 7. ConfigEventController（配置变更事件管理）- 新增Controller

| 序号 | 方法名 | HTTP方法 | 路径 | 功能描述 | 优先级 | 业务需求 |
|-----|--------|---------|------|---------|--------|---------|
| 1 | publishEvent | POST | /setting/event/publish | 发布配置变更事件 | 高 | 2.3 配置变更事件处理流程需求 |
| 2 | getEventListeners | GET | /setting/event/listeners | 获取事件监听器列表 | 中 | 2.3 配置变更事件处理流程需求 |
| 3 | registerListener | POST | /setting/event/listener/register | 注册事件监听器 | 中 | 2.3 配置变更事件处理流程需求 |
| 4 | unregisterListener | DELETE | /setting/event/listener/{listenerId} | 注销事件监听器 | 中 | 2.3 配置变更事件处理流程需求 |

### 7.1 Controller定义

```java
package com.datai.setting.controller;

import org.springframework.web.bind.annotation.*;

/**
 * 配置变更事件Controller
 * 
 * @author datai
 * @date 2025-12-26
 */
@RestController
@RequestMapping("/setting/event")
@Tag(name = "【配置变更事件】管理")
public class ConfigEventController extends BaseController {
    
    @Autowired
    private IConfigEventService configEventService;
    
    // 方法实现...
}
```

### 7.2 方法详细说明

#### 7.2.1 publishEvent - 发布事件

**功能描述**：发布配置变更事件，通知相关服务配置已更新

**请求参数**：
```json
{
  "eventType": "CONFIG_UPDATE",
  "configKey": "salesforce.api.version",
  "oldValue": "60.0",
  "newValue": "61.0",
  "environmentId": 1
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "事件发布成功",
  "data": {
    "eventId": "evt-xxx",
    "publishTime": "2025-12-26 10:00:00",
    "listenerCount": 5
  }
}
```

**业务规则**：
- 支持同步和异步事件发布
- 事件包含配置变更的详细信息
- 通知相关服务配置已更新
- 事件发布失败时记录日志

---

#### 7.2.2 getEventListeners - 获取事件监听器

**功能描述**：获取所有已注册的事件监听器列表

**请求参数**：
- `eventType`: 事件类型（可选）

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "listeners": [
      {
        "listenerId": "lst-xxx",
        "listenerName": "SalesforceConnector",
        "eventType": "CONFIG_UPDATE",
        "priority": 1,
        "status": "ACTIVE"
      }
    ]
  }
}
```

---

#### 7.2.3 registerListener - 注册监听器

**功能描述**：注册新的事件监听器

**请求参数**：
```json
{
  "listenerName": "SalesforceConnector",
  "eventType": "CONFIG_UPDATE",
  "priority": 1,
  "listenerClass": "com.datai.listener.SalesforceConfigListener"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "监听器注册成功",
  "data": {
    "listenerId": "lst-xxx",
    "registerTime": "2025-12-26 10:00:00"
  }
}
```

---

## 8. 优先级说明

### 8.1 高优先级（核心功能，必须实现）

高优先级功能是业务需求文档中明确要求的核心功能，必须优先实现：

1. **版本管理核心功能**：
   - 创建版本（createVersion）- 自动生成快照
   - 发布版本（publishVersion）- 标记为当前生效版本
   - 回滚版本（rollbackVersion）- 恢复到历史版本

2. **快照管理核心功能**：
   - 创建快照（createSnapshot）- 从当前配置生成快照
   - 恢复快照（restoreSnapshot）- 恢复到快照状态

3. **配置验证功能**：
   - 验证配置（validateConfig）- 确保配置值合法性

4. **配置变更事件处理**：
   - 发布事件（publishEvent）- 通知相关服务配置已更新

### 8.2 中优先级（重要功能，建议实现）

中优先级功能是重要的增强功能，建议在实现高优先级功能后补充：

1. **版本和快照比较功能**：
   - 比较版本差异（compareVersions）
   - 比较快照差异（compareSnapshots）
   - 获取版本快照（getVersionSnapshot）
   - 获取快照详情（getSnapshotDetail）

2. **配置变更历史查询**：
   - 查询配置历史（getConfigHistory）
   - 获取审计日志详情（getLogDetail）

3. **环境配置管理**：
   - 获取环境配置（getEnvironmentConfigs）
   - 复制环境配置（copyEnvironmentConfigs）

4. **事件监听器管理**：
   - 获取事件监听器（getEventListeners）
   - 注册监听器（registerListener）
   - 注销监听器（unregisterListener）

### 8.3 低优先级（增强功能，可选实现）

低优先级功能是增强功能，可以根据实际需求选择性实现：

1. **配置导入导出功能**：
   - 导出配置（exportConfigs）
   - 导入配置（importConfigs）

2. **审计日志统计功能**：
   - 获取日志统计（getLogStatistics）
   - 按条件导出日志（exportLogsByCondition）

3. **批量操作功能**：
   - 批量更新配置（batchUpdate）

---

## 9. 关键缺失功能总结

根据业务需求文档分析，以下是最关键需要补充的功能：

### 9.1 版本管理核心功能缺失

**问题描述**：
- 缺少自动创建版本并生成快照的功能
- 缺少版本发布功能
- 缺少版本回滚功能

**影响**：
- 无法实现配置的版本控制
- 无法追溯配置的历史变更
- 无法快速恢复到历史配置

**对应业务需求**：
- 2.4 配置版本管理流程需求
- 2.5 配置回滚流程需求

---

### 9.2 快照管理核心功能缺失

**问题描述**：
- 缺少从当前配置自动生成快照的功能
- 缺少快照恢复功能

**影响**：
- 无法创建配置的时间点备份
- 无法从快照恢复配置

**对应业务需求**：
- 2.4 配置版本管理流程需求（配置快照生成）
- 2.5 配置回滚流程需求（历史快照恢复）

---

### 9.3 配置验证功能缺失

**问题描述**：
- 缺少配置值合法性验证接口

**影响**：
- 无法确保配置值的正确性
- 可能导致系统因配置错误而异常

**对应业务需求**：
- 2.2 配置更新流程需求（配置值合法性验证）

---

### 9.4 配置变更事件处理缺失

**问题描述**：
- 缺少事件发布和监听机制
- 缺少配置变更动态生效机制

**影响**：
- 配置变更后无法通知相关服务
- 无法实现配置的动态生效

**对应业务需求**：
- 2.3 配置变更事件处理流程需求

---

## 10. 实施建议

### 10.1 实施顺序

建议按照以下顺序实施：

**第一阶段**（高优先级功能）：
1. 实现配置验证功能（validateConfig）
2. 实现快照创建和恢复功能（createSnapshot、restoreSnapshot）
3. 实现版本创建、发布和回滚功能（createVersion、publishVersion、rollbackVersion）
4. 实现事件发布功能（publishEvent）

**第二阶段**（中优先级功能）：
1. 实现版本和快照比较功能
2. 实现配置变更历史查询功能
3. 实现环境配置管理功能
4. 实现事件监听器管理功能

**第三阶段**（低优先级功能）：
1. 实现配置导入导出功能
2. 实现审计日志统计功能
3. 实现批量操作功能

### 10.2 技术要点

1. **事务处理**：确保版本创建、快照生成等操作的原子性
2. **缓存一致性**：确保配置更新、回滚等操作后缓存与数据库一致
3. **事件机制**：使用Spring Event实现配置变更事件的发布和监听
4. **权限控制**：使用Spring Security实现细粒度的API权限控制
5. **审计日志**：确保所有关键操作都记录审计日志

### 10.3 测试建议

1. **单元测试**：为每个新增方法编写单元测试
2. **集成测试**：测试版本创建、发布、回滚的完整流程
3. **性能测试**：测试快照生成和恢复的性能
4. **并发测试**：测试并发场景下的数据一致性

---

## 11. 附录

### 11.1 相关文档

- [业务需求规格说明书.md](./业务需求规格说明书.md)
- [核心功能说明文档.md](./核心功能说明文档.md)
- [模块需求文档.md](./模块需求文档.md)

### 11.2 相关代码文件

- DataiConfigurationController.java
- DataiConfigVersionController.java
- DataiConfigSnapshotController.java
- DataiConfigAuditLogController.java
- DataiConfigEnvironmentController.java

---

**文档更新时间**：2025-12-26
**文档版本**：1.0
**文档作者**：datai
**所属模块**：datai-salesforce-setting
