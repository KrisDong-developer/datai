# 自定义接口调用说明文档

## 概述

本文档详细说明了 `datai-salesforce-setting` 模块中所有自定义接口的调用方式、参数说明、响应格式及业务逻辑。

---

## 一、环境管理模块

### 1.1 切换当前环境

#### 接口信息
- **接口名称**: 切换当前环境
- **请求方式**: POST
- **请求路径**: `/setting/environment/switch`
- **权限标识**: `setting:environment:switch`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| environmentCode | String | 是 | 环境编码（如：dev、test、prod） |
| switchReason | String | 否 | 切换原因，默认为"手动切换" |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/setting/environment/switch" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "Authorization: Bearer {token}" \
  -d "environmentCode=prod&switchReason=生产环境发布"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "环境切换成功：生产环境",
  "data": null
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "环境切换失败，请检查环境编码是否正确且已激活",
  "data": null
}
```

#### 业务逻辑说明
1. 验证环境编码是否存在且已激活
2. 通过缓存管理器切换环境
3. 发布环境切换事件（`EnvironmentSwitchEvent`）
4. 记录切换日志，包括旧环境和新环境信息

#### 异常处理
- 环境编码不存在：返回错误提示
- 环境未激活：返回错误提示
- 系统异常：记录日志并返回错误信息

---

### 1.2 获取当前激活的环境

#### 接口信息
- **接口名称**: 获取当前激活的环境
- **请求方式**: GET
- **请求路径**: `/setting/environment/current`
- **权限标识**: `setting:environment:query`

#### 请求参数
无

#### 请求示例
```bash
curl -X GET "http://localhost:8080/setting/environment/current" \
  -H "Authorization: Bearer {token}"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": 1,
    "deptId": 100,
    "environmentName": "生产环境",
    "environmentCode": "prod",
    "description": "生产环境配置",
    "isActive": true,
    "remark": null,
    "createBy": "admin",
    "createTime": "2025-12-24 10:00:00",
    "updateBy": "admin",
    "updateTime": "2025-12-24 10:00:00"
  }
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "未找到当前激活的环境",
  "data": null
}
```

#### 业务逻辑说明
1. 从缓存管理器获取当前环境编码
2. 根据环境编码查询数据库获取环境详细信息
3. 返回环境对象

#### 异常处理
- 当前环境编码为空：记录警告日志并返回 null
- 未找到激活环境：记录警告日志并返回 null

---

## 二、快照管理模块

### 2.1 从当前配置生成快照

#### 接口信息
- **接口名称**: 从当前配置生成快照
- **请求方式**: POST
- **请求路径**: `/setting/snapshot/create`
- **权限标识**: `setting:snapshot:create`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| snapshotNumber | String | 是 | 快照编号 |
| environmentId | Long | 是 | 环境ID |
| remark | String | 否 | 备注/描述（此字段会被存储到快照的snapshotDesc字段中） |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/setting/snapshot/create" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "snapshotNumber": "SNAPSHOT_20251226_001",
    "environmentId": 1,
    "remark": "发布前备份"
  }'
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": "uuid-generated-id",
    "snapshotNumber": "SNAPSHOT_20251226_001",
    "environmentId": 1,
    "snapshotDesc": "发布前备份",
    "snapshotContent": "[{\"id\":1,\"configKey\":\"api.endpoint\",\"configValue\":\"https://api.example.com\",\"description\":\"API端点\",\"isActive\":true,\"version\":1,\"environmentId\":1,\"deptId\":100,\"isSensitive\":false,\"isEncrypted\":false,\"remark\":null,\"createBy\":\"admin\",\"createTime\":\"2025-12-26 15:30:00\",\"updateBy\":\"admin\",\"updateTime\":\"2025-12-26 15:30:00\"}]",
    "configCount": 25,
    "status": null,
    "versionId": null,
    "snapshotTime": "2025-12-26 15:30:00",
    "deptId": null,
    "remark": "发布前备份",
    "createBy": "admin",
    "createTime": "2025-12-26 15:30:00",
    "updateBy": "admin",
    "updateTime": "2025-12-26 15:30:00"
  }
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "创建快照失败: {错误详情}",
  "data": null
}
```

#### 业务逻辑说明
1. 根据环境ID查询当前环境的所有配置
2. 将配置列表序列化为 JSON 字符串存储
3. 创建快照对象，记录快照时间和配置数量
4. 自动记录创建人和创建时间
5. 保存到数据库并返回快照对象

#### 异常处理
- 环境ID不存在：抛出异常
- 序列化失败：记录日志并抛出异常
- 数据库操作失败：记录日志并抛出异常

---

### 2.2 恢复快照

#### 接口信息
- **接口名称**: 恢复快照
- **请求方式**: POST
- **请求路径**: `/setting/snapshot/{snapshotId}/restore`
- **权限标识**: `setting:snapshot:restore`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| snapshotId | String | 是 | 快照ID（路径参数） |
| remark | String | 否 | 恢复原因（请求体中，可选字段） |

#### 请求示例
```bash
curl -X POST "http://localhost:8080/setting/snapshot/{snapshotId}/restore" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "remark": "回滚到上一个版本"
  }'
```

**注意**：请求体中只需要包含remark字段，其他字段会被忽略。如果不需要提供恢复原因，可以发送空的JSON对象 `{}`。

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 25
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "恢复快照失败: {错误详情}",
  "data": null
}
```

#### 业务逻辑说明
1. 验证快照是否存在
2. 验证快照内容是否为空
3. 反序列化快照内容为配置列表
4. 删除当前环境的所有配置
5. 将快照中的配置插入数据库（生成新的ID）
6. 清空并重新加载配置缓存
7. 返回恢复的配置数量

#### 异常处理
- 快照不存在：抛出异常
- 快照内容为空：抛出异常
- 反序列化失败：记录日志并抛出异常
- 数据库操作失败：记录日志并抛出异常

---

### 2.3 获取快照详细信息（包含配置内容）

#### 接口信息
- **接口名称**: 获取快照详细信息
- **请求方式**: GET
- **请求路径**: `/setting/snapshot/{snapshotId}/detail`
- **权限标识**: `setting:snapshot:query`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| snapshotId | String | 是 | 快照ID（路径参数） |

#### 请求示例
```bash
curl -X GET "http://localhost:8080/setting/snapshot/{snapshotId}/detail" \
  -H "Authorization: Bearer {token}"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "id": "uuid-generated-id",
    "snapshotNumber": "SNAPSHOT_20251226_001",
    "environmentId": 1,
    "snapshotDesc": "发布前备份",
    "snapshotContent": "[{\"id\":1,\"configKey\":\"api.endpoint\",\"configValue\":\"https://api.example.com\",\"description\":\"API端点\",\"isActive\":true,\"version\":1,\"environmentId\":1,\"deptId\":100,\"isSensitive\":false,\"isEncrypted\":false,\"remark\":null,\"createBy\":\"admin\",\"createTime\":\"2025-12-26 15:30:00\",\"updateBy\":\"admin\",\"updateTime\":\"2025-12-26 15:30:00\"}]",
    "configCount": 25,
    "status": null,
    "versionId": null,
    "snapshotTime": "2025-12-26 15:30:00",
    "deptId": null,
    "remark": "发布前备份",
    "createBy": "admin",
    "createTime": "2025-12-26 15:30:00",
    "updateBy": "admin",
    "updateTime": "2025-12-26 15:30:00"
  }
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "获取快照详细信息失败: {错误详情}",
  "data": null
}
```

#### 业务逻辑说明
1. 根据快照ID查询快照详细信息
2. 返回快照对象，包含完整的快照内容（JSON 格式的配置列表）

#### 异常处理
- 快照不存在：抛出异常
- 数据库查询失败：记录日志并抛出异常

---

### 2.4 比较两个快照的差异

#### 接口信息
- **接口名称**: 比较两个快照的差异
- **请求方式**: GET
- **请求路径**: `/setting/snapshot/{snapshotId1}/compare/{snapshotId2}`
- **权限标识**: `setting:snapshot:query`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| snapshotId1 | String | 是 | 第一个快照ID（路径参数） |
| snapshotId2 | String | 是 | 第二个快照ID（路径参数） |

#### 请求示例
```bash
curl -X GET "http://localhost:8080/setting/snapshot/{snapshotId1}/compare/{snapshotId2}" \
  -H "Authorization: Bearer {token}"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": "快照差异比较报告\n====================\n快照1: SNAPSHOT_20251226_001 (2025-12-26 15:30:00)\n快照2: SNAPSHOT_20251226_002 (2025-12-26 16:00:00)\n====================\n\n配置项差异详情:\n----------------\n[新增] new.config.key\n  配置值: new.value\n  描述: 新增配置\n[删除] old.config.key\n  原配置值: old.value\n[修改] api.endpoint\n  配置值: https://api.old.com -> https://api.new.com\n\n====================\n统计摘要:\n----------------\n新增配置项: 1\n删除配置项: 1\n修改配置项: 1\n未改变配置项: 23\n总配置项变化: 3\n===================="
}
```

**失败响应**:
```json
{
  "code": 500,
  "msg": "比较快照差异失败: {错误详情}",
  "data": null
}
```

#### 业务逻辑说明
1. 验证两个快照是否存在
2. 反序列化两个快照的内容
3. 比较配置项的差异：
   - 新增：在快照2中存在但快照1中不存在的配置
   - 删除：在快照1中存在但快照2中不存在的配置
   - 修改：两个快照中都存在但值不同的配置
   - 未改变：两个快照中都存在且值相同的配置
4. 生成差异报告，包含详细信息和统计摘要

#### 异常处理
- 任一快照不存在：抛出异常
- 反序列化失败：记录日志并抛出异常
- 比较过程异常：记录日志并抛出异常

---

## 三、配置管理模块

### 3.1 刷新配置缓存

#### 接口信息
- **接口名称**: 刷新配置缓存
- **请求方式**: POST
- **请求路径**: `/setting/configuration/refresh`
- **权限标识**: `setting:configuration:refresh`

#### 请求参数
无

#### 请求示例
```bash
curl -X POST "http://localhost:8080/setting/configuration/refresh" \
  -H "Authorization: Bearer {token}"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "配置缓存刷新成功",
  "data": null
}
```

#### 业务逻辑说明
1. 调用 `resetConfigCache()` 方法
2. 清空当前环境的配置缓存
3. 从数据库重新加载配置到缓存

#### 异常处理
- 缓存操作失败：记录日志并返回错误信息

---

### 3.2 查询配置缓存状态

#### 接口信息
- **接口名称**: 查询配置缓存状态
- **请求方式**: GET
- **请求路径**: `/setting/configuration/cache`
- **权限标识**: `setting:configuration:cache`

#### 请求参数
无

#### 请求示例
```bash
curl -X GET "http://localhost:8080/setting/configuration/cache" \
  -H "Authorization: Bearer {token}"
```

#### 响应数据

**成功响应**:
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": "配置缓存状态正常"
}
```

#### 业务逻辑说明
1. 查询当前环境的配置缓存状态
2. 返回缓存状态信息

#### 异常处理
- 缓存查询失败：记录日志并返回错误信息

---

## 四、通用说明

### 4.1 认证方式
所有接口都需要在请求头中携带认证令牌：
```
Authorization: Bearer {token}
```

### 4.2 响应格式
所有接口统一使用以下响应格式：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {}
}
```

- `code`: 响应状态码（200 表示成功，其他表示失败）
- `msg`: 响应消息
- `data`: 响应数据（具体数据结构根据接口而定）

### 4.3 错误码说明
- `200`: 操作成功
- `401`: 未授权
- `403`: 无权限
- `500`: 服务器内部错误

### 4.4 分页说明
部分列表接口支持分页查询，通过以下参数控制：
- `pageNum`: 页码（从 1 开始）
- `pageSize`: 每页数量

### 4.5 日志记录
所有自定义方法都记录了详细的日志，包括：
- 操作开始日志
- 操作成功日志
- 操作失败日志（包含异常堆栈）

### 4.6 事件发布
部分操作会发布 Spring 事件：
- 环境切换：发布 `EnvironmentSwitchEvent`
- 配置变更：发布 `ConfigChangeEvent`

---

## 五、数据模型说明

### 5.1 DataiConfigEnvironment（配置环境）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 环境ID |
| deptId | Long | 部门ID |
| environmentName | String | 环境名称 |
| environmentCode | String | 环境编码 |
| description | String | 环境描述 |
| isActive | Boolean | 是否激活 |
| remark | String | 备注 |
| createBy | String | 创建人 |
| createTime | Date | 创建时间 |
| updateBy | String | 更新人 |
| updateTime | Date | 更新时间 |

### 5.2 DataiConfiguration（配置）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 配置ID |
| deptId | Long | 部门ID |
| configKey | String | 配置键 |
| configValue | String | 配置值 |
| environmentId | Long | 环境ID |
| isSensitive | Boolean | 是否敏感配置 |
| isEncrypted | Boolean | 是否加密存储 |
| description | String | 配置描述 |
| isActive | Boolean | 是否激活 |
| version | Integer | 配置版本号 |
| remark | String | 备注 |
| createBy | String | 创建人 |
| createTime | Date | 创建时间 |
| updateBy | String | 更新人 |
| updateTime | Date | 更新时间 |

### 5.3 DataiConfigSnapshot（配置快照）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | String | 快照ID |
| snapshotNumber | String | 快照编号 |
| environmentId | Long | 环境ID |
| snapshotDesc | String | 快照描述 |
| snapshotContent | String | 快照内容（JSON 格式） |
| configCount | Integer | 配置数量 |
| status | String | 快照状态 |
| versionId | Long | 版本ID |
| snapshotTime | Date | 快照时间 |
| deptId | Long | 部门ID |
| remark | String | 备注 |
| createBy | String | 创建人 |
| createTime | Date | 创建时间 |
| updateBy | String | 更新人 |
| updateTime | Date | 更新时间 |

---

## 六、使用示例

### 6.1 完整的快照管理流程

```bash
# 1. 创建快照
curl -X POST "http://localhost:8080/setting/snapshot/create" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "snapshotNumber": "SNAPSHOT_20251226_001",
    "environmentId": 1,
    "remark": "发布前备份"
  }'

# 2. 获取快照详情
curl -X GET "http://localhost:8080/setting/snapshot/{snapshotId}/detail" \
  -H "Authorization: Bearer {token}"

# 3. 比较快照差异
curl -X GET "http://localhost:8080/setting/snapshot/{snapshotId1}/compare/{snapshotId2}" \
  -H "Authorization: Bearer {token}"

# 4. 恢复快照
curl -X POST "http://localhost:8080/setting/snapshot/{snapshotId}/restore" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "remark": "回滚到上一个版本"
  }'
```

### 6.2 完整的环境切换流程

```bash
# 1. 获取当前环境
curl -X GET "http://localhost:8080/setting/environment/current" \
  -H "Authorization: Bearer {token}"

# 2. 切换环境
curl -X POST "http://localhost:8080/setting/environment/switch" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "Authorization: Bearer {token}" \
  -d "environmentCode=prod&switchReason=生产环境发布"

# 3. 刷新配置缓存
curl -X POST "http://localhost:8080/setting/configuration/refresh" \
  -H "Authorization: Bearer {token}"
```

---

## 七、注意事项

1. **快照恢复是破坏性操作**：恢复快照会删除当前环境的所有配置，请谨慎操作
2. **环境切换会影响全局**：环境切换会影响所有依赖配置的模块，建议在低峰期进行
3. **缓存一致性**：配置变更后会自动更新缓存，但在某些情况下可能需要手动刷新缓存
4. **快照内容大小**：快照内容以 JSON 格式存储，配置项过多可能导致快照过大
5. **权限控制**：所有接口都有权限控制，请确保用户具有相应的权限
6. **审计日志**：重要操作会记录审计日志，便于追溯

---

## 八、常见问题

### Q1: 快照恢复失败怎么办？
A: 请检查：
1. 快照是否存在
2. 快照内容是否完整
3. 当前环境是否有权限操作
4. 查看服务器日志获取详细错误信息

### Q2: 环境切换后配置不生效？
A: 请尝试：
1. 手动刷新配置缓存
2. 检查新环境是否有配置数据
3. 查看服务器日志确认切换是否成功

### Q3: 快照比较结果如何理解？
A: 快照比较会生成详细的差异报告，包括：
- 新增配置项：在第二个快照中新增的配置
- 删除配置项：在第二个快照中删除的配置
- 修改配置项：值发生变化的配置
- 未改变配置项：值未变化的配置

---

## 九、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-12-26 | 初始版本 |
| 1.1 | 2025-12-26 | 完善参数说明，添加DataiConfiguration实体字段说明 |

---

## 十、联系方式

如有问题，请联系开发团队。
