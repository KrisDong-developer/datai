# Salesforce配置管理模块核心功能说明文档

## 1. 模块概述

`datai-salesforce-setting` 是一个专为 Salesforce 场景设计的**集中式配置管理中心**，负责管理所有与 Salesforce 集成相关的配置信息。该模块提供配置的集中管理、版本控制、缓存优化和审计功能，确保配置的安全性、可靠性和高性能。

## 2. 核心功能详细说明

### 2.1 配置管理功能

#### 2.1.1 配置存储管理
- **功能描述**：将所有 Salesforce 相关配置集中存储在 `datai_configuration` 表中，实现配置的统一管理
- **数据结构**：
  - 配置键 (`config_key`)：唯一标识配置项
  - 配置值 (`config_value`)：配置的实际值
  - 环境ID (`environment_id`)：关联到具体环境
  - 敏感配置标识 (`is_sensitive`)：标记敏感配置
  - 加密标识 (`is_encrypted`)：标记是否加密存储
  - 激活状态 (`is_active`)：控制配置是否生效
- **访问控制**：基于权限的访问控制，不同角色拥有不同的配置操作权限

#### 2.1.2 多环境配置隔离
- **功能描述**：支持按环境（开发/测试/生产）加载差异化配置
- **实现方式**：通过 `datai_config_environment` 表定义环境，配置项关联到特定环境
- **环境管理**：提供环境的增删改查 API，支持环境状态管理
- **配置隔离**：不同环境的配置相互隔离，确保环境间配置不会相互影响

#### 2.1.3 配置CRUD操作
- **功能描述**：提供配置的完整生命周期管理
- **API接口**：
  - 查询配置列表：`GET /setting/configuration/list`
  - 新增配置：`POST /setting/configuration`
  - 修改配置：`PUT /setting/configuration`
  - 删除配置：`DELETE /setting/configuration/{ids}`
  - 获取配置详情：`GET /setting/configuration/{id}`
- **输入验证**：对配置键、值进行合法性验证，确保配置格式正确
- **敏感配置处理**：敏感配置值在存储和传输过程中进行加密处理

### 2.2 配置缓存机制

#### 2.2.1 配置缓存初始化
- **功能描述**：系统启动时自动加载配置到缓存
- **实现类**：`SalesforceConfigCacheManager`
- **初始化流程**：
  1. 系统启动时，`@PostConstruct` 注解触发 `init()` 方法
  2. 清空现有缓存
  3. 查询所有激活状态的配置
  4. 将配置存入 Redis 缓存
  5. 记录配置加载日志
- **失败处理**：初始化失败时抛出异常，确保系统在配置加载失败时无法正常启动

#### 2.2.2 缓存管理功能
- **功能描述**：管理配置缓存的生命周期
- **核心方法**：
  - `loadConfigToCache()`：将配置加载到缓存
  - `resetConfigCache()`：重置配置缓存
  - `clearConfigCache()`：清空配置缓存
  - `getConfigValue()`：从缓存获取配置值
- **缓存策略**：使用 Redis 作为缓存存储，支持高并发访问
- **缓存键**：使用 `SALESFORCE_CONFIG_CACHE_KEY` 作为缓存名称，配置键作为缓存项键

#### 2.2.3 缓存刷新机制
- **功能描述**：确保配置变更及时生效
- **刷新方式**：
  - 手动刷新：通过 `POST /setting/configuration/refresh` 接口
  - 自动刷新：配置更新时自动触发缓存刷新
- **刷新流程**：
  1. 清空现有缓存
  2. 重新加载所有激活配置
  3. 更新缓存
  4. 返回刷新结果
- **缓存状态监控**：提供 `GET /setting/configuration/cache` 接口查询缓存状态

### 2.3 配置版本管理

#### 2.3.1 版本创建与管理
- **功能描述**：管理配置的版本生命周期
- **版本状态**：
  - 已创建：配置快照已生成，但未发布
  - 已发布：配置版本已发布到生产环境
- **API接口**：
  - 查询版本列表：`GET /setting/version/list`
  - 创建版本：`POST /setting/version`
  - 删除版本：`DELETE /setting/version/{versionId}`
- **版本号规则**：支持自定义版本号，建议采用语义化版本号格式

#### 2.3.2 配置快照功能
- **功能描述**：创建配置的时间点快照，支持配置回滚
- **实现方式**：使用 `datai_config_snapshot` 表存储配置快照
- **快照内容**：完整的配置键值对集合
- **API接口**：
  - 创建快照：`POST /setting/version/snapshot`
  - 查询快照列表：`GET /setting/snapshot/list`
- **快照生成策略**：
  - 手动触发：通过API手动创建
  - 自动触发：配置版本发布时自动创建

#### 2.3.3 版本发布与回滚
- **功能描述**：支持配置版本的发布和回滚操作
- **发布流程**：
  1. 验证版本合法性
  2. 更新版本状态为已发布
  3. 记录发布时间
  4. 刷新配置缓存
- **回滚流程**：
  1. 验证回滚权限和版本合法性
  2. 从快照中恢复配置
  3. 更新数据库配置
  4. 刷新配置缓存
  5. 记录回滚日志
- **API接口**：
  - 发布版本：`POST /setting/version/{versionId}/publish`
  - 回滚版本：`POST /setting/version/{versionId}/rollback`

### 2.4 配置审计功能

#### 2.4.1 操作审计日志
- **功能描述**：记录所有配置操作，实现配置变更的可追溯性
- **记录内容**：
  - 操作类型 (`operation_type`)：如新增、修改、删除、发布、回滚等
  - 对象类型 (`object_type`)：操作的对象类型
  - 操作人 (`operator`)：执行操作的用户
  - 操作时间 (`operation_time`)：操作执行时间
  - IP地址 (`ip_address`)：操作来源IP
  - 操作结果 (`result`)：成功或失败
  - 错误信息 (`error_message`)：操作失败时的错误信息
- **存储表**：`datai_config_audit_log`
- **查询功能**：支持按操作类型、操作人、时间范围等条件查询审计日志
- **导出功能**：支持将审计日志导出为Excel格式

#### 2.4.2 审计日志API
- **查询日志列表**：`GET /setting/audit/list`
- **导出日志**：`POST /setting/audit/export`
- **查看日志详情**：`GET /setting/audit/{logId}`

### 2.5 配置验证功能

#### 2.5.1 配置值合法性验证
- **功能描述**：验证配置值的合法性，确保配置符合预期格式
- **验证规则**：
  - 数据类型验证：确保配置值符合预期的数据类型
  - 格式验证：如URL格式、邮箱格式、数字范围等
  - 业务规则验证：基于业务逻辑的验证
- **API接口**：`POST /setting/configuration/validate`
- **验证流程**：
  1. 接收配置对象
  2. 执行相应的验证规则
  3. 返回验证结果
  4. 记录验证日志

## 3. 技术实现细节

### 3.1 核心组件设计

#### 3.1.1 配置缓存管理器 (`SalesforceConfigCacheManager`)
- **作用**：管理配置缓存的加载、更新和访问
- **核心功能**：
  - 系统启动时初始化配置缓存
  - 提供配置缓存的刷新和清空功能
  - 支持从缓存中获取配置值
  - 记录配置加载日志
- **依赖**：
  - `DataiConfigurationMapper`：用于查询数据库配置
  - `CacheUtils`：封装了Redis缓存操作

#### 3.1.2 配置控制器 (`DataiConfigurationController`)
- **作用**：处理配置相关的HTTP请求
- **核心API**：
  - 配置列表查询
  - 配置详情查询
  - 配置新增
  - 配置修改
  - 配置删除
  - 缓存刷新
  - 配置验证
- **权限控制**：使用 `@PreAuthorize` 注解实现基于权限的访问控制

#### 3.1.3 配置服务 (`IDataiConfigurationService`)
- **作用**：处理配置的业务逻辑
- **核心方法**：
  - `selectDataiConfigurationList()`：查询配置列表
  - `insertDataiConfiguration()`：新增配置
  - `updateDataiConfiguration()`：修改配置
  - `deleteDataiConfigurationByIds()`：删除配置
  - `resetConfigCache()`：重置配置缓存
  - `validateConfigValue()`：验证配置值

### 3.2 数据库表结构设计

#### 3.2.1 配置表 (`datai_configuration`)
- **主键**：`id` (自增主键)
- **唯一约束**：`uk_config_key_environment` (部门ID + 配置键 + 环境ID)
- **索引**：
  - `idx_environment_id`：环境ID索引
  - `idx_config_key`：配置键索引

#### 3.2.2 配置环境表 (`datai_config_environment`)
- **主键**：`id` (自增主键)
- **唯一约束**：`uk_environment_code` (部门ID + 环境编码)
- **索引**：`idx_environment_name` (环境名称索引)

#### 3.2.3 配置版本表 (`datai_config_version`)
- **主键**：`id` (自增主键)
- **唯一约束**：`uk_version_number` (部门ID + 版本号)
- **索引**：
  - `idx_status`：版本状态索引
  - `idx_create_time`：创建时间索引

#### 3.2.4 配置快照表 (`datai_config_snapshot`)
- **主键**：`id` (UUID)
- **索引**：
  - `idx_version_id`：版本ID索引
  - `idx_snapshot_time`：快照时间索引

#### 3.2.5 配置审计日志表 (`datai_config_audit_log`)
- **主键**：`id` (自增主键)
- **索引**：
  - `idx_operation_type`：操作类型索引
  - `idx_object_type`：对象类型索引
  - `idx_operator`：操作人索引
  - `idx_operation_time`：操作时间索引
  - `idx_request_id`：请求ID索引
  - `idx_object_id`：对象ID索引

### 3.3 API接口设计

| API路径 | HTTP方法 | 功能描述 | 权限控制 |
|---------|----------|---------|----------|
| `/setting/configuration/list` | GET | 查询配置列表 | `setting:configuration:list` |
| `/setting/configuration` | POST | 新增配置 | `setting:configuration:add` |
| `/setting/configuration` | PUT | 修改配置 | `setting:configuration:edit` |
| `/setting/configuration/{id}` | DELETE | 删除配置 | `setting:configuration:remove` |
| `/setting/configuration/{id}` | GET | 获取配置详情 | `setting:configuration:query` |
| `/setting/configuration/refresh` | POST | 刷新配置缓存 | `setting:configuration:refresh` |
| `/setting/configuration/validate` | POST | 验证配置值 | `setting:configuration:validate` |
| `/setting/configuration/export` | POST | 导出配置列表 | `setting:configuration:export` |
| `/setting/version/list` | GET | 查询版本列表 | `setting:version:list` |
| `/setting/version` | POST | 创建版本 | `setting:version:add` |
| `/setting/version/{versionId}` | DELETE | 删除版本 | `setting:version:remove` |
| `/setting/version/snapshot` | POST | 创建快照 | `setting:version:snapshot` |
| `/setting/version/{versionId}/publish` | POST | 发布版本 | `setting:version:publish` |
| `/setting/version/{versionId}/rollback` | POST | 回滚版本 | `setting:version:rollback` |
| `/setting/audit/list` | GET | 查询审计日志 | `setting:audit:list` |
| `/setting/audit/export` | POST | 导出审计日志 | `setting:audit:export` |
| `/setting/audit/{logId}` | GET | 获取日志详情 | `setting:audit:query` |

## 4. 部署与运维

### 4.1 部署要求

| 依赖项 | 版本要求 |
|-------|---------|
| JDK | 11+ |
| Spring Boot | 3.5.7 |
| MySQL | 8.0+ |
| Redis | 6.0+ |

### 4.2 部署流程

1. **数据库初始化**：
   - 执行 `salesforce-config-tables.sql` 创建数据库表结构
   - 执行 `salesforce_configuration.sql` 导入初始配置数据

2. **配置文件修改**：
   - 配置数据库连接信息
   - 配置Redis连接信息
   - 配置应用端口和日志级别

3. **应用启动**：
   - 使用 `java -jar` 命令启动应用
   - 检查启动日志，确保配置加载成功

### 4.3 常见问题处理

| 问题 | 可能原因 | 解决方案 |
|-----|---------|---------|
| 配置加载失败 | 数据库连接异常 | 检查数据库连接配置和数据库服务状态 |
| 配置加载失败 | 配置表结构不正确 | 重新执行数据库初始化脚本 |
| 缓存不同步 | 配置更新后未刷新缓存 | 调用 `/setting/configuration/refresh` 接口刷新缓存 |
| 配置验证失败 | 配置值不符合验证规则 | 检查配置值是否符合预期格式和业务规则 |
| 版本回滚失败 | 版本状态不正确 | 确保回滚的版本是已发布状态 |
| 权限不足 | 用户没有相应的操作权限 | 检查用户角色和权限配置 |

## 5. 监控与日志

### 5.1 日志分类

| 日志类型 | 记录内容 | 日志级别 |
|---------|---------|---------|
| 配置加载日志 | 系统启动时配置加载过程 | INFO |
| 配置操作日志 | 配置的增删改查操作 | INFO |
| 缓存操作日志 | 缓存的刷新、清空等操作 | DEBUG |
| 错误日志 | 系统异常和错误信息 | ERROR |
| 审计日志 | 所有配置操作的详细记录 | INFO |

### 5.2 监控指标

| 指标 | 描述 | 监控方式 |
|-----|---------|---------|
| 配置加载时间 | 系统启动时配置加载耗时 | 启动日志 |
| 配置数量 | 系统中激活的配置数量 | 配置列表查询 |
| 缓存命中率 | 配置缓存的命中情况 | Redis监控 |
| 配置更新频率 | 配置的更新次数 | 审计日志统计 |
| 版本发布次数 | 配置版本的发布次数 | 版本列表统计 |

## 6. 安全设计

### 6.1 数据安全

- **敏感配置加密**：敏感配置值在存储和传输过程中进行加密处理
- **数据库访问控制**：使用最小权限原则配置数据库用户权限
- **缓存安全**：Redis缓存使用密码认证，限制访问IP

### 6.2 访问安全

- **API权限控制**：基于Spring Security实现细粒度的API权限控制
- **操作审计**：记录所有配置操作，支持审计追踪
- **IP白名单**：可配置API访问的IP白名单

### 6.3 日志安全

- **审计日志不可篡改**：审计日志一旦生成，不可修改或删除
- **日志脱敏**：敏感信息在日志中进行脱敏处理

## 7. 未来规划

1. **配置导入导出功能**：支持配置的批量导入和导出
2. **增强配置验证规则**：提供更灵活的配置验证规则定义
3. **配置变更通知**：配置变更时通知相关系统
4. **配置可视化管理界面**：提供直观的配置管理UI
5. **配置灰度发布**：支持配置的灰度发布和A/B测试
6. **配置依赖关系管理**：管理配置之间的依赖关系
7. **配置热更新**：支持配置的热更新，无需重启服务

## 8. 总结

`datai-salesforce-setting` 模块通过集中式配置管理、版本控制、缓存优化和审计功能，为 Salesforce 集成系统提供了可靠的配置管理解决方案。该模块的设计遵循了分布式架构原则，支持多环境和多租户，能够满足企业级应用的配置管理需求。

通过该模块，运维人员可以实现配置的集中管理和版本控制，开发人员可以方便地访问配置信息，系统管理员可以监控配置的使用情况和变更历史。这种设计确保了配置的安全性、可靠性和高性能，为 Salesforce 集成系统的稳定运行提供了有力保障。

---

**文档更新时间**：2025-12-25
**文档版本**：1.0
**文档作者**：TraeAI
**所属模块**：datai-salesforce-setting