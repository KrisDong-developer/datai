# Salesforce配置管理模块使用文档

## 1. 文档概述

本文档详细介绍Salesforce配置管理模块的API接口使用方法，包括配置管理、版本管理、审计日志等功能的具体操作步骤和示例。

## 2. 快速开始

### 2.1 环境准备
- 确保模块已成功部署并运行
- 获取访问令牌（JWT Token或其他认证方式）
- 确认API基础URL，如：`http://localhost:8080`

### 2.2 基本调用格式
```bash
curl -X <METHOD> -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" <BASE_URL>/<API_PATH> [--data <REQUEST_BODY>]
```

## 3. API接口使用指南

### 3.1 配置管理接口

#### 3.1.1 查询配置列表
**接口说明**：查询系统中的配置列表，支持条件过滤

**接口信息**：
- URL：`/setting/configuration/list`
- 方法：GET
- 权限：`setting:configuration:list`

**请求参数**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| configKey | String | 配置键 | 否 |
| environmentId | Long | 环境ID | 否 |
| isActive | Long | 是否激活（1-激活，0-停用） | 否 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "rows": [
    {
      "configId": 1,
      "configKey": "salesforce.api.version",
      "configValue": "59.0",
      "environmentId": 1,
      "isActive": 1,
      "description": "Salesforce API版本"
    }
  ],
  "total": 1
}
```

**调用示例**：
```bash
curl -X GET -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/list?configKey=salesforce.api.version
```

#### 3.1.2 新增配置
**接口说明**：新增一条配置记录

**接口信息**：
- URL：`/setting/configuration`
- 方法：POST
- 权限：`setting:configuration:add`

**请求体**：
```json
{
  "configKey": "salesforce.login.url",
  "configValue": "https://login.salesforce.com",
  "environmentId": 1,
  "isActive": 1,
  "isSensitive": 0,
  "isEncrypted": 0,
  "description": "Salesforce登录URL"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 1
}
```

**调用示例**：
```bash
curl -X POST -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" \
  --data '{"configKey":"salesforce.login.url","configValue":"https://login.salesforce.com","environmentId":1,"isActive":1,"description":"Salesforce登录URL"}' \
  http://localhost:8080/setting/configuration
```

#### 3.1.3 修改配置
**接口说明**：修改现有配置记录

**接口信息**：
- URL：`/setting/configuration`
- 方法：PUT
- 权限：`setting:configuration:edit`

**请求体**：
```json
{
  "configId": 1,
  "configValue": "60.0",
  "description": "更新后的Salesforce API版本"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 1
}
```

#### 3.1.4 删除配置
**接口说明**：批量删除配置记录

**接口信息**：
- URL：`/setting/configuration/{configIds}`
- 方法：DELETE
- 权限：`setting:configuration:remove`

**请求参数**：
- configIds：配置ID数组，如：`1,2,3`

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 3
}
```

#### 3.1.5 刷新配置缓存
**接口说明**：手动刷新配置缓存

**接口信息**：
- URL：`/setting/configuration/refresh`
- 方法：POST
- 权限：`setting:configuration:refresh`

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置缓存刷新成功"
}
```

#### 3.1.6 验证配置值合法性
**接口说明**：验证配置值是否符合预设规则

**接口信息**：
- URL：`/setting/configuration/validate`
- 方法：POST
- 权限：`setting:configuration:validate`

**请求体**：
```json
{
  "configKey": "salesforce.api.version",
  "configValue": "60.0"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置值验证通过"
}
```

### 3.2 配置版本管理接口

#### 3.2.1 创建配置快照
**接口说明**：创建当前配置的快照，生成新的版本

**接口信息**：
- URL：`/setting/version/snapshot`
- 方法：POST
- 权限：`setting:version:snapshot`

**请求参数**：
- versionDesc：版本描述，如：`"2025年12月14日配置快照"`

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "versionId": 1,
    "versionNumber": "2025.12.14.1",
    "versionDesc": "2025年12月14日配置快照",
    "status": "CREATED"
  }
}
```

**调用示例**：
```bash
curl -X POST -H "Authorization: Bearer <TOKEN>" \
  http://localhost:8080/setting/version/snapshot?versionDesc=2025年12月14日配置快照
```

#### 3.2.2 发布配置版本
**接口说明**：发布指定的配置版本

**接口信息**：
- URL：`/setting/version/{versionId}/publish`
- 方法：POST
- 权限：`setting:version:publish`

**请求参数**：
- versionId：版本ID，如：`1`

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 1
}
```

#### 3.2.3 回滚到指定版本
**接口说明**：将配置回滚到指定的历史版本

**接口信息**：
- URL：`/setting/version/{versionId}/rollback`
- 方法：POST
- 权限：`setting:version:rollback`

**请求参数**：
- versionId：版本ID，如：`1`

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 10
}
```

### 3.3 配置审计日志接口

#### 3.3.1 查询审计日志
**接口说明**：查询配置操作的审计日志

**接口信息**：
- URL：`/setting/log/list`
- 方法：GET
- 权限：`setting:log:list`

**请求参数**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| operationType | String | 操作类型（CREATE、UPDATE、DELETE、PUBLISH、ROLLBACK） | 否 |
| operator | String | 操作人 | 否 |
| beginTime | String | 开始时间（格式：YYYY-MM-DD HH:mm:ss） | 否 |
| endTime | String | 结束时间（格式：YYYY-MM-DD HH:mm:ss） | 否 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "rows": [
    {
      "logId": 1,
      "operationType": "UPDATE",
      "objectType": "DATAI_CONFIGURATION",
      "operator": "admin",
      "operationTime": "2025-12-14 14:30:00",
      "ipAddress": "127.0.0.1",
      "result": "SUCCESS"
    }
  ],
  "total": 1
}
```

## 4. 常见操作示例

### 4.1 完整的配置管理流程

1. **查询现有配置**：确认当前配置状态
2. **创建配置快照**：在修改前创建快照，便于回滚
3. **修改配置**：更新配置值
4. **验证配置**：确保配置值合法
5. **刷新缓存**：使配置立即生效
6. **发布版本**：将当前配置标记为正式版本

### 4.2 配置回滚示例

1. **查询版本列表**：获取可用的历史版本
2. **回滚到指定版本**：执行回滚操作
3. **验证回滚结果**：查询配置确认回滚成功
4. **刷新缓存**：确保缓存同步

## 5. 最佳实践

### 5.1 配置命名规范
- 使用点分隔的命名方式，如：`salesforce.api.version`
- 遵循模块.功能.属性的命名规则
- 避免使用特殊字符和空格

### 5.2 版本管理建议
- 重大变更前创建快照
- 定期发布正式版本
- 保留重要的历史版本
- 为版本添加清晰的描述

### 5.3 安全注意事项
- 敏感配置设置为敏感标记，系统会自动加密存储
- 定期审核配置操作日志
- 严格控制配置修改权限
- 避免在配置中存储明文密码

## 6. 故障排除

### 6.1 常见错误及解决方案

| 错误信息 | 可能原因 | 解决方案 |
|---------|---------|--------|
| 权限不足 | 没有对应的操作权限 | 联系管理员获取权限 |
| 配置键已存在 | 同一环境下配置键重复 | 更换配置键或删除现有配置 |
| 配置值验证失败 | 配置值不符合预设规则 | 检查配置值格式和范围 |
| 版本不存在 | 回滚的版本ID不存在 | 确认版本ID是否正确 |
| 缓存刷新失败 | Redis连接问题 | 检查Redis服务状态 |

### 6.2 日志查看

配置管理模块的日志位于应用日志中，主要包括：
- 配置加载日志：记录系统启动时的配置加载过程
- 操作审计日志：记录所有配置操作
- 错误日志：记录系统异常信息

### 6.3 联系方式

如果遇到无法解决的问题，请联系：
- 维护团队：Datai开发团队
- 联系邮箱：dev@datai.com
- 文档更新时间：2025-12-14