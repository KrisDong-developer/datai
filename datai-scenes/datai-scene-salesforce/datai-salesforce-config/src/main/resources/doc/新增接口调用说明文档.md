# 新增接口调用说明文档

## 1. 文档概述

本文档详细介绍Salesforce配置管理模块新增的API接口调用方法，包括配置版本管理、配置缓存管理和配置验证等功能的具体操作说明。

## 2. 配置版本管理接口

### 2.1 查询版本列表

**接口说明**：查询所有配置版本信息，支持分页查询

**接口信息**：
- URL：`/setting/version/list`
- 方法：GET
- 权限：`setting:version:list`
- 内容类型：无请求体

**查询参数**：
| 参数名 | 类型 | 描述 | 是否必填 | 默认值 |
|-------|------|------|--------|--------|
| page | Integer | 页码 | 否 | 1 |
| pageSize | Integer | 每页条数 | 否 | 10 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "查询成功",
  "data": {
    "list": [
      {
        "versionId": 1,
        "versionNumber": "2025.12.14.1",
        "versionDesc": "初始配置快照",
        "status": "PUBLISHED",
        "createTime": "2025-12-14T14:30:00",
        "createBy": "admin"
      },
      {
        "versionId": 2,
        "versionNumber": "2025.12.14.2",
        "versionDesc": "修改后快照",
        "status": "CREATED",
        "createTime": "2025-12-14T15:30:00",
        "createBy": "admin"
      }
    ],
    "total": 2,
    "page": 1,
    "pageSize": 10
  }
}
```

**返回码说明**：
- 200：查询成功
- 403：权限不足
- 500：服务器内部错误

### 2.2 发布配置版本

**接口说明**：将指定的配置版本标记为已发布状态，发布后该版本将作为当前生效的配置版本

**接口信息**：
- URL：`/setting/version/{versionId}/publish`
- 方法：POST
- 权限：`setting:version:publish`
- 内容类型：无请求体

**路径参数**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| versionId | Long | 配置版本ID | 是 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 1
}
```

**响应字段说明**：
- `data`：1表示发布成功，0表示发布失败

**调用示例**：
```bash
# 使用curl调用
curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/version/1/publish

# 使用Postman调用
# Method: POST
# URL: http://localhost:8080/setting/version/1/publish
# Headers: Authorization: Bearer <TOKEN>
```

**占位符说明**：
- `<TOKEN>`：用户认证令牌，需要替换为实际的令牌值，可通过登录接口获取

**返回码说明**：
- 200：发布成功
- 400：参数错误或版本不存在
- 403：权限不足
- 500：服务器内部错误

### 2.2 创建配置快照

**接口说明**：创建当前配置的完整快照，生成新的配置版本

**接口信息**：
- URL：`/setting/version/snapshot`
- 方法：POST
- 权限：`setting:version:snapshot`
- 内容类型：application/x-www-form-urlencoded

**请求参数**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| versionDesc | String | 版本描述 | 是 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {
    "versionId": 1,
    "versionNumber": "2025.12.14.1",
    "versionDesc": "2025年12月14日配置快照",
    "status": "CREATED",
    "createTime": "2025-12-14T14:30:00",
    "createBy": "admin"
  }
}
```

**调用示例**：
```bash
# 使用curl调用
curl -X POST -H "Authorization: Bearer <TOKEN>" \
  -d "versionDesc=2025年12月14日配置快照" \
  http://localhost:8080/setting/version/snapshot

# 使用Postman调用
# Method: POST
# URL: http://localhost:8080/setting/version/snapshot
# Headers: Authorization: Bearer <TOKEN>, Content-Type: application/x-www-form-urlencoded
# Body: versionDesc=2025年12月14日配置快照
```

**返回码说明**：
- 200：创建快照成功，返回生成的版本信息
- 400：参数错误
- 403：权限不足
- 500：服务器内部错误

### 2.3 回滚到指定版本

**接口说明**：将当前配置回滚到指定的历史版本，回滚后会将历史版本的配置恢复到当前配置中

**接口信息**：
- URL：`/setting/version/{versionId}/rollback`
- 方法：POST
- 权限：`setting:version:rollback`
- 内容类型：无请求体

**路径参数**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| versionId | Long | 配置版本ID | 是 |

**响应示例**：
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": 10
}
```

**响应字段说明**：
- `data`：回滚成功恢复的配置数量

**调用示例**：
```bash
# 使用curl调用
curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/version/1/rollback

# 使用Postman调用
# Method: POST
# URL: http://localhost:8080/setting/version/1/rollback
# Headers: Authorization: Bearer <TOKEN>
```

**返回码说明**：
- 200：回滚成功，返回恢复的配置数量
- 400：参数错误或版本不存在
- 403：权限不足
- 500：服务器内部错误

## 3. 配置缓存管理接口

### 3.1 刷新配置缓存

**接口说明**：手动刷新配置缓存，将数据库中的配置重新加载到缓存中

**接口信息**：
- URL：`/setting/configuration/refresh`
- 方法：POST
- 权限：`setting:configuration:refresh`
- 内容类型：无请求体

**请求参数**：无

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置缓存刷新成功"
}
```

**调用示例**：
```bash
# 使用curl调用
curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/refresh

# 使用Postman调用
# Method: POST
# URL: http://localhost:8080/setting/configuration/refresh
# Headers: Authorization: Bearer <TOKEN>
```

**返回码说明**：
- 200：刷新成功
- 403：权限不足
- 500：服务器内部错误

### 3.2 查询配置缓存状态

**接口说明**：查询当前配置缓存的状态信息，包括缓存中的配置数量、缓存大小等

**接口信息**：
- URL：`/setting/configuration/cache/status`
- 方法：GET
- 权限：`setting:configuration:cache`

**请求参数**：无

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置缓存状态正常",
  "data": {
    "cacheName": "salesforce-config-cache",
    "size": 15,
    "status": "NORMAL"
  }
}
```

**响应字段说明**：
- `cacheName`：缓存名称
- `size`：缓存中的配置数量
- `status`：缓存状态，NORMAL表示正常，ERROR表示异常

**调用示例**：
```bash
# 使用curl调用
curl -X GET -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/cache/status

# 使用Postman调用
# Method: GET
# URL: http://localhost:8080/setting/configuration/cache/status
# Headers: Authorization: Bearer <TOKEN>
```

**返回码说明**：
- 200：查询成功
- 403：权限不足
- 500：服务器内部错误

## 4. 配置管理接口

### 4.1 修改配置

**接口说明**：修改指定配置项的值

**接口信息**：
- URL：`/setting/configuration`
- 方法：PUT
- 权限：`setting:configuration:update`
- 内容类型：application/json

**请求体**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| configId | Long | 配置ID | 是 |
| configValue | String | 配置值 | 是 |

**请求示例**：
```json
{
  "configId": 1,
  "configValue": "61.0"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置修改成功",
  "data": true
}
```

**返回码说明**：
- 200：修改成功
- 400：参数错误
- 403：权限不足
- 500：服务器内部错误

## 5. 配置验证接口

### 5.1 验证配置值合法性

**接口说明**：验证配置值是否符合预设的合法性规则

**接口信息**：
- URL：`/setting/configuration/validate`
- 方法：POST
- 权限：`setting:configuration:validate`
- 内容类型：application/json

**请求体**：
| 参数名 | 类型 | 描述 | 是否必填 |
|-------|------|------|--------|
| configKey | String | 配置键 | 是 |
| configValue | String | 配置值 | 是 |

**请求示例**：
```json
{
  "configKey": "salesforce.api.version",
  "configValue": "60.0"
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "配置值验证通过"
}
```

**验证失败响应示例**：
```json
{
  "code": 400,
  "msg": "配置值验证失败",
  "data": "配置值必须为数字.数字格式"
}
```

**调用示例**：
```bash
# 使用curl调用
curl -X POST -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" \
  -d '{"configKey":"salesforce.api.version","configValue":"60.0"}' \
  http://localhost:8080/setting/configuration/validate

# 使用Postman调用
# Method: POST
# URL: http://localhost:8080/setting/configuration/validate
# Headers: Authorization: Bearer <TOKEN>, Content-Type: application/json
# Body: {"configKey":"salesforce.api.version","configValue":"60.0"}
```

**返回码说明**：
- 200：验证通过
- 400：参数错误或配置值验证失败
- 403：权限不足
- 500：服务器内部错误

## 5. 接口调用流程示例

### 5.1 配置修改与发布流程

1. **查询当前配置**：
   ```bash
   curl -X GET -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/list
   ```

2. **创建配置快照**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" -d "versionDesc=修改前快照" http://localhost:8080/setting/version/snapshot
   ```

3. **修改配置**：
   ```bash
   curl -X PUT -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" \
     -d '{"configId":1,"configValue":"61.0"}' \
     http://localhost:8080/setting/configuration
   ```

4. **验证配置值**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" -H "Content-Type: application/json" \
     -d '{"configKey":"salesforce.api.version","configValue":"61.0"}' \
     http://localhost:8080/setting/configuration/validate
   ```

5. **刷新配置缓存**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/refresh
   ```

6. **发布配置版本**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/version/2/publish
   ```

### 5.2 配置回滚流程

1. **查询版本列表**：
   ```bash
   curl -X GET -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/version/list
   ```

2. **回滚到指定版本**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/version/1/rollback
   ```

3. **验证回滚结果**：
   ```bash
   curl -X GET -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/list?configKey=salesforce.api.version
   ```

4. **刷新配置缓存**：
   ```bash
   curl -X POST -H "Authorization: Bearer <TOKEN>" http://localhost:8080/setting/configuration/refresh
   ```

## 6. 常见问题与解决方案

### 6.1 权限相关问题

**问题**：调用接口时返回403权限不足

**解决方案**：
- 确认当前用户是否有对应的权限
- 联系管理员分配相应权限
- 检查令牌是否过期，重新获取令牌

### 6.2 参数相关问题

**问题**：调用接口时返回400参数错误

**解决方案**：
- 检查路径参数是否正确
- 检查请求体格式是否符合要求
- 检查必填参数是否都已提供

### 6.3 版本相关问题

**问题**：回滚版本时返回版本不存在

**解决方案**：
- 检查版本ID是否正确
- 确认该版本是否存在且未被删除
- 查询版本列表确认可用版本

### 6.4 缓存相关问题

**问题**：刷新缓存后配置未生效

**解决方案**：
- 检查数据库中配置是否正确
- 检查Redis服务是否正常运行
- 确认缓存键是否正确

## 7. 最佳实践

1. **配置修改前创建快照**：在进行重大配置修改前，先创建配置快照，便于后续回滚
2. **定期发布正式版本**：定期将稳定的配置发布为正式版本，便于管理和回滚
3. **严格控制权限**：配置管理权限应该严格控制，只授予必要的人员
4. **验证配置值**：在修改配置前，使用验证接口确认配置值合法性
5. **及时刷新缓存**：配置修改后，及时刷新缓存确保配置立即生效

## 8. 附录

### 8.1 权限列表

| 权限标识 | 权限名称 | 适用接口 |
|---------|---------|---------|
| setting:version:list | 查询版本列表 | /setting/version/list |
| setting:version:publish | 发布配置版本 | /setting/version/{versionId}/publish |
| setting:version:snapshot | 创建配置快照 | /setting/version/snapshot |
| setting:version:rollback | 回滚配置版本 | /setting/version/{versionId}/rollback |
| setting:configuration:update | 修改配置 | /setting/configuration |
| setting:configuration:refresh | 刷新配置缓存 | /setting/configuration/refresh |
| setting:configuration:cache | 查询缓存状态 | /setting/configuration/cache/status |
| setting:configuration:validate | 验证配置值 | /setting/configuration/validate |

### 8.2 配置键验证规则

| 配置键模式 | 验证规则 | 示例 |
|---------|---------|-----|
| salesforce.api.version | 必须为数字.数字格式（不区分大小写） | 60.0 |
| *.enabled | 必须为true或false（不区分大小写） | true |
| *.restricted | 必须为true或false（不区分大小写） | false |
| salesforce.retry.count | 必须为0-10之间的整数 | 5 |

### 8.3 联系方式

- 维护团队：Datai开发团队
- 联系邮箱：dev@datai.com
- 文档更新时间：2024-12-14