# datai-flowable 模块说明文档

## 模块概述

datai-flowable 是 DataI 项目中的工作流引擎模块，基于业界领先的 Flowable 工作流引擎构建，提供完整的业务流程管理能力。该模块负责处理系统中所有工作流相关的功能，包括流程定义、流程实例管理、任务处理、流程监控等核心业务流程操作。通过集成 Flowable 7.1.0 版本，该模块为系统提供了强大的流程编排、审批流转、状态管理和业务流程自动化能力。

## 核心功能

### 1. 流程定义管理
| 功能 | 描述 | 实现类 |
|------|------|--------|
| 流程定义导入 | 支持 BPMN 2.0 标准流程文件导入和部署 | FlowDefinitionController:importFile |
| 流程定义查询 | 提供流程定义列表查询和分页功能 | FlowDefinitionServiceImpl:list |
| 流程定义状态管理 | 支持流程定义的激活与挂起状态切换 | FlowDefinitionServiceImpl:updateState |
| 流程定义删除 | 提供流程定义的安全删除功能 | FlowDefinitionServiceImpl:delete |
| 流程图生成 | 自动生成流程定义的可视化流程图 | FlowDefinitionServiceImpl:readImage |

### 2. 流程实例管理
| 功能 | 描述 | 实现类 |
|------|------|--------|
| 流程实例启动 | 根据流程定义ID启动新的流程实例 | FlowInstanceServiceImpl:startProcessInstanceById |
| 流程实例终止 | 提供流程实例的强制终止功能 | FlowInstanceServiceImpl:stopProcessInstance |
| 流程实例状态管理 | 支持流程实例的激活与挂起 | FlowInstanceServiceImpl:updateState |
| 流程实例删除 | 提供流程实例的历史记录删除功能 | FlowInstanceServiceImpl:delete |
| 流程实例查询 | 支持历史流程实例的详细信息查询 | FlowInstanceServiceImpl:getHistoricProcessInstanceById |

### 3. 工作任务管理
| 功能 | 描述 | 实现类 |
|------|------|--------|
| 任务审批 | 提供任务审批通过功能 | FlowTaskServiceImpl:complete |
| 任务驳回 | 支持任务驳回至发起人 | FlowTaskServiceImpl:taskReject |
| 任务退回 | 支持任务退回至历史节点 | FlowTaskServiceImpl:taskReturn |
| 任务转办 | 提供任务转办给其他用户功能 | FlowTaskServiceImpl:assignTask |
| 任务委派 | 支持任务委派给其他用户处理 | FlowTaskServiceImpl:delegateTask |
| 任务认领 | 提供公共任务的认领/取消认领功能 | FlowTaskServiceImpl:claim/unClaim |
| 多实例管理 | 支持会签任务的加签/减签操作 | FlowTaskServiceImpl:addMultiInstanceExecution/deleteMultiInstanceExecution |
| 待办任务查询 | 提供个人待办任务列表查询 | FlowTaskServiceImpl:todoList |
| 已办任务查询 | 提供个人已办任务历史记录查询 | FlowTaskServiceImpl:finishedList |

### 4. 流程监控与可视化
| 功能 | 描述 | 实现类 |
|------|------|--------|
| 流程图生成 | 实时生成流程实例执行状态图 | CustomProcessDiagramGenerator |
| 流程节点查询 | 提供当前流程节点及执行状态查询 | FlowTaskServiceImpl:getFlowViewer |
| 流程流转记录 | 查询完整的历史流程流转记录 | FlowTaskServiceImpl:flowRecord |
| 流程变量管理 | 提供流程变量的查询和设置功能 | FlowTaskServiceImpl:processVariables |
| 下一节点预测 | 预测流程可能的下一执行节点 | FlowTaskServiceImpl:getNextFlowNode |

### 5. 表单集成
| 功能 | 描述 | 实现类 |
|------|------|--------|
| 流程表单挂载 | 支持为流程节点挂载自定义表单 | SysDeployFormServiceImpl |
| 任务表单查询 | 获取当前任务关联的表单信息 | FlowTaskServiceImpl:getTaskForm |
| 表单数据管理 | 管理表单数据的存储和读取 | SysTaskFormServiceImpl |

## 依赖关系

### 核心依赖
| 依赖项 | 版本 | 用途 |
|--------|------|------|
| datai-system | 项目版本 | 依赖系统模块，获取用户、角色等基础服务 |
| flowable-spring-boot-starter | 7.1.0 | Flowable工作流引擎核心依赖 |
| aviator | 5.3.3 | 表达式引擎，用于流程条件表达式计算 |
| graalvm.js | 24.2.1 | JavaScript脚本引擎，支持流程脚本任务 |
| datai-form | 项目版本 | 表单模块，支持动态表单渲染和数据处理 |

### 依赖特点
- **Flowable引擎集成**：通过Spring Boot Starter方式集成Flowable 7.1.0版本，提供完整的工作流引擎能力
- **表达式引擎扩展**：集成Aviator表达式引擎，增强流程条件判断能力
- **脚本执行支持**：通过GraalVM JavaScript引擎支持流程中的脚本任务执行
- **表单模块联动**：与datai-form模块紧密集成，实现流程与表单的无缝对接

## 模块架构

### 分层结构
```
datai-flowable/
├── controller/          # REST API控制层
├── service/             # 业务逻辑层
├── mapper/              # 数据访问层
├── domain/              # 领域模型层
├── config/              # 配置层
├── common/              # 公共组件
├── factory/             # 工厂类
├── flow/                # 流程处理工具
├── listener/            # 流程监听器
└── expression/          # 表达式处理
```

### 关键组件
- **FlowServiceFactory**：Flowable引擎服务工厂，统一管理所有引擎服务
- **FlowableConfig**：Flowable引擎配置类，自定义字体、ID生成器和线程池
- **CustomProcessDiagramGenerator**：自定义流程图生成器，支持中文字体和流程状态高亮
- **FlowExecutionListener/FlowTaskListener**：流程执行和任务监听器，处理流程事件

## 模块特点

1. **完整的工作流生命周期管理**：提供从流程设计、部署、执行到监控的全生命周期管理能力
2. **灵活的任务处理机制**：支持审批、驳回、退回、转办、委派等多种任务处理方式
3. **强大的流程可视化能力**：实时生成流程图，直观展示流程执行状态和历史轨迹
4. **丰富的扩展点**：通过监听器、表达式和脚本引擎支持复杂业务逻辑扩展
5. **与系统模块深度集成**：无缝对接用户、角色、权限等系统基础功能
6. **表单集成能力**：与表单模块紧密集成，实现流程与表单的联动处理

## 总结

datai-flowable 模块是 DataI 项目中负责工作流管理的核心组件，通过集成 Flowable 工作流引擎，为系统提供了强大的业务流程管理能力。该模块采用分层架构设计，职责清晰，扩展性强，能够满足企业级应用中复杂的流程管理需求。通过丰富的API接口和可视化能力，该模块为业务流程的自动化、标准化和可视化提供了坚实的技术基础，是提升企业业务流程效率和管理水平的重要工具。