# datai-mybatis-plus 模块说明文档

## 模块概述

datai-mybatis-plus 是 datai 框架中的 MyBatis-Plus 增强模块，提供了 MyBatis-Plus 的集成配置和功能增强。该模块通过 MyBatis-Plus 的强大功能简化了数据库操作，提供了自动填充、异常处理、分页插件、乐观锁等高级特性，同时集成了 datai 框架的数据权限控制和拦截器功能。

## 核心功能

### 1. MyBatis-Plus 配置增强

模块提供了完整的 MyBatis-Plus 配置，包括：

- **分页插件**：自动配置分页拦截器，支持多种数据库分页
- **乐观锁插件**：提供乐观锁支持，防止并发更新冲突
- **防止全表更新删除**：通过 BlockAttackInnerInterceptor 防止全表操作
- **数据源管理**：集成多数据源支持和动态切换
- **SQL 注入器**：自定义 SQL 注入器，扩展 MyBatis-Plus 功能

### 2. 自动填充处理器

通过 InjectionMetaObjectHandler 实现实体字段的自动填充：

- **创建时间/更新时间**：自动设置实体创建和更新时间
- **创建人/更新人**：自动从当前登录用户获取操作人信息
- **创建部门**：自动填充创建部门信息
- **审计字段**：支持自定义审计字段的自动填充策略

### 3. 异常处理增强

提供专门的 MyBatis 异常处理器：

- **主键冲突处理**：捕获 DuplicateKeyException 并提供友好错误信息
- **数据源异常处理**：处理 CannotFindDataSourceException 等数据源相关异常
- **系统异常处理**：统一处理 MyBatis 系统级异常
- **异常日志记录**：详细记录异常信息和请求上下文

### 4. 示例代码模块

提供完整的示例代码，展示 MyBatis-Plus 的使用方式：

- **实体类示例**：SysStudent 展示实体注解使用
- **Mapper 接口示例**：SysStudentMapper 展示基础 Mapper 接口
- **Service 层示例**：ISysStudentService 和 SysStudentServiceImpl 展示服务层实现
- **Controller 层示例**：SysStudentController 展示控制器层实现

## 主要组件

### 配置组件

- **MybatisPlusConfig**：MyBatis-Plus 核心配置类，配置各种拦截器和插件

### 处理器组件

- **InjectionMetaObjectHandler**：元对象处理器，实现字段自动填充
- **MybatisExceptionHandler**：全局异常处理器，统一处理 MyBatis 相关异常

### 示例组件

- **SysStudent**：学生实体类，展示 MyBatis-Plus 实体注解使用
- **SysStudentMapper**：学生数据访问接口，展示基础 Mapper 使用
- **ISysStudentService**：学生服务接口，展示业务层接口设计
- **SysStudentServiceImpl**：学生服务实现，展示业务层实现方式
- **SysStudentController**：学生控制器，展示 RESTful API 实现

## 技术特点

1. **零侵入**：对现有代码结构无侵入性，可平滑升级
2. **自动化配置**：基于 Spring Boot 自动配置机制，简化集成过程
3. **功能丰富**：提供分页、乐观锁、自动填充等常用功能
4. **异常统一**：统一的异常处理机制，提供友好的错误信息
5. **示例完整**：提供完整的示例代码，便于学习和参考
6. **扩展性强**：支持自定义拦截器、处理器等扩展

## 依赖关系

模块依赖以下核心组件：

- **datai-common**：提供基础工具类和通用功能
- **mybatis-plus-spring-boot3-starter**：提供 MyBatis-Plus 的 Spring Boot 集成
- **datai-mybatis-interceptor**：提供数据权限控制和分页拦截功能

## 应用场景

1. **快速开发**：适用于需要快速实现数据访问层的项目
2. **企业应用**：适用于企业级应用中的数据管理模块
3. **微服务架构**：适用于微服务中简化数据访问层开发
4. **数据中台**：适用于数据中台中统一数据访问接口

## 配置说明

模块支持通过配置文件进行功能定制，主要包括：

- 分页插件配置
- 乐观锁配置
- 数据源配置
- 自动填充策略配置

## 最佳实践

1. **实体设计**：合理使用 MyBatis-Plus 注解，避免过度设计
2. **查询优化**：利用 QueryWrapper 和 LambdaQueryWrapper 构建高效查询
3. **异常处理**：结合全局异常处理器，提供统一的错误响应
4. **性能优化**：合理使用分页和缓存，提高查询性能

## 扩展性

模块设计具有良好的扩展性，支持：

- 自定义拦截器扩展
- 自定义字段填充策略
- 自定义异常处理逻辑
- 自定义 SQL 注入器