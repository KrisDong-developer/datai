# datai-websocket 模块说明文档

## 模块概述

datai-websocket 是基于 Spring Boot WebSocket 框架开发的实时通信模块，为 datai 项目提供 WebSocket 连接管理和消息传递能力。该模块实现了用户认证、连接管理、消息路由等核心功能，支持点对点和广播消息通信，是构建实时交互应用的基础组件。

## 核心功能

### 1. WebSocket 连接管理
- 提供基于 Spring WebSocket 的连接建立和维护
- 实现连接生命周期管理（建立、关闭、异常处理）
- 支持连接数量限制，防止服务器资源耗尽
- 提供连接状态监控和日志记录

### 2. 用户认证与授权
- 集成 Token 认证机制，确保连接安全性
- 实现握手拦截器，在连接建立前验证用户身份
- 支持多种 Token 传递方式（查询参数、协议头）
- 与系统安全框架无缝集成

### 3. 消息路由与传递
- 实现点对点消息传递，支持用户间直接通信
- 提供群发消息功能，支持广播消息
- 支持异步消息处理机制
- 实现消息格式标准化和统一处理

### 4. 用户会话管理
- 维护在线用户会话集合
- 提供用户名与 WebSocket 会话的映射关系
- 支持用户信息存储和检索
- 实现会话的自动清理和资源释放

## 主要组件

### 1. WebSocketConfig
- WebSocket 配置类，负责注册 WebSocket 处理器
- 配置连接端点和拦截器
- 设置跨域访问策略
- 实现 WebSocketConfigurer 接口

### 2. WebSocketServer
- WebSocket 消息处理器，继承 TextWebSocketHandler
- 处理连接建立、消息接收、连接关闭等事件
- 实现信号量机制控制并发连接数
- 提供消息路由和转发逻辑

### 3. WebSocketUsers
- 用户会话管理工具类
- 维护会话、用户名和登录用户的映射关系
- 提供用户添加、移除和查询功能
- 实现消息发送的统一接口

### 4. WebSocketInterceptor
- WebSocket 握手拦截器，实现 HandshakeInterceptor
- 负责连接建立前的身份验证
- 处理连接参数和 Token 提取
- 提供连接安全控制

## 技术特点

### 1. 并发控制
- 使用信号量机制限制最大连接数
- 防止过多连接导致服务器资源耗尽
- 支持连接数动态配置

### 2. 安全认证
- 集成系统 Token 服务，实现统一认证
- 支持多种 Token 传递方式
- 提供连接前的安全验证

### 3. 异常处理
- 完善的异常捕获和处理机制
- 连接异常时的自动资源清理
- 详细的日志记录和错误追踪

### 4. 消息标准化
- 使用统一的 Message 消息格式
- 支持消息类型区分（同步/异步）
- 实现 JSON 序列化和反序列化

## 依赖关系

- **datai-framework**：项目框架模块，提供安全服务和工具类
- **spring-boot-starter-websocket**：Spring Boot WebSocket 启动器，提供 WebSocket 支持

## 应用场景

1. **实时通知系统**：系统消息、公告、提醒的实时推送
2. **在线聊天应用**：用户间的实时消息交流
3. **协同办公**：多用户实时协作和状态同步
4. **监控面板**：系统状态和数据的实时更新展示
5. **在线教育**：师生互动、课堂实时交流

## 模块定位

datai-websocket 模块是 datai 项目中的实时通信基础设施，为上层应用提供稳定、安全、高效的 WebSocket 通信能力。它封装了 WebSocket 的复杂性，提供了一套完整的连接管理、用户认证和消息传递解决方案，使开发者能够轻松构建实时交互功能。

该模块的设计遵循 Spring Boot 的最佳实践，通过注解驱动的配置和面向组件的设计，实现了高度的可配置性和可扩展性。同时，模块充分考虑了安全性和性能，提供了完善的并发控制和异常处理机制。

## 使用优势

1. **简化集成**：提供开箱即用的 WebSocket 解决方案
2. **安全可靠**：内置认证机制，确保连接安全
3. **性能优化**：并发控制机制，防止资源滥用
4. **易于使用**：简洁的 API 设计，降低开发难度
5. **完善监控**：详细的日志记录，便于问题排查