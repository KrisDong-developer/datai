# datai-mybatis-interceptor 模块说明文档

## 模块概述

datai-mybatis-interceptor 是 datai 框架中的 MyBatis 拦截器插件模块，提供了数据权限控制和分页查询功能。该模块通过 MyBatis 拦截器机制实现了对 SQL 语句的动态修改，支持多数据库方言，并提供了安全的排序功能。

## 核心功能

### 1. 数据权限控制

模块实现了基于用户角色的数据权限过滤功能，通过 DataScopeAspect 切面和 DataScopeInterceptor 拦截器协同工作，在 SQL 执行前动态添加数据权限条件，确保用户只能访问其权限范围内的数据。

- 支持基于部门、用户等多维度数据权限控制
- 使用 JSqlParser 解析和修改 SQL 语句
- 通过 ThreadLocal 机制维护权限上下文

### 2. 分页查询功能

提供了通用的分页查询解决方案，支持多种数据库的分页实现：

- 通过 PageInterceptor 拦截器实现自动分页
- 支持 MySQL、Oracle、SQL Server、PostgreSQL、H2 等主流数据库
- 提供分页上下文管理（PageContextHolder）
- 支持自定义分页参数和合理化分页处理

### 3. 数据库方言支持

模块内置了多种数据库的方言实现，通过 DialectRouter 自动识别并选择合适的方言：

- MySqlLikeDialect：MySQL 及其兼容数据库
- OracleDialect：Oracle 数据库
- SqlServerDialect：SQL Server 数据库
- PostgresDialect：PostgreSQL 数据库
- H2Dialect：H2 内存数据库

### 4. SQL 工具集

提供了一系列 SQL 处理工具，增强 SQL 安全性和处理效率：

- SqlUtil：SQL 安全处理和过滤工具
- OrderByUtil：安全构建 ORDER BY 子句，防止 SQL 注入
- SqlAnalysisCache：SQL 分析结果缓存，减少重复解析开销

## 主要组件

### 拦截器组件

- **DataScopeInterceptor**：数据权限拦截器，负责在 SQL 执行前添加权限过滤条件
- **PageInterceptor**：分页拦截器，负责将普通查询转换为分页查询
- **MybatisInterceptor**：通用拦截器注册器

### 切面组件

- **DataScopeAspect**：数据权限切面，处理带有 @DataScope 注解的方法，设置权限上下文

### 上下文管理

- **PageContextHolder**：分页上下文管理器，使用 ThreadLocal 存储分页信息
- **SqlContextHolder**：SQL 上下文管理器，存储 SQL 执行过程中的上下文信息

### 工具组件

- **SqlAnalysisCache**：SQL 分析结果缓存
- **OrderByUtil**：安全排序工具
- **SqlUtil**：SQL 处理工具

## 技术特点

1. **多数据库兼容性**：通过方言模式支持多种数据库，具有良好的数据库兼容性
2. **高性能**：使用缓存机制减少 SQL 解析开销，提高执行效率
3. **安全性**：内置 SQL 注入防护机制，确保数据访问安全
4. **灵活性**：支持自定义权限规则和分页参数，满足不同业务场景需求
5. **易集成**：基于 Spring Boot 自动配置机制，简化集成过程

## 依赖关系

模块依赖以下核心组件：

- **datai-common**：提供基础工具类和通用功能
- **datai-framework**：提供框架核心功能和安全支持
- **spring-boot-starter-aop**：提供 AOP 支持，用于切面编程

## 应用场景

1. **多租户系统**：实现租户数据隔离
2. **权限管理系统**：实现细粒度的数据权限控制
3. **数据报表系统**：实现大数据量的分页查询
4. **企业应用系统**：实现部门级别的数据访问控制

## 配置说明

模块支持通过配置文件进行功能定制，主要包括：

- 数据权限控制开关
- 分页参数默认值
- 缓存配置
- 数据库方言自动识别

## 扩展性

模块设计具有良好的扩展性，支持：

- 自定义数据库方言实现
- 自定义权限规则
- 自定义分页逻辑
- 自定义 SQL 处理工具