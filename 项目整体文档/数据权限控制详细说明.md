# 数据权限控制详细说明

## 1. 概述

本项目采用基于注解的AOP数据权限控制机制，通过动态生成SQL条件实现数据范围过滤，支持多种数据权限模式，可灵活配置不同角色的数据访问范围。

## 2. 核心组件

### 2.1 注解

- **`@DataScope`**：用于标记需要数据权限控制的方法
- **`@PreAuthorize`**：用于接口权限验证
- **`@Anonymous`**：用于配置公开接口

### 2.2 核心类

- **`DataScopeAspect`**：AOP切面，负责生成数据权限SQL
- **`BaseEntity`**：基础实体类，包含`params`字段用于传递数据权限条件
- **`SecurityUtils`**：安全工具类，用于获取当前登录用户信息

### 2.3 数据权限类型

| 权限类型 | 代码 | 描述 |
| --- | --- | --- |
| 全部数据权限 | 1 | 可查看所有数据 |
| 自定数据权限 | 2 | 可查看指定部门的数据 |
| 部门数据权限 | 3 | 可查看本部门的数据 |
| 部门及以下数据权限 | 4 | 可查看本部门及所有子部门的数据 |
| 仅本人数据权限 | 5 | 只能查看自己创建的数据 |

## 3. 实现原理

### 3.1 执行流程

1. 在Service方法上添加`@DataScope`注解
2. 当方法被调用时，`DataScopeAspect`切面拦截该方法
3. 获取当前登录用户的角色信息
4. 根据角色的`dataScope`属性生成对应的SQL条件
5. 将生成的SQL条件放入`BaseEntity`的`params`字段中，key为`dataScope`
6. 在MyBatis的XML映射文件中，通过`${params.dataScope}`引用这个条件
7. 执行最终的SQL查询，返回符合数据权限要求的数据

### 3.2 数据权限SQL生成逻辑

```java
// 全部数据权限
if (DATA_SCOPE_ALL.equals(dataScope)) {
    sqlString = new StringBuilder(); // 不添加任何条件
}
// 自定数据权限
else if (DATA_SCOPE_CUSTOM.equals(dataScope)) {
    sqlString.append(" OR {}.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = {} ) ");
}
// 部门数据权限
else if (DATA_SCOPE_DEPT.equals(dataScope)) {
    sqlString.append(" OR {}.dept_id = {} ");
}
// 部门及以下数据权限
else if (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope)) {
    // 根据数据库类型生成不同的SQL
    sqlString.append(" OR {}.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = {} or find_in_set( {} , ancestors ) )");
}
// 仅本人数据权限
else if (DATA_SCOPE_SELF.equals(dataScope)) {
    if (StringUtils.isNotBlank(userAlias)) {
        sqlString.append(" OR {}.user_id = {} ");
    } else {
        sqlString.append(" OR {}.dept_id = 0 "); // 不查询任何数据
    }
}
```

## 4. 使用方法

### 4.1 基本使用

#### 4.1.1 在Service方法上添加注解

```java
@DataScope(deptAlias = "d", userAlias = "u")
public List<SysUser> selectUserList(SysUser user) {
    return userMapper.selectUserList(user);
}
```

#### 4.1.2 在XML映射文件中引用数据权限条件

```xml
<select id="selectUserList" parameterType="SysUser" resultMap="SysUserResult">
    <include refid="selectUserVo"/>
    <where>
        <if test="userName != null and userName != ''">
            AND u.user_name LIKE CONCAT('%', #{userName}, '%')
        </if>
        <!-- 数据范围过滤 -->
        ${params.dataScope}
    </where>
</select>
```

### 4.2 注意事项

1. 方法的参数必须继承`BaseEntity`类
2. 实体类需要包含`deptId`和`userId`字段（如果需要）
3. 超级管理员不受数据权限限制
4. 角色的`dataScope`属性在后台角色管理界面配置

## 5. 后续新增表如何做数据权限控制

### 5.1 步骤

1. **实体类设计**
   - 继承`BaseEntity`类
   - 添加`deptId`和`userId`字段（如果需要）
   - 实现getter和setter方法

2. **Mapper接口**
   - 定义查询方法，参数为继承了`BaseEntity`的实体类

3. **Service实现**
   - 在查询方法上添加`@DataScope`注解
   - 配置`deptAlias`和`userAlias`

4. **XML映射文件**
   - 在查询语句的`where`条件中添加`${params.dataScope}`
   - 确保SQL中使用了正确的表别名

5. **数据库表设计**
   - 添加`dept_id`和`create_by`字段
   - 确保数据插入时正确设置这些字段

### 5.2 示例

#### 5.2.1 实体类

```java
public class DataiIntegrationObject extends BaseEntity {
    // 其他字段
    private Long deptId;
    private String createBy;
    // getter和setter方法
}
```

#### 5.2.2 Service方法

```java
@DataScope(deptAlias = "d")
public List<DataiIntegrationObject> selectDataiIntegrationObjectList(DataiIntegrationObject object) {
    return dataiIntegrationObjectMapper.selectDataiIntegrationObjectList(object);
}
```

#### 5.2.3 XML映射文件

```xml
<select id="selectDataiIntegrationObjectList" parameterType="DataiIntegrationObject" resultMap="DataiIntegrationObjectResult">
    <include refid="selectDataiIntegrationObjectVo"/>
    <where>
        <!-- 其他条件 -->
        ${params.dataScope}
    </where>
</select>
```

## 6. 权限配置

### 6.1 角色数据权限配置

1. 登录后台管理系统
2. 进入角色管理界面
3. 编辑角色信息
4. 在数据权限选项中选择合适的数据权限类型
5. 如果选择"自定数据权限"，需要选择具体的部门

### 6.2 接口权限配置

1. 登录后台管理系统
2. 进入菜单管理界面
3. 编辑菜单信息
4. 在权限标识字段中配置权限标识（如：`system:user:list`）
5. 在角色管理界面为角色分配相应的权限

## 7. 最佳实践

1. **合理设计数据权限**：根据业务需求选择合适的数据权限类型
2. **避免过度使用数据权限**：仅对需要数据权限控制的方法添加`@DataScope`注解
3. **正确配置表别名**：确保`@DataScope`注解中的表别名与XML中的表别名一致
4. **继承BaseEntity**：所有需要数据权限控制的实体类必须继承`BaseEntity`
5. **统一命名规范**：数据库表、实体类、XML映射文件使用统一的命名规范
6. **测试数据权限**：在开发过程中充分测试不同角色的数据权限

## 8. 常见问题

### 8.1 数据权限不生效

- 检查实体类是否继承了`BaseEntity`
- 检查`@DataScope`注解的表别名是否与XML中的表别名一致
- 检查用户是否为超级管理员
- 检查角色的数据权限配置是否正确
- 检查XML映射文件中是否添加了`${params.dataScope}`

### 8.2 SQL语法错误

- 检查表别名是否正确
- 检查SQL语句中是否有语法错误
- 检查数据库类型是否支持使用的SQL函数（如：`find_in_set`）

## 9. 与Salesforce集成的数据权限

### 9.1 现状

当前Salesforce集成模块尚未实现数据权限控制，所有用户都可以访问所有Salesforce数据。

### 9.2 建议

1. **实体类改造**：
   - `DataiIntegrationObject`、`DataiIntegrationField`等实体类继承`BaseEntity`
   - 添加`deptId`和`createBy`字段

2. **Service层改造**：
   - 在查询方法上添加`@DataScope`注解
   - 配置合适的表别名

3. **XML映射文件改造**：
   - 在查询语句中添加`${params.dataScope}`

4. **数据初始化**：
   - 确保新增数据时正确设置`deptId`和`createBy`字段

## 10. 总结

本项目的数据权限控制机制基于AOP和动态SQL实现，具有灵活、高效、易扩展的特点。通过合理配置数据权限，可以实现不同角色对不同数据范围的精确控制，提高系统的安全性和可用性。

在后续开发中，建议对Salesforce集成模块进行数据权限改造，确保数据访问的安全性和合规性。