# datai-pay-sqb 模块说明文档

## 模块概述

datai-pay-sqb是datai-scene-pay支付场景中的收钱吧支付实现模块，提供与收钱吧支付平台的完整集成能力。该模块实现了收钱吧支付的核心功能，包括终端激活、支付处理、订单查询、退款服务等，为系统提供稳定可靠的收钱吧支付解决方案。

## 核心功能

### 收钱吧配置管理
- 提供收钱吧商户配置管理，包括API域名、终端序列号、终端密钥、应用ID等关键参数
- 支持商户序列号与商户密钥配置，用于终端激活与管理
- 实现通知URL配置，支持支付结果异步通知
- 支持公钥配置管理，用于回调签名验证

### 终端管理
- 提供终端激活功能，通过激活码获取终端序列号与密钥
- 实现终端签到机制，确保终端状态正常
- 支持终端信息管理与状态维护

### 支付处理
- 支持支付URL生成，创建收钱吧支付链接
- 提供预下单功能，生成支付订单
- 实现支付参数签名与安全传输
- 支持多种支付方式集成

### 订单管理
- 提供订单查询功能，跟踪支付状态
- 实现订单状态更新与同步
- 支持撤单操作，处理异常订单

### 退款服务
- 提供退款申请功能，支持全额或部分退款
- 实现退款状态跟踪与查询
- 支持多次退款请求处理

### 异步通知处理
- 实现收钱吧支付异步通知接收与验证
- 提供RSA签名验证机制确保通知安全性
- 支持支付结果自动更新与业务处理

## 主要作用

1. **收钱吧支付集成**：作为系统与收钱吧支付平台之间的桥梁，封装收钱吧API调用细节
2. **终端生命周期管理**：管理收钱吧终端从激活到使用的完整流程
3. **支付流程管理**：管理收钱吧支付全生命周期，从订单创建到支付完成
4. **安全通信保障**：确保与收钱吧支付平台通信的安全性，包括签名验证与加密传输
5. **异常处理**：提供收钱吧支付异常情况的统一处理机制

## 关键特性

- **终端自动管理**：支持终端自动激活与签到，简化终端配置流程
- **签名安全机制**：实现MD5与RSA双重签名验证，确保交易安全
- **灵活配置**：通过Spring Boot配置属性管理收钱吧参数，支持多环境配置
- **异步处理**：支持异步通知处理，提高系统响应性能
- **完整支付流程**：覆盖支付、查询、退款等完整支付生命周期
- **错误恢复**：提供撤单等错误恢复机制，增强系统健壮性

## 依赖关系

- 依赖datai-pay-common模块，使用通用支付实体与服务接口
- 集成系统通用工具类，包括HTTP请求、安全工具、MD5加密等
- 基于Spring Boot框架，实现配置自动加载与服务注册

## 技术架构

模块采用分层架构设计，配置层负责收钱吧参数管理，服务层提供支付、退款、通知处理等功能，通过统一的接口与datai-pay-common模块交互，实现支付渠道的抽象与统一管理。使用HTTP客户端与收钱吧API进行通信，确保数据传输的安全性与可靠性。