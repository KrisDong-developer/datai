# datai-tfa-phone 模块说明文档

## 模块概述

datai-tfa-phone 是 datai-scene-auth 认证场景中的手机号双因素认证(TFA)模块，提供基于短信验证码的用户注册、登录、绑定和解绑功能。该模块集成阿里云短信服务，通过发送验证码到用户手机，实现安全的身份验证流程，增强系统的安全性。

## 核心功能

### 短信验证码服务
- 提供短信验证码发送功能，支持不同使用场景的验证码管理
- 实现验证码有效期控制，默认有效期为1分钟
- 支持验证码缓存存储和自动失效机制
- 集成阿里云短信服务，确保短信发送的可靠性

### 用户注册认证
- 支持基于手机号的用户注册流程
- 通过短信验证码验证用户身份
- 自动创建用户账户并设置基本信息

### 用户登录认证
- 支持基于短信验证码的用户登录
- 提供自动注册选项，首次登录时可自动创建账户
- 验证成功后生成系统访问令牌

### 手机号绑定与解绑
- 支持已登录用户绑定手机号码
- 提供手机号解绑功能，允许用户解除手机号关联
- 通过验证码确保操作安全性

## 技术架构

### 依赖组件
- **datai-auth-common**: 提供认证通用功能和接口定义
- **阿里云短信服务(dysmsapi20170525)**: 提供短信发送能力

### 核心类设计
- **DySmsService**: 手机号服务接口，继承验证码服务和双因素认证服务
- **DySmsServiceImpl**: 手机号服务实现类，处理所有手机号相关业务逻辑
- **DySmsUtil**: 短信工具类，封装阿里云短信API调用
- **DySmsConfig**: 短信配置类，管理阿里云短信服务配置信息
- **DySmsTemplate**: 短信模板实体类，定义短信模板结构

### 业务流程
1. **发送验证码**: 生成随机验证码，通过阿里云短信服务发送到指定手机号，并存储到缓存
2. **验证码校验**: 从缓存中获取验证码进行比对，验证成功后清除缓存
3. **用户操作**: 根据验证结果执行注册、登录、绑定或解绑操作

## 安全特性

### 验证码安全
- 验证码有效期限制，防止长期有效带来的安全风险
- 验证码使用后立即失效，避免重复使用
- 验证码缓存隔离，不同场景使用不同缓存键

### 操作安全
- 手机号唯一性检查，防止重复绑定
- 用户身份验证，确保只能操作自己的账户
- 操作日志记录，便于安全审计

### 短信服务安全
- 阿里云官方SDK，确保通信安全
- 参数验证机制，防止非法请求
- 错误处理和日志记录，便于问题排查

## 应用场景

- **用户注册**: 新用户通过短信验证码完成注册
- **安全登录**: 用户通过短信验证码进行身份验证登录
- **账户绑定**: 用户绑定手机号作为备用联系方式
- **账户解绑**: 用户解除手机号绑定，更换联系方式

## 模块特点

- **专业短信集成**: 基于阿里云短信服务，提供稳定可靠的短信发送能力
- **灵活配置**: 支持多种短信模板配置，满足不同业务场景需求
- **安全可靠**: 完善的验证机制和安全控制措施
- **易于集成**: 标准化接口设计，便于与其他认证模块集成