# datai-oauth-wx 模块说明文档

## 模块概述

datai-oauth-wx 是专门针对微信生态系统的OAuth认证模块，为系统提供微信小程序和微信公众号的登录认证能力。该模块实现了微信官方OAuth2.0授权流程，支持用户通过微信身份快速登录系统，并提供微信账号与系统用户的绑定功能。

## 核心功能

### 1. 微信小程序登录认证
提供完整的微信小程序登录流程：
- 通过微信小程序临时登录凭证code获取openid和session_key
- 支持自动注册新用户功能
- 微信用户信息与系统用户的关联管理
- 登录状态维护和令牌生成

### 2. 微信公众号登录认证
提供微信公众号网页授权登录功能：
- 通过微信授权码获取用户openid
- 支持静默授权和用户信息授权
- 微信用户与系统用户的绑定和解绑
- 安全的登录状态管理

### 3. 用户绑定管理
支持微信账号与系统用户的灵活绑定：
- 已有系统用户绑定微信账号
- 微信登录后自动创建系统用户
- 防止重复绑定的校验机制
- 用户自主管理微信绑定关系

### 4. 配置管理
提供微信相关配置的集中管理：
- 微信小程序AppID和AppSecret配置
- 微信公众号AppID和AppSecret配置
- 微信API请求地址配置
- 支持Spring Boot配置文件注入

## 主要作用

1. **微信生态整合**：为系统提供与微信生态的无缝集成，满足移动互联网用户的登录需求

2. **简化登录流程**：用户无需注册账号，直接使用微信身份即可登录，降低用户使用门槛

3. **用户数据获取**：通过微信授权获取用户基本信息，丰富系统用户画像

4. **移动端适配**：特别适合移动端应用和小程序场景，提供原生般的登录体验

## 关键特性

1. **双平台支持**：同时支持微信小程序和微信公众号两种登录方式

2. **自动注册机制**：可选择是否自动为未绑定的微信用户创建系统账号

3. **安全认证流程**：严格遵循微信OAuth2.0授权流程，确保认证安全

4. **状态管理**：完整的登录状态维护和令牌管理机制

5. **错误处理**：完善的异常处理和错误提示机制

6. **配置灵活**：通过配置文件管理微信相关参数，便于不同环境部署

## 技术依赖

- datai-auth-common：提供认证相关的公共接口和数据模型

## 使用场景

datai-oauth-wx 主要服务于以下场景：
- 微信小程序用户快速登录系统
- 微信公众号内网页用户授权登录
- 已有系统用户绑定微信账号，便于后续快速登录
- 移动端应用集成微信登录功能

## 接口设计

### 微信登录接口
- POST /oauth/wx/login/{source}/{code}：微信登录接口
  - source：登录来源，支持"miniapp"（小程序）和"pub"（公众号）
  - code：微信授权码或临时登录凭证

### 微信绑定接口
- POST /oauth/wx/register/{source}/{code}：微信账号绑定接口
  - source：绑定来源，支持"miniapp"（小程序）和"pub"（公众号）
  - code：微信授权码或临时登录凭证

## 配置说明

模块通过以下配置项管理微信相关参数：

### 微信小程序配置
```yaml
oauth:
  wx:
    miniapp:
      app-id: [微信小程序AppID]
      app-secret: [微信小程序AppSecret]
      url: [微信API请求地址]
```

### 微信公众号配置
```yaml
oauth:
  wx:
    pub:
      app-id: [微信公众号AppID]
      app-secret: [微信公众号AppSecret]
      url: [微信API请求地址]
```

## 认证流程

### 微信小程序登录流程
1. 小程序调用wx.login()获取临时登录凭证code
2. 前端将code发送到后端接口/oauth/wx/login/miniapp/{code}
3. 后端通过code向微信服务器换取openid和session_key
4. 系统查询是否已存在该openid对应的用户
5. 若存在则直接登录，若不存在则根据autoRegister参数决定是否自动注册
6. 生成系统登录令牌并返回给前端

### 微信公众号登录流程
1. 用户在微信公众号内点击授权链接
2. 微信重定向到回调地址并携带授权码code
3. 前端将code发送到后端接口/oauth/wx/login/pub/{code}
4. 后端通过code向微信服务器换取用户openid
5. 后续流程与小程序登录类似

通过这种设计，datai-oauth-wx模块为系统提供了完整的微信生态登录解决方案，满足了移动互联网时代的用户认证需求。