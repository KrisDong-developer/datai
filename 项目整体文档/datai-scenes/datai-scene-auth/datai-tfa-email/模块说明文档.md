# datai-tfa-email 模块说明文档

## 模块概述

datai-tfa-email 是 datai-scene-auth 认证场景中的邮箱双因素认证(TFA)模块，提供基于邮箱验证码的用户注册、登录、绑定和解绑功能。该模块通过发送验证码到用户邮箱，实现安全的身份验证流程，增强系统的安全性。

## 核心功能

### 邮箱验证码服务
- 提供邮箱验证码发送功能，支持不同使用场景的验证码管理
- 实现验证码有效期控制，默认有效期为1分钟
- 支持验证码缓存存储和自动失效机制

### 用户注册认证
- 支持基于邮箱的用户注册流程
- 通过邮箱验证码验证用户身份
- 自动创建用户账户并设置基本信息

### 用户登录认证
- 支持基于邮箱验证码的用户登录
- 提供自动注册选项，首次登录时可自动创建账户
- 验证成功后生成系统访问Seesion

### 邮箱绑定与解绑
- 支持已登录用户绑定邮箱地址
- 提供邮箱解绑功能，允许用户解除邮箱关联
- 通过验证码确保操作安全性

## 技术架构

### 依赖组件
- **datai-auth-common**: 提供认证通用功能和接口定义
- **Spring Boot Mail**: 集成邮件发送功能
- **Jakarta Mail**: 提供邮件API支持

### 核心类设计
- **IMailService**: 邮箱服务接口，继承验证码服务和双因素认证服务
- **MailServiceImpl**: 邮箱服务实现类，处理所有邮箱相关业务逻辑
- **EmailUtil**: 邮箱工具类，封装邮件发送功能

### 业务流程
1. **发送验证码**: 生成随机验证码，发送到指定邮箱，并存储到缓存
2. **验证码校验**: 从缓存中获取验证码进行比对，验证成功后清除缓存
3. **用户操作**: 根据验证结果执行注册、登录、绑定或解绑操作

## 安全特性

### 验证码安全
- 验证码有效期限制，防止长期有效带来的安全风险
- 验证码使用后立即失效，避免重复使用
- 验证码缓存隔离，不同场景使用不同缓存键

### 操作安全
- 邮箱唯一性检查，防止重复绑定
- 用户身份验证，确保只能操作自己的账户
- 操作日志记录，便于安全审计

## 应用场景

- **用户注册**: 新用户通过邮箱验证码完成注册
- **安全登录**: 用户通过邮箱验证码进行身份验证登录
- **账户绑定**: 用户绑定邮箱作为备用联系方式
- **账户解绑**: 用户解除邮箱绑定，更换联系方式

## 模块特点

- **轻量级设计**: 专注于邮箱验证功能，代码结构简洁
- **灵活配置**: 支持不同场景的验证码使用策略
- **安全可靠**: 完善的验证机制和安全控制措施
- **易于集成**: 标准化接口设计，便于与其他认证模块集成