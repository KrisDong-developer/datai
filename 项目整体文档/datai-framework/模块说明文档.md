# datai-framework 模块说明文档

## 1. 模块概述

**模块名称**：datai-framework
**模块定位**：核心框架模块，为整个系统提供基础配置、安全认证、数据访问、AOP切面等核心功能支撑
**模块版本**：1.0.0
**主要职责**：
- 提供系统基础配置和初始化，包括Spring Boot应用配置、MyBatis配置、数据源配置等
- 实现基于Spring Security的安全认证和授权机制，包括JWT令牌管理、用户认证、权限控制等
- 提供动态数据源和事务管理功能，支持多数据源配置和切换
- 实现AOP切面编程，包括日志记录、数据权限、数据源切换等横切关注点
- 提供异步任务和线程池管理，支持系统异步操作处理
- 实现系统监控和日志管理，包括服务器信息获取、全局异常处理等
- 提供Web相关功能，包括验证码生成、跨域处理、资源管理等

## 2. 核心功能

| 功能模块 | 功能描述 | 主要实现类/接口 |
|---------|---------|---------------|
| AOP切面 | 实现日志记录、数据权限、数据源切换等切面功能 | LogAspect, DataScopeAspect, DataSourceAspect |
| 配置管理 | 系统配置的加载和管理，包括Spring Boot、MyBatis、数据源、安全等配置 | SecurityConfig, MyBatisConfig, DruidConfig, ApplicationConfig |
| 动态数据源 | 实现动态数据源切换功能，支持多数据源配置和切换 | DynamicDataSource, DynamicDataSourceContextHolder |
| 拦截器 | 提供系统使用的各种拦截器，包括重复提交拦截、同URL数据拦截等 | RepeatSubmitInterceptor, SameUrlDataInterceptor |
| 管理器 | 提供异步任务、数据源等管理功能 | AsyncManager, DataSourceManager, DynamicTransactionManager |
| MyBatis扩展 | MyBatis配置和扩展功能 | MyBatisConfig, CustomDatabaseIdProvider |
| 安全框架 | 实现Spring Security安全认证和授权 | JwtAuthenticationTokenFilter, TokenService, SecurityConfig |
| Web功能 | 提供Web相关功能，如服务器信息、异常处理、验证码等 | GlobalExceptionHandler, ServerConfig, CaptchaConfig |
| 系统监控 | 提供系统监控功能，包括服务器信息获取、系统资源监控等 | Server, Cpu, Jvm, Mem, Sys |
| 权限管理 | 提供权限管理功能，包括用户认证、权限验证、数据权限等 | PermissionService, SysPermissionService, UserDetailsServiceImpl |

## 3. 架构设计

### 3.1 模块结构

```
datai-framework/
└── src/
    └── main/
        └── java/
            └── com/
                └── datai/
                    └── framework/
                        ├── aspectj/           # AOP切面
                        ├── config/            # 配置管理
                        │   └── properties/    # 配置属性
                        ├── datasource/        # 动态数据源
                        ├── interceptor/       # 拦截器
                        │   └── impl/          # 拦截器实现
                        ├── manager/           # 管理器
                        │   └── factory/       # 工厂类
                        ├── mybatis/           # MyBatis扩展
                        ├── security/          # 安全框架
                        │   ├── context/       # 安全上下文
                        │   ├── filter/        # 安全过滤器
                        │   └── handle/        # 安全处理器
                        └── web/               # Web功能
                            ├── domain/        # 领域模型
                            │   └── server/    # 服务器信息
                            ├── exception/     # 异常处理
                            └── service/       # Web服务
```

### 3.2 核心组件

#### 3.2.1 AOP切面

实现了系统中使用的各种AOP切面，如日志记录切面、数据权限切面、数据源切换切面等，用于横切关注点的统一处理。

#### 3.2.2 配置管理

提供了系统的各种配置管理，包括Spring Boot应用配置、MyBatis配置、数据源配置、安全配置等，用于统一管理系统配置。

#### 3.2.3 动态数据源

实现了动态数据源切换功能，支持多数据源配置和切换，便于系统实现读写分离、多数据源等功能。

#### 3.2.4 安全框架

基于Spring Security实现了系统的安全认证和授权机制，包括用户认证、权限控制、JWT令牌管理等，用于保护系统安全。

#### 3.2.5 异步任务管理

提供了异步任务的管理功能，包括异步任务的执行、调度、监控等，用于处理系统中的异步操作。

## 4. 主要组件说明

### 4.1 AOP切面

#### 4.1.1 LogAspect

**功能**：日志记录切面，用于记录系统操作日志
**主要功能**：
- 记录请求的URL、方法、参数、IP地址等信息
- 记录操作的执行时间和结果
- 记录异常信息

#### 4.1.2 DataScopeAspect

**功能**：数据权限切面，用于实现数据权限控制
**主要功能**：
- 根据用户角色和权限过滤数据
- 动态拼接数据权限SQL

#### 4.1.3 DataSourceAspect

**功能**：数据源切换切面，用于实现动态数据源切换
**主要功能**：
- 根据注解或配置切换数据源
- 支持主从数据源、多数据源等场景

### 4.2 配置管理

#### 4.2.1 ApplicationConfig

**功能**：应用配置，用于配置Spring Boot应用
**主要功能**：
- 配置Bean的扫描和注册
- 配置第三方服务集成
- 配置系统初始化

#### 4.2.2 SecurityConfig

**功能**：安全配置，用于配置Spring Security
**主要功能**：
- 配置认证和授权规则
- 配置JWT令牌管理
- 配置CORS和CSRF防护

#### 4.2.3 MyBatisConfig

**功能**：MyBatis配置，用于配置MyBatis框架
**主要功能**：
- 配置Mapper扫描路径
- 配置分页插件
- 配置类型别名和转换器

### 4.3 动态数据源

#### 4.3.1 DynamicDataSource

**功能**：动态数据源，用于实现数据源的动态切换
**主要功能**：
- 管理多个数据源
- 根据上下文切换数据源
- 支持主从数据源、多数据源等场景

### 4.4 安全框架

#### 4.4.1 JwtAuthenticationFilter

**功能**：JWT认证过滤器，用于验证JWT令牌
**主要功能**：
- 从请求头中获取JWT令牌
- 验证JWT令牌的有效性
- 解析JWT令牌获取用户信息
- 将用户信息存入安全上下文

#### 4.4.2 PermissionService

**功能**：权限服务，用于实现权限管理
**主要功能**：
- 获取用户的权限列表
- 验证用户是否有访问权限
- 动态生成菜单和按钮权限

### 4.5 异步任务管理

#### 4.5.1 AsyncManager

**功能**：异步任务管理器，用于管理异步任务
**主要功能**：
- 管理异步任务线程池
- 执行异步任务
- 监控异步任务执行状态

#### 4.5.2 AsyncFactory

**功能**：异步任务工厂，用于创建异步任务
**主要功能**：
- 创建登录日志记录任务
- 创建操作日志记录任务
- 创建其他异步任务

## 5. 使用示例

### 5.1 动态数据源使用示例

```java
// 在Service方法上添加@DataSource注解切换数据源
@Service
public class UserServiceImpl implements IUserService {
    
    @Autowired
    private SysUserMapper userMapper;
    
    // 使用默认数据源
    @Override
    public SysUser selectUserById(Long userId) {
        return userMapper.selectUserById(userId);
    }
    
    // 切换到从数据源
    @Override
    @DataSource(DataSourceType.SLAVE)
    public List<SysUser> selectUserList(SysUser user) {
        return userMapper.selectUserList(user);
    }
}
```

### 5.2 异步任务使用示例

```java
// 使用AsyncManager执行异步任务
AsyncManager.me().execute(AsyncFactory.recordLogininfor(username, Constants.LOGIN_SUCCESS, "登录成功"));

// 使用@Async注解执行异步方法
@Async
public void asyncMethod() {
    // 异步执行的业务逻辑
}
```

### 5.3 数据权限使用示例

```java
// 在Mapper方法上添加@DataScope注解启用数据权限
@DataScope(deptAlias = "d", userAlias = "u")
List<SysUser> selectUserList(SysUser user);

// 在XML中使用数据权限
<select id="selectUserList" parameterType="SysUser" resultMap="SysUserResult">
    select u.*, d.dept_name from sys_user u
    left join sys_dept d on u.dept_id = d.dept_id
    where u.del_flag = '0'
    <if test="userName != null and userName != ''">
        AND u.user_name like concat('%', #{userName}, '%')
    </if>
    <!-- 数据权限过滤 -->
    ${params.dataScope}
    order by u.user_id desc
</select>
```

## 6. 依赖关系

| 依赖模块 | 版本 | 用途 |
|---------|------|------|
| datai-system | 1.0.0 | 系统模块支持，提供用户、角色、权限等基础功能 |
| spring-boot-starter-web | 3.5.7 | Web应用支持，提供RESTful API开发能力 |
| spring-boot-starter-aop | 3.5.7 | AOP支持，提供面向切面编程能力 |
| druid-spring-boot-3-starter | 1.2.27 | Druid数据源支持，提供数据库连接池功能 |
| jta | 1.1 | 分布式事务支持 |
| kaptcha | 2.3.3 | 验证码生成支持 |
| oshi-core | 6.8.3 | 系统信息获取支持，提供服务器监控能力 |

**依赖说明**：
- datai-framework 模块作为核心框架模块，依赖于 datai-system 模块提供的系统基础功能
- 通过 Spring Boot 提供的 starter 依赖，快速集成 Web、AOP 等功能
- 使用 Druid 作为数据库连接池，提供高性能的数据源管理
- 通过 JTA 实现分布式事务支持，保证数据一致性
- 使用 Kaptcha 生成验证码，增强系统安全性
- 通过 Oshi 获取系统信息，实现服务器监控功能

## 7. 部署方式

作为核心框架模块，datai-framework不需要单独部署，而是作为依赖被其他模块引用。

## 8. 维护指南

### 8.1 常见问题及解决方案

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 数据源切换失败 | 数据源配置错误或切换规则不正确 | 检查数据源配置和切换规则 |
| 安全认证失败 | JWT令牌无效或权限配置错误 | 检查JWT令牌和权限配置 |
| 异步任务执行失败 | 线程池配置不合理或任务本身有问题 | 调整线程池配置，检查任务代码 |
| 数据权限不生效 | 数据权限配置错误或SQL语句不正确 | 检查数据权限配置和SQL语句 |

### 8.2 扩展建议

- 当需要添加新的AOP切面时，应将其添加到aspectj包中
- 当需要扩展安全功能时，应在security包中添加相应的实现
- 当需要添加新的配置时，应在config包中添加相应的配置类
- 当需要扩展数据源功能时，应在datasource包中添加相应的实现

## 9. 总结

datai-framework模块是整个系统的核心框架，提供了系统的基础配置、安全认证、数据访问、AOP切面等核心功能。该模块采用分层架构设计，通过AOP切面编程实现了横切关注点的统一处理，通过Spring Security实现了完整的安全认证和授权机制，通过动态数据源实现了多数据源的灵活切换。

**模块特点**：
1. **完整的安全框架**：基于Spring Security实现了JWT令牌认证、权限控制、数据权限等完整的安全功能
2. **灵活的AOP切面**：通过AOP实现了日志记录、数据权限、数据源切换等横切关注点的统一处理
3. **动态数据源支持**：支持多数据源配置和动态切换，便于实现读写分离、多数据源等功能
4. **异步任务管理**：提供异步任务管理器，支持系统异步操作处理，提高系统性能
5. **全局异常处理**：通过全局异常处理器统一处理系统异常，提供友好的错误信息
6. **系统监控能力**：提供服务器信息获取、系统资源监控等功能，支持系统运维管理

**核心价值**：
1. **安全保障**：通过完善的安全认证和授权机制，保障系统安全
2. **开发效率**：通过AOP切面和全局配置，简化开发流程，提高开发效率
3. **系统稳定**：通过异常处理和事务管理，保证系统稳定运行
4. **性能优化**：通过异步任务和动态数据源，提高系统性能
5. **运维支持**：通过系统监控和日志记录，提供系统运维支持

通过合理使用该模块提供的功能，可以快速构建安全、稳定、高性能的企业级应用系统。该模块的设计遵循了高内聚、低耦合的原则，便于维护和扩展，是整个系统架构的核心支撑。