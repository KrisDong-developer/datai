# datai-common 模块说明文档

## 1. 模块概述

**模块名称**：datai-common
**模块定位**：通用工具类库，为整个系统提供基础的工具类、常量、注解、异常处理等通用功能
**模块版本**：1.0.0
**主要职责**：
- 提供系统通用常量和枚举
- 实现自定义注解和过滤器
- 提供核心领域模型和分页支持
- 实现统一的异常处理机制
- 提供各种工具类，如文件处理、HTTP请求、IP处理等
- 提供缓存和数据源服务支持
- 实现XSS防护和安全过滤功能
- 提供Excel导入导出功能支持
- 提供数据序列化和反序列化支持

## 2. 核心功能

| 功能模块 | 功能描述 | 主要实现类/接口 |
|---------|---------|---------------|
| 自定义注解 | 提供系统中使用的各种自定义注解，包括Excel导出、数据权限、日志记录等 | annotation包下的所有注解类 |
| 配置管理 | 提供系统配置的加载和管理，包括文件路径、验证码类型等 | DataIConfig.java |
| 常量定义 | 定义系统中使用的各种常量，包括HTTP状态码、权限标识等 | constant包下的所有常量类 |
| 核心领域模型 | 提供系统核心的领域模型和分页支持，包括基础实体类、响应结果等 | core.domain包下的实体类和分页类 |
| 枚举定义 | 定义系统中使用的各种枚举类型，包括业务状态、操作类型等 | enums包下的所有枚举类 |
| 异常处理 | 实现统一的异常处理机制，包括基础异常、文件异常、用户异常等 | exception包下的所有异常类 |
| 过滤器 | 提供系统使用的各种过滤器，包括XSS过滤、重复提交过滤等 | filter包下的所有过滤器类 |
| 服务支持 | 提供缓存、数据源等服务支持，包括缓存管理、数据源创建等 | service包下的服务类 |
| 工具类 | 提供各种工具类，包括文件处理、HTTP请求、IP处理、Excel处理等 | utils包下的所有工具类 |
| XSS防护 | 提供XSS防护功能，防止跨站脚本攻击 | xss包下的XssValidator.java和Xss.java |
| 序列化支持 | 提供数据序列化和反序列化支持，包括敏感数据脱敏等 | config.serializer包下的序列化类 |

## 3. 架构设计

### 3.1 模块结构

```
datai-common/
└── src/
    └── main/
        └── java/
            └── com/
                └── datai/
                    └── common/
                        ├── annotation/        # 自定义注解
                        ├── config/            # 配置管理
                        │   └── serializer/    # 序列化配置
                        ├── constant/          # 常量定义
                        ├── core/              # 核心功能
                        │   ├── controller/    # 控制器基础类
                        │   ├── domain/        # 领域模型
                        │   │   ├── entity/     # 实体类
                        │   │   └── model/      # 模型类
                        │   ├── page/          # 分页支持
                        │   ├── security/      # 安全相关
                        │   └── text/          # 文本处理
                        ├── enums/             # 枚举定义
                        ├── exception/         # 异常处理
                        │   ├── base/          # 基础异常
                        │   ├── file/          # 文件异常
                        │   ├── job/           # 作业异常
                        │   └── user/          # 用户异常
                        ├── filter/            # 过滤器
                        ├── handler/           # 处理器
                        ├── service/           # 服务支持
                        │   ├── cache/         # 缓存服务
                        │   ├── datasource/    # 数据源服务
                        │   └── mybatis/       # MyBatis服务
                        ├── utils/             # 工具类
                        │   ├── bean/          # Bean处理工具
                        │   ├── file/          # 文件处理工具
                        │   ├── html/          # HTML处理工具
                        │   ├── http/          # HTTP请求工具
                        │   ├── ip/            # IP处理工具
                        │   ├── poi/           # POI处理工具
                        │   ├── reflect/       # 反射工具
                        │   ├── sign/          # 签名工具
                        │   ├── spring/        # Spring工具
                        │   ├── sql/           # SQL工具
                        │   └── uuid/          # UUID工具
                        └── xss/               # XSS防护
```

### 3.2 核心组件

#### 3.2.1 自定义注解

提供了系统中使用的各种自定义注解，如Excel导入导出注解、日志记录注解、数据范围注解等，用于简化开发和实现特定功能。

#### 3.2.2 核心领域模型

包含了系统核心的领域模型，如BaseEntity（基础实体类）、AjaxResult（AJAX响应结果）、PageDomain（分页信息）等，为系统提供了统一的数据模型支持。

#### 3.2.3 异常处理

实现了统一的异常处理机制，定义了各种业务异常类，如BaseException、FileException、UserException等，便于系统进行异常管理和错误处理。

#### 3.2.4 工具类

提供了丰富的工具类，覆盖了系统开发中常用的各种功能，如文件处理、HTTP请求、IP处理、POI处理、反射处理等，简化了开发工作。

## 4. 主要组件说明

### 4.1 核心领域模型

#### 4.1.1 BaseEntity

**功能**：所有实体类的基类，包含了常用的实体字段和方法
**主要字段**：
- searchValue：搜索值
- createBy：创建者
- createTime：创建时间
- updateBy：更新者
- updateTime：更新时间
- remark：备注
- params：请求参数

#### 4.1.2 AjaxResult

**功能**：AJAX响应结果封装，用于统一API响应格式
**主要字段**：
- code：响应状态码
- msg：响应消息
- data：响应数据
**主要方法**：
- success()：返回成功消息
- error()：返回错误消息
- warn()：返回警告消息

#### 4.1.3 PageDomain

**功能**：分页信息封装，用于统一分页请求参数
**主要字段**：
- pageNum：当前记录起始索引
- pageSize：每页显示记录数
- orderByColumn：排序列
- isAsc：排序的方向desc或者asc
- reasonable：分页参数合理化

#### 4.1.4 TableDataInfo

**功能**：表格数据分页响应结果封装
**主要字段**：
- total：总记录数
- rows：当前页数据列表
- code：状态码
- msg：消息

### 4.2 工具类

#### 4.2.1 FileUtils

**功能**：文件处理工具，提供文件上传、下载、删除等功能
**主要方法**：
- writeBytes：输出指定文件的byte数组
- writeImportBytes：写数据到导入文件中
- deleteFile：删除文件
- isValidFilename：文件名称验证
- checkAllowDownload：检查文件是否可下载
- setFileDownloadHeader：下载文件名重新编码
- getFileExtendName：获取图像后缀
- getName：获取文件名称
- extractFilename：编码文件名
- assertAllowed：文件大小校验

#### 4.2.2 HttpUtils

**功能**：HTTP请求工具，提供HTTP GET、POST等请求方法
**主要方法**：
- sendGet：发送GET请求
- sendPost：发送POST请求
- sendPut：发送PUT请求
- sendDelete：发送DELETE请求

#### 4.2.3 IpUtils

**功能**：IP处理工具，提供IP地址解析和归属地查询等功能
**主要方法**：
- getIpAddr：获取客户端IP地址
- getIpInfo：获取IP地址信息
- internalIp：判断是否是内网IP
- isUnknown：判断是否是未知IP

#### 4.2.4 ExcelUtil

**功能**：Excel处理工具，提供Excel导入导出功能
**主要方法**：
- exportExcel：导出Excel文件
- importExcel：导入Excel文件
- exportList：导出列表数据
- importTemplateExcel：导入模板Excel

#### 4.2.5 StringUtils

**功能**：字符串处理工具，提供字符串常用操作方法
**主要方法**：
- nvl：获取参数不为空值
- isEmpty：判断对象是否为空
- isNotEmpty：判断对象是否非空
- format：格式化文本
- toUnderScoreCase：驼峰转下划线命名
- convertToCamelCase：下划线转驼峰命名
- toCamelCase：驼峰式命名法

#### 4.2.6 DateUtils

**功能**：日期处理工具，提供日期常用操作方法
**主要方法**：
- dateTimeNow：获取当前日期时间
- parseDate：日期型字符串转化为指定格式
- dateTime：日期路径 即年/月/日
- getYear：获取年份
- getMonth：获取月份
- getDay：获取天

#### 4.2.7 SecurityUtils

**功能**：安全工具类，提供安全相关操作方法
**主要方法**：
- getAuthentication：获取Authentication
- getUsername：获取用户名
- getUserId：获取用户ID
- isAdmin：判断是否为管理员

#### 4.2.8 SpringUtils

**功能**：Spring工具类，提供Spring相关操作方法
**主要方法**：
- getBean：根据名称获取bean
- getBean：根据类型获取bean
- getApplicationContext：获取applicationContext
- getRequiredProperty：获取配置属性值

### 4.3 异常处理

#### 4.3.1 BaseException

**功能**：基础异常类，所有业务异常的父类
**主要字段**：
- module：所属模块
- code：错误码
- args：错误码对应的参数
- defaultMessage：错误消息

#### 4.3.2 ServiceException

**功能**：服务异常类，用于服务层异常处理
**继承**：BaseException

#### 4.3.3 FileException

**功能**：文件操作异常类，用于文件操作相关异常处理
**继承**：BaseException
**子类**：
- FileNameLengthLimitExceededException：文件名长度超限异常
- FileSizeLimitExceededException：文件大小超限异常
- FileUploadException：文件上传异常
- InvalidExtensionException：无效文件扩展名异常

#### 4.3.4 UserException

**功能**：用户相关异常类，用于用户操作相关异常处理
**继承**：BaseException
**子类**：
- BlackListException：黑名单异常
- CaptchaException：验证码异常
- CaptchaExpireException：验证码过期异常
- IpRetryLimitExceedException：IP重试次数超限异常
- UserNotExistsException：用户不存在异常
- UserPasswordNotMatchException：用户密码不匹配异常
- UserPasswordRetryLimitExceedException：用户密码重试次数超限异常

#### 4.3.5 TaskException

**功能**：任务调度异常类，用于定时任务相关异常处理
**继承**：BaseException

#### 4.3.6 UtilException

**功能**：工具类异常类，用于工具类操作相关异常处理
**继承**：BaseException

#### 4.3.7 GlobalException

**功能**：全局异常类，用于全局异常处理
**继承**：BaseException

#### 4.3.8 DemoModeException

**功能**：演示模式异常类，用于演示模式下的异常处理
**继承**：BaseException

### 4.4 自定义注解

#### 4.4.1 Excel

**功能**：Excel导出注解，用于标记需要导出到Excel的字段
**主要属性**：
- sort：导出时在excel中排序
- name：导出时在excel中的名称
- dateFormat：日期格式
- dictType：字典类型
- readConverterExp：读取内容转表达式
- width：列宽度
- height：行高度
- cellType：导出类型（0数字 1字符串 2图片）
- type：字段类型（0：导出导入；1：仅导出；2：仅导入）
- isExport：是否导出数据
- isStatistics：是否自动统计数据

#### 4.4.2 Log

**功能**：操作日志注解，用于标记需要记录操作日志的方法
**主要属性**：
- title：操作标题
- businessType：业务类型（0其它 1新增 2修改 3删除）
- operatorType：操作人类别（0其它 1后台用户 2手机端用户）
- isSaveRequestData：是否保存请求的参数
- isSaveResponseData：是否保存响应的参数

#### 4.4.3 DataScope

**功能**：数据权限注解，用于标记需要进行数据权限控制的方法
**主要属性**：
- deptAlias：部门别名
- userAlias：用户别名
- permission：权限字符串

#### 4.4.4 DataSource

**功能**：数据源注解，用于标记使用的数据源
**主要属性**：
- value：数据源名称
- type：数据源类型

#### 4.4.5 Anonymous

**功能**：匿名访问注解，用于标记允许匿名访问的方法
**主要属性**：
- value：是否允许匿名访问

#### 4.4.6 RepeatSubmit

**功能**：防重复提交注解，用于标记需要防止重复提交的方法
**主要属性**：
- interval：间隔时间（单位：毫秒）
- message：提示消息

#### 4.4.7 Sensitive

**功能**：敏感数据脱敏注解，用于标记需要进行脱敏处理的字段
**主要属性**：
- type：脱敏类型

### 4.5 过滤器

#### 4.5.1 XssFilter

**功能**：XSS过滤器，用于防止跨站脚本攻击
**主要方法**：
- doFilter：执行过滤逻辑

#### 4.5.2 XssHttpServletRequestWrapper

**功能**：XSS请求包装器，用于包装HttpServletRequest请求
**主要方法**：
- getParameter：获取参数并过滤XSS
- getParameterValues：获取参数数组并过滤XSS
- getHeader：获取请求头并过滤XSS

#### 4.5.3 RepeatableFilter

**功能**：可重复读取过滤器，用于支持重复读取请求流
**主要方法**：
- doFilter：执行过滤逻辑

#### 4.5.4 RepeatedlyRequestWrapper

**功能**：可重复读取请求包装器，用于包装HttpServletRequest请求
**主要方法**：
- getInputStream：获取输入流
- getReader：获取读取器

#### 4.5.5 PropertyPreExcludeFilter

**功能**：属性预排除过滤器，用于排除不需要序列化的属性
**主要方法**：
- filterOutProperty：过滤属性

#### 4.5.6 RefererFilter

**功能**：Referer过滤器，用于检查Referer头
**主要方法**：
- doFilter：执行过滤逻辑

### 4.6 服务支持

#### 4.6.1 缓存服务

**功能**：提供缓存相关服务支持
**主要实现类**：
- CacheKeys：缓存键定义
- CacheNoTimeOut：无超时缓存
- CacheTimeOut：有超时缓存

#### 4.6.2 数据源服务

**功能**：提供数据源相关服务支持
**主要实现类**：
- CreateDataSource：创建数据源
- AfterCreateDataSource：数据源创建后处理

#### 4.6.3 MyBatis服务

**功能**：提供MyBatis相关服务支持
**主要实现类**：
- CreateSqlSessionFactory：创建SqlSessionFactory

#### 4.6.4 处理器

**功能**：提供各种处理器支持
**主要实现类**：
- GenericListTypeHandler：通用列表类型处理器

### 4.7 常量和枚举

#### 4.7.1 Constants

**功能**：系统常量定义
**主要常量**：
- UTF8/GBK：字符集
- DEFAULT_LOCALE：系统语言
- HTTP/HTTPS：HTTP请求
- SUCCESS/FAIL：通用成功/失败标识
- LOGIN_SUCCESS/LOGIN_FAIL：登录成功/失败
- ALL_PERMISSION：所有权限标识
- SUPER_ADMIN：管理员角色权限标识
- ROLE_DELIMETER：角色权限分隔符
- PERMISSION_DELIMETER：权限标识分隔符
- CAPTCHA_EXPIRATION：验证码有效期
- TOKEN/TOKEN_PREFIX：令牌/令牌前缀
- LOGIN_USER_KEY：登录用户键
- JWT_USERID/JWT_USERNAME/JWT_AVATAR：JWT用户相关
- RESOURCE_PREFIX：资源映射路径前缀
- LOOKUP_RMI/LOOKUP_LDAP/LOOKUP_LDAPS：远程方法调用
- JSON_WHITELIST_STR：自动识别json对象白名单配置
- JOB_WHITELIST_STR：定时任务白名单配置
- JOB_ERROR_STR：定时任务违规的字符

#### 4.7.2 HttpStatus

**功能**：HTTP状态码定义
**主要状态码**：
- SUCCESS：操作成功
- ERROR：操作失败
- UNAUTHORIZED：未授权
- FORBIDDEN：禁止访问
- NOT_FOUND：未找到
- METHOD_NOT_ALLOWED：方法不允许
- INTERNAL_SERVER_ERROR：内部服务器错误

#### 4.7.3 CacheConstants

**功能**：缓存常量定义
**主要常量**：
- LOGIN_TOKEN_KEY：登录用户token键
- SYS_DICT_KEY：字典缓存键
- SYS_CONFIG_KEY：参数配置缓存键

#### 4.7.4 UserConstants

**功能**：用户常量定义
**主要常量**：
- NORMAL：正常状态
- EXCEPTION：异常状态
- SYS_USER：系统用户
- NORMAL：正常状态

#### 4.7.5 ScheduleConstants

**功能**：定时任务常量定义
**主要常量**：
- TASK_CLASSNAME：任务类名
- CRON_EXPRESSION：Cron表达式
- MISFIRE_POLICY：错失执行策略

#### 4.7.6 BusinessStatus

**功能**：业务状态枚举
**主要枚举值**：
- SUCCESS：操作成功
- FAIL：操作失败

#### 4.7.7 BusinessType

**功能**：业务类型枚举
**主要枚举值**：
- OTHER：其它
- INSERT：新增
- UPDATE：修改
- DELETE：删除
- GRANT：授权
- EXPORT：导出
- IMPORT：导入
- FORCE：强退
- GENCODE：生成代码
- CLEAN：清空数据

#### 4.7.8 OperatorType

**功能**：操作人类别枚举
**主要枚举值**：
- OTHER：其它
- MANAGE：后台用户
- MOBILE：手机端用户

#### 4.7.9 DataSourceType

**功能**：数据源类型枚举
**主要枚举值**：
- MASTER：主库
- SLAVE：从库

#### 4.7.10 UserStatus

**功能**：用户状态枚举
**主要枚举值**：
- OK：正常
- DISABLE：停用
- DELETED：删除

#### 4.7.11 LimitType

**功能**：限流类型枚举
**主要枚举值**：
- DEFAULT：默认策略全局限流
- IP：根据请求者IP进行限流
- CUSTOMER：自定义限流

#### 4.7.12 HttpMethod

**功能**：HTTP请求方法枚举
**主要枚举值**：
- GET：GET请求
- POST：POST请求
- PUT：PUT请求
- DELETE：DELETE请求

#### 4.7.13 MessageType

**功能**：消息类型枚举
**主要枚举值**：
- SYSTEM：系统消息
- NOTICE：通知消息
- PRIVATE：私信

#### 4.7.14 DesensitizedType

**功能**：脱敏类型枚举
**主要枚举值**：
- USER_ID：用户ID
- CHINESE_NAME：中文名
- ID_CARD：身份证号
- FIXED_PHONE：固定电话
- MOBILE_PHONE：手机号
- ADDRESS：地址
- EMAIL：电子邮件
- PASSWORD：密码
- CAR_LICENSE：车牌号
- BANK_CARD：银行卡号

## 5. 使用示例

### 5.1 AjaxResult使用示例

```java
// 成功响应
return AjaxResult.success();

// 带数据的成功响应
return AjaxResult.success(data);

// 错误响应
return AjaxResult.error();

// 带消息的错误响应
return AjaxResult.error("操作失败");

// 带状态码和消息的错误响应
return AjaxResult.error(HttpStatus.INTERNAL_SERVER_ERROR, "内部服务器错误");
```

### 5.2 分页使用示例

```java
// 获取分页参数
PageDomain pageDomain = TableSupport.buildPageRequest();
Integer pageNum = pageDomain.getPageNum();
Integer pageSize = pageDomain.getPageSize();
String orderBy = pageDomain.getOrderBy();

// 执行分页查询
PageHelper.startPage(pageNum, pageSize, orderBy);
List<User> userList = userMapper.selectUserList(user);
TableDataInfo dataTable = TableSupport.buildDataTable(new PageInfo<User>(userList));
return dataTable;
```

### 5.3 文件上传示例

```java
// 获取上传文件
MultipartFile file = request.getFile("file");

// 上传文件
String filePath = FileUtils.uploadFile(file, uploadPath);

// 返回文件路径
return filePath;
```

## 6. 依赖关系

| 依赖模块 | 版本 | 用途 |
|---------|------|------|
| spring-boot-starter-web | - | Web应用支持 |
| spring-boot-starter-security | - | 安全认证支持 |
| pagehelper-spring-boot-starter | - | 分页插件支持 |
| spring-boot-starter-validation | - | 自定义验证注解支持 |
| commons-lang3 | - | 常用工具类支持 |
| jackson-datatype-jsr310 | - | Java8时间序列化支持 |
| fastjson2 | - | JSON解析支持 |
| commons-io | - | IO操作支持 |
| poi-ooxml | - | Excel处理支持 |
| jjwt-api/jjwt-impl/jjwt-jackson | - | Token生成与解析支持 |
| jakarta.xml.bind-api/jaxb-core | - | XML绑定支持 |
| commons-pool2 | - | 对象池支持 |
| httpclient5 | - | HTTP请求支持 |
| UserAgentUtils | - | 客户端操作系统、浏览器解析支持 |
| mybatis-spring-boot-starter | - | MyBatis集成支持 |
| springdoc-openapi-starter-webmvc-ui | - | API文档支持 |
| lombok | - | 代码简化支持 |
| spring-boot-starter-cache | - | 缓存支持 |
| cache-api | - | 缓存API支持 |
| hutool-core/hutool-http | - | 工具类支持 |
| mybatis-plus-annotation | 3.5.8 | MyBatis Plus注解支持 |

## 7. 部署方式

作为通用工具类库，datai-common模块不需要单独部署，而是作为依赖被其他模块引用。

## 8. 维护指南

### 8.1 常见问题及解决方案

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| 工具类方法调用失败 | 参数错误或方法使用不当 | 检查参数是否正确，参考使用示例 |
| 异常处理不生效 | 异常类型不匹配或异常处理配置错误 | 检查异常类型是否正确，确保异常处理配置正确 |
| 分页查询失败 | 分页参数错误或PageHelper配置错误 | 检查分页参数是否正确，确保PageHelper配置正确 |

### 8.2 扩展建议

- 当需要添加新的工具类时，应根据功能分类将其添加到对应的工具包中
- 当需要添加新的异常类型时，应继承BaseException或其子类
- 当需要添加新的注解时，应根据功能将其添加到annotation包中

## 9. 总结

datai-common模块是整个系统的基础，提供了各种通用功能和工具类，为其他模块的开发提供了支持。该模块的设计遵循了高内聚、低耦合的原则，便于维护和扩展。

### 9.1 模块特点

1. **全面性**：涵盖了系统开发中常用的各种功能，包括基础工具类、异常处理、数据模型、安全防护等
2. **可扩展性**：通过继承和组合的方式，方便进行功能扩展
3. **安全性**：提供了XSS防护、数据脱敏、权限控制等安全功能
4. **易用性**：提供了丰富的工具类和注解，简化了开发工作
5. **一致性**：统一了异常处理、响应格式、分页等常用功能

### 9.2 核心价值

1. **提高开发效率**：通过提供通用工具类和组件，减少重复开发工作
2. **保证代码质量**：统一了编码规范和实现方式，提高了代码质量
3. **降低维护成本**：集中管理通用功能，降低了维护成本
4. **增强系统稳定性**：经过充分测试的通用组件，提高了系统稳定性

### 9.3 使用建议

1. **合理使用工具类**：根据实际需求选择合适的工具类，避免过度使用
2. **遵循命名规范**：在使用常量和枚举时，遵循已有的命名规范
3. **正确处理异常**：使用统一的异常处理机制，确保异常信息的一致性
4. **注意安全性**：在使用安全相关功能时，确保正确配置和使用

通过合理使用该模块提供的功能，可以提高开发效率，减少重复代码，保证系统的一致性和可维护性。